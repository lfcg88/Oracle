USE [MIDB84D]
GO
/****** Object:  StoredProcedure [scpd].[SP_CPD_ALTER_SOLIC_CADERN]    Script Date: 06/29/2010 16:19:19 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [scpd].[SP_CPD_ALTER_SOLIC_CADERN]
	@NR_PROTC [numeric](16, 0),
	@NR_CADERN [char](8),
	@CD_USUAR_LOGADO [int],
	@CD_ESTAC [int]
WITH EXECUTE AS CALLER
AS
UPDATE CPD_SOLIC
SET NR_CADERN = @NR_CADERN
WHERE NR_PROTC = @NR_PROTC

update
	CPD_CADERN
SET
	CD_USUAR = @CD_USUAR_LOGADO,
	CD_ESTAC = @CD_ESTAC,
	CD_CADERN_STATUS = 30 --EM USO
WHERE
	NR_CADERN = @NR_CADERN
GO
/****** Object:  StoredProcedure [scpd].[SP_CPD_VALID_CADERN_LIBER]    Script Date: 06/29/2010 16:19:23 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [scpd].[SP_CPD_VALID_CADERN_LIBER]
	@NR_CADERN [char](8)
WITH EXECUTE AS CALLER
AS
SELECT COUNT(NR_CADERN)
FROM CPD_CADERN
WHERE NR_CADERN = @NR_CADERN AND
	  DT_LIBER IS NOT NULL
GO
/****** Object:  StoredProcedure [scpd].[SP_CPD_EMBALA_CADERN]    Script Date: 06/29/2010 16:19:20 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [scpd].[SP_CPD_EMBALA_CADERN]
	@CD_LOTES [varchar](2000),
	@CD_EMBALA [decimal](12, 0)
WITH EXECUTE AS CALLER
AS
exec('Update CPD_LOTE_SOLIC_USUAR
		set dt_embala = getdate()
      Where cd_lote IN (' + @CD_LOTES + ')')


exec('Update CPD_CADERN
	    set cd_embala = ' + @cd_embala +
    ' From CPD_SOLIC solic
		  Inner Join CPD_CADERN cadern
			  on solic.nr_cadern  = cadern.nr_cadern AND
				  cadern.cd_embala is null AND
				  solic.CD_LOTE IN (' + @CD_LOTES + ')')
GO
/****** Object:  StoredProcedure [scpd].[SP_CPD_INS_EMBALA_NF]    Script Date: 06/29/2010 16:19:20 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [scpd].[SP_CPD_INS_EMBALA_NF]
	@CD_NF [int],
	@ColecaoEmbalagens [text]
WITH EXECUTE AS CALLER
AS
exec('Update  CPD_EMBALA 
	    Set CD_NF =  ' + @CD_NF + '
	  where 
        CD_EMBALA in (' + @ColecaoEmbalagens + ')')


exec('DECLARE @PesoCaderneta decimal(18,2)
	set @PesoCaderneta = (Select cast( VL_PARAM as decimal(18,2) )
                          From CPD_PARAM
                          Where cd_param = 8)

	 DECLARE @TotalCadernEmbala int
	 set @TotalCadernEmbala = (select count(1)
			                   from cpd_cadern where
			                   CD_EMBALA in (' + @ColecaoEmbalagens + '))
 
SELECT
	(@PesoCaderneta * @TotalCadernEmbala) + (select sum(NR_PESO)
								             FROM
												CPD_TP_EMBALA INNER JOIN CPD_EMBALA ON CPD_EMBALA.CD_TP_EMBALA = CPD_TP_EMBALA.CD_TP_EMBALA
											 WHERE CD_EMBALA IN (' + @ColecaoEmbalagens + ')) AS PesoEmbalagem,
	(SELECT COUNT(CD_EMBALA) FROM CPD_EMBALA WHERE CD_EMBALA IN (' + @ColecaoEmbalagens + ')) AS VolumeEmbalagem,
	@TotalCadernEmbala as TotalCaderneta,
	CPD_UNID_ENTRG.CD_UNID, CPD_UNID_ENTRG.DS_UNID, CPD_MUN.SG_UF
FROM
	CPD_UNID_ENTRG INNER JOIN
	CPD_SOLIC ON CPD_UNID_ENTRG.CD_UNID = CPD_SOLIC.CD_UNID
	INNER JOIN CPD_CADERN ON CPD_CADERN.NR_CADERN = CPD_SOLIC.NR_CADERN
	INNER JOIN CPD_MUN ON CPD_MUN.CD_MUN = CPD_UNID_ENTRG.CD_MUN
	WHERE CPD_CADERN.CD_EMBALA IN (' + @ColecaoEmbalagens + ')'

)
GO
/****** Object:  StoredProcedure [scpd].[SP_CPD_LISTA_INFORM_EMBALA]    Script Date: 06/29/2010 16:19:21 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [scpd].[SP_CPD_LISTA_INFORM_EMBALA]
	@NR_AR [varchar](30) = '',
	@NR_CADERN [char](8) = '',
	@CD_LOTE [numeric](12, 0) = 0,
	@DT_EMBALA [datetime] = NULL
WITH EXECUTE AS CALLER
AS
DECLARE @WHERE AS VARCHAR(1000) 

SET @WHERE = ' WHERE 1=1 '

IF (@NR_AR <> '')
	SET	@WHERE = @WHERE + '	AND	(EMB.NR_AR = '''+@NR_AR+''' OR HIST.NR_AR_ANTIGO = ''' + @NR_AR + ''')'

IF (@NR_CADERN <> '')
	SET	@WHERE = @WHERE + '	AND	(CAD.NR_CADERN = '''+@NR_CADERN+''')'

IF (@CD_LOTE <> 0)
	SET	@WHERE = @WHERE + '	AND	(LOT.CD_LOTE	= ' + CAST( @CD_LOTE AS varchar(12)) + ')'

IF NOT @DT_EMBALA IS NULL
	SET	@WHERE = @WHERE + '	AND CONVERT(VARCHAR(8),LOT.DT_EMBALA,112) = ' + CONVERT(VARCHAR(8), @DT_EMBALA,112)

DECLARE @SELECT AS VARCHAR(1000)

SET @SELECT = 'SELECT DISTINCT EMB.NR_AR, EMB.CD_EMBALA,
			                   (SELECT TOP 1 CPD_EMBALA_HIST_STATUS.NR_AR_ANTIGO 
                                FROM CPD_EMBALA_HIST_STATUS 
                                WHERE CPD_EMBALA_HIST_STATUS.NR_AR_NOVO = EMB.NR_AR AND 
                                CPD_EMBALA_HIST_STATUS.NR_AR_ANTIGO IS NOT NULL
                               ) AS NR_AR_ANTIGO,
							   CONVERT(VARCHAR(10), LOT.DT_EMBALA, 103) AS DT_EMBALA
				FROM CPD_EMBALA EMB
				      INNER JOIN CPD_CADERN CAD				ON EMB.CD_EMBALA = CAD.CD_EMBALA
				      INNER JOIN CPD_SOLIC SOL				ON CAD.NR_CADERN = SOL.NR_CADERN
				      INNER JOIN CPD_LOTE_SOLIC_USUAR LOT	ON SOL.CD_LOTE   = LOT.CD_LOTE
				      LEFT JOIN CPD_EMBALA_HIST_STATUS HIST ON EMB.CD_EMBALA = HIST.CD_EMBALA '

EXEC (@SELECT + @WHERE)
GO
/****** Object:  StoredProcedure [scpd].[SP_CPD_ALTER_SOLIC]    Script Date: 06/29/2010 16:19:19 ******/
SET ANSI_NULLS OFF
GO
SET QUOTED_IDENTIFIER OFF
GO
CREATE PROCEDURE [scpd].[SP_CPD_ALTER_SOLIC]
	@CD_PAUTA [int]
WITH EXECUTE AS CALLER
AS
UPDATE CPD_SOLIC
SET CD_PAUTA = NULL
WHERE CD_PAUTA = @CD_PAUTA
GO
/****** Object:  StoredProcedure [scpd].[SP_CPD_LISTA_LOTE_VINCL]    Script Date: 06/29/2010 16:19:22 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [scpd].[SP_CPD_LISTA_LOTE_VINCL]
	@Lotes [text]
WITH EXECUTE AS CALLER
AS
exec(' 
SELECT
	count(1)
FROM
	CPD_LOTE_SOLIC_USUAR
WHERE
	CD_USUAR IS NOT NULL
	AND CD_LOTE IN (' + @Lotes + ')')
GO
/****** Object:  StoredProcedure [scpd].[SP_CPD_ALTER_SOLIC_STATUS_LOTE_USUAR]    Script Date: 06/29/2010 16:19:19 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [scpd].[SP_CPD_ALTER_SOLIC_STATUS_LOTE_USUAR]
	@CD_USUAR [int],
	@CD_LOTES [text],
	@CD_STATUS_SOLIC [smallint],
	@CD_USUAR_LOGADO [int],
	@CD_ESTAC [int]
WITH EXECUTE AS CALLER
AS
EXEC ('UPDATE CPD_LOTE_SOLIC_USUAR
	  SET CD_USUAR = ' + @CD_USUAR + ',
		  CD_USUAR_VINCUL = ' + @CD_USUAR_LOGADO + ',
		  CD_ESTAC_VINCUL = ' + @CD_ESTAC + '
      WHERE CD_LOTE in (' + @CD_LOTES + ')')

EXEC ('UPDATE CPD_SOLIC 
	  SET CD_STATUS_SOLIC = ' + @CD_STATUS_SOLIC + ' ,
		  CD_ESTAC = ' + @CD_ESTAC + ' ,
		  CD_USUAR = ' + @CD_USUAR_LOGADO + '
	  WHERE CD_LOTE in (' + @CD_LOTES + ')
	  AND CD_STATUS_SOLIC = 10')

DECLARE @LinhasAfetadas int

SET @LinhasAfetadas = @@ROWCOUNT

EXEC ( 'SELECT NR_PROTC 
        FROM CPD_SOLIC 
        WHERE CD_LOTE in (' + @CD_LOTES + ') AND CD_STATUS_SOLIC = ' + @CD_STATUS_SOLIC + ' ORDER BY CD_LOTE, NR_PROTC')

EXEC ( 'SELECT TOP ' +  @LinhasAfetadas + ' NR_CADERN 
	    FROM CPD_CADERN WITH (XLOCK, ROWLOCK)
        WHERE CD_CADERN_STATUS = 40 
		ORDER BY SQ_CADERN')
GO
/****** Object:  StoredProcedure [scpd].[SP_CPD_ALTER_STATUS_SOLIC]    Script Date: 06/29/2010 16:19:19 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [scpd].[SP_CPD_ALTER_STATUS_SOLIC]
	@NR_PROTC [numeric](16, 0),
	@CD_STATUS_SOLIC [smallint],
	@CD_USUAR_LOGADO [int],
	@CD_ESTAC [int]
WITH EXECUTE AS CALLER
AS
UPDATE CPD_SOLIC 
	  SET CD_STATUS_SOLIC = @CD_STATUS_SOLIC,
		  CD_ESTAC =  @CD_ESTAC,  
		  CD_USUAR = @CD_USUAR_LOGADO
	  WHERE NR_PROTC = @NR_PROTC
GO
/****** Object:  StoredProcedure [scpd].[SP_CPD_LISTA_LOTE_USUAR]    Script Date: 06/29/2010 16:19:22 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [scpd].[SP_CPD_LISTA_LOTE_USUAR]
	@CD_USUAR [int],
	@Lotes [varchar](8000) = ''
WITH EXECUTE AS CALLER
AS
if not @Lotes = ''
	set @Lotes = 'AND CD_LOTE IN (' + @Lotes +  ')'

exec ('
SELECT
	CD_LOTE,
		(SELECT
			COUNT(1)
		FROM
			CPD_SOLIC
		WHERE
			CD_LOTE = CPD_LOTE_SOLIC_USUAR.CD_LOTE) AS
	QD_LOTE,
	DT_MAX_SAIDA,
	TP_NATURZ_ENTRG
FROM
	CPD_LOTE_SOLIC_USUAR
WHERE
	CD_USUAR = ' + @CD_USUAR + '
AND	DT_FIM_LOTE IS NULL ' + 
@Lotes  +
'ORDER BY DT_MAX_SAIDA')
GO
/****** Object:  StoredProcedure [scpd].[SP_CPD_QT_SOLIC_LOTE]    Script Date: 06/29/2010 16:19:22 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [scpd].[SP_CPD_QT_SOLIC_LOTE]
	@flag_lotes [varchar](2000)
WITH EXECUTE AS CALLER
AS
EXEC('SELECT COUNT(NR_PROTC)
	  FROM CPD_SOLIC
	  WHERE CD_LOTE IN (' + @flag_lotes + ')')
GO
/****** Object:  StoredProcedure [scpd].[SP_CPD_LISTA_LOTE_EMBALA]    Script Date: 06/29/2010 16:19:21 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [scpd].[SP_CPD_LISTA_LOTE_EMBALA]
	@flag_lotes [varchar](2000)
WITH EXECUTE AS CALLER
AS
EXEC('Select cd_lote ' +  
    ' From CPD_LOTE_SOLIC_USUAR ' +
    ' where dt_embala is not null ' +
    ' and cd_lote in ( ' + @flag_lotes + ')')
GO
/****** Object:  StoredProcedure [scpd].[SP_CPD_VALID_PROTC]    Script Date: 06/29/2010 16:19:23 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [scpd].[SP_CPD_VALID_PROTC]
	@NR_PROTC [varchar](100)
WITH EXECUTE AS CALLER
AS
SELECT ISNULL(COUNT(NR_PROTC), 0) AS NR_PROTC
FROM CPD_SOLIC
WHERE NR_PROTC = @NR_PROTC
GO
/****** Object:  StoredProcedure [scpd].[SP_CPD_EMBALA_COFRE]    Script Date: 06/29/2010 16:19:20 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [scpd].[SP_CPD_EMBALA_COFRE]
	@NR_AR [varchar](15) = null,
	@CD_EMBALS [text] = null
WITH EXECUTE AS CALLER
AS
IF NOT @NR_AR IS NULL
EXEC('
UPDATE
	CPD_EMBALA
SET
	DT_ARMAZ_COFRE = GETDATE()
WHERE
	NR_AR = ' +  @NR_AR + ' AND
	DT_ARMAZ_COFRE is null')
ELSE
EXEC('
UPDATE
	CPD_EMBALA
SET
	DT_ARMAZ_COFRE = GETDATE()
WHERE
	CD_EMBALA IN (' +  @CD_EMBALS + ') AND
	DT_ARMAZ_COFRE is null')
GO
/****** Object:  StoredProcedure [scpd].[SP_CPD_LISTA_INFO_AR]    Script Date: 06/29/2010 16:19:21 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [scpd].[SP_CPD_LISTA_INFO_AR]
	@OPT [int] = 0
WITH EXECUTE AS CALLER
AS
DECLARE @SELECT AS VARCHAR(300)

SET @SELECT = ' SELECT '
IF (@OPT = 1)
	SET @SELECT = @SELECT + ' MAX(NR_INICIO_SEQ_AR) '
IF (@OPT = 2)
	SET @SELECT = @SELECT + ' MAX(NR_FIM_SEQ_AR) '

	SET @SELECT = @SELECT + ' AS MAIOR FROM CPD_AR '

EXEC (@SELECT)
GO
/****** Object:  StoredProcedure [scpd].[SP_CPD_REL_CADERN_LOTE]    Script Date: 06/29/2010 16:19:22 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [scpd].[SP_CPD_REL_CADERN_LOTE]
	@LOTES [text]
WITH EXECUTE AS CALLER
AS
EXEC('
SELECT
	CONVERT(nvarchar, CPD_LOTE_SOLIC_USUAR.CD_LOTE) as CD_LOTE,
	CPD_LOTE_SOLIC_USUAR.DT_MAX_SAIDA,
	CPD_LOTE_SOLIC_USUAR.TP_NATURZ_ENTRG,
	CPD_USUAR.NM_USUAR,
	CPD_UNID_ENTRG.DS_UNID,
	CPD_SOLIC.NR_PROTC,
	CPD_SOLIC.NR_CADERN,
	(SELECT COUNT(1) FROM CPD_SOLIC WHERE CD_LOTE = CPD_LOTE_SOLIC_USUAR.CD_LOTE) AS QTD,
	CPD_STATUS_SOLIC.DS_STATUS_SOLIC,
	UNID_ATEND.DS_UNID DS_UNID_ATEND
FROM
	CPD_LOTE_SOLIC_USUAR
		INNER JOIN CPD_SOLIC ON CPD_LOTE_SOLIC_USUAR.CD_LOTE = CPD_SOLIC.CD_LOTE
		INNER JOIN CPD_STATUS_SOLIC ON CPD_SOLIC.CD_STATUS_SOLIC = CPD_STATUS_SOLIC.CD_STATUS_SOLIC
		INNER JOIN CPD_USUAR ON CPD_LOTE_SOLIC_USUAR.CD_USUAR = CPD_USUAR.CD_USUAR
		INNER JOIN CPD_UNID_ENTRG ON CPD_UNID_ENTRG.CD_UNID = CPD_LOTE_SOLIC_USUAR.CD_LOCAL_EXP
		INNER JOIN CPD_UNID_ENTRG UNID_ATEND ON UNID_ATEND.CD_UNID = CPD_LOTE_SOLIC_USUAR.CD_LOCAL_ATEND
WHERE
	CPD_LOTE_SOLIC_USUAR.CD_LOTE IN (' + @LOTES + ')
ORDER BY CPD_LOTE_SOLIC_USUAR.DT_MAX_SAIDA, CPD_LOTE_SOLIC_USUAR.CD_LOTE, CPD_SOLIC.NR_PROTC
')
GO
/****** Object:  StoredProcedure [scpd].[SP_CPD_VALID_EXPEDC_PROTC_EXTRAO]    Script Date: 06/29/2010 16:19:23 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [scpd].[SP_CPD_VALID_EXPEDC_PROTC_EXTRAO]
	@CD_PAUTA [int],
	@NR_PROTC [text]
WITH EXECUTE AS CALLER
AS
--VERIFICA SE EXISTE ALGUM PROTOCOLO NA MESMA PAUTA QUE NÃO 
--ESTEJA NA LISTA DE PROTOCOLOS SELECIONADOS PELO USUÁRIO
EXEC ('SELECT SOLIC.NR_PROTC
	   FROM CPD_SOLIC SOLIC 
       WHERE SOLIC.CD_PAUTA = ' + @CD_PAUTA + 
             ' AND NOT SOLIC.NR_PROTC IN( ' + @NR_PROTC + ' )'
      )

--VERIFICA SE EXISTE ALGUM PROTOCOLO EM OUTRA PAUTA QUE  
--ESTEJA NA LISTA DE PROTOCOLOS SELECIONADOS PELO USUÁRIO
EXEC ('SELECT SOLIC.NR_PROTC
	   FROM CPD_SOLIC SOLIC 
       WHERE NOT SOLIC.CD_PAUTA = ' + @CD_PAUTA + 
             ' AND SOLIC.NR_PROTC IN( ' + @NR_PROTC + ' )'
      )

--VERIFICA SE EXISTE ALGUM PROTOCOLO EM LOTE AINDA NÃO FINALIZADO
--EXEC ('SELECT SOLIC.NR_PROTC
--	   FROM CPD_SOLIC SOLIC 
--			INNER JOIN CPD_LOTE_SOLIC_USUAR LOTE ON LOTE.CD_LOTE = SOLIC.CD_LOTE
--      WHERE LOTE.DT_FIM_LOTE IS NULL AND 
--			 SOLIC.NR_PROTC IN( ' + @NR_PROTC + ' )'
--	 )

--VERIFICA SE EXISTE ALGUM PROTOCOLO NA LISTA QUE NÃO ESTEJA
--NO STATUS PRONTO PRA EMBALAR
EXEC ('SELECT SOLIC.NR_PROTC
	   FROM CPD_SOLIC SOLIC 
       WHERE NOT SOLIC.CD_STATUS_SOLIC = 40 
       AND SOLIC.NR_PROTC IN( ' + @NR_PROTC + ' )'
     
)
GO
/****** Object:  StoredProcedure [scpd].[SP_CPD_LISTA_PROTC]    Script Date: 06/29/2010 16:19:22 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [scpd].[SP_CPD_LISTA_PROTC]
	@CD_PAUTA [int]
WITH EXECUTE AS CALLER
AS
SELECT	NR_PROTC,
		NR_CADERN,
		TX_NOME +' '+TX_SOBREN AS NOME
FROM	CPD_SOLIC
WHERE	CD_PAUTA = @CD_PAUTA
AND TP_NATURZ_ENTRG = 'E'
GO
/****** Object:  StoredProcedure [scpd].[SP_CPD_REL_CADERN_INUTIL]    Script Date: 06/29/2010 16:19:22 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [scpd].[SP_CPD_REL_CADERN_INUTIL]
	@cd_status_cadern [int],
	@nr_cadern [char](8) = '',
	@nr_protc [numeric](16, 0) = 0,
	@cd_usuar [int] = 0,
	@dt_altera_de [datetime] = NULL,
	@dt_altera_ate [datetime] = NULL,
	@nr_ar [varchar](30) = '',
	@tx_op [varchar](40) = ''
WITH EXECUTE AS CALLER
AS
DECLARE @select varchar(2500)
DECLARE @from varchar(2500)
DECLARE @where varchar(3000)
DECLARE @order varchar(500)

SET @select = 'SELECT DISTINCT HIST_CADERN.dt_altera,
							   CADERNETA.nr_cadern,
							   HIST_PROTC.nr_protc,
							   EMBALAGEM.nr_ar,
							   USUARIO.nm_usuar,
							   CADERNETA.sq_cadern '
SET @from =	' FROM cpd_cadern_hist_status HIST_CADERN
				 	 INNER JOIN cpd_cadern CADERNETA ON HIST_CADERN.NR_CADERN = CADERNETA.NR_CADERN
					 INNER JOIN cpd_usuar USUARIO ON HIST_CADERN.cd_usuar = USUARIO.cd_usuar
					 LEFT JOIN cpd_embala EMBALAGEM ON CADERNETA.cd_embala = EMBALAGEM.cd_embala
					 LEFT JOIN cpd_solic_hist_status HIST_PROTC ON CADERNETA.nr_cadern  = HIST_PROTC.nr_cadern '

if @cd_status_cadern = 10 --PERDIDA
BEGIN
	SET @select = @select + ', PERDA.ds_motivo_perda '
	SET @from = @from + ' INNER JOIN cpd_motivo_perda PERDA ON PERDA.cd_motivo_perda = HIST_CADERN.cd_motivo_perda '
	SET @order = ' ORDER BY PERDA.ds_motivo_perda, CADERNETA.sq_cadern '
END
ELSE
BEGIN
	if @cd_status_cadern = 20 --DEVOLVIDA
	BEGIN
		SET @select = @select + ', DEVOLUCAO.ds_motivo_devol '
		SET @from = @from + ' INNER JOIN cpd_motivo_devol DEVOLUCAO ON DEVOLUCAO.cd_motivo_devol = HIST_CADERN.cd_motivo_devol '
		SET @order = ' ORDER BY DEVOLUCAO.ds_motivo_devol, CADERNETA.sq_cadern '
	END
	ELSE
	BEGIN
		SET @order = ' ORDER BY CADERNETA.sq_cadern '
	END
END

SET @where = ' WHERE HIST_CADERN.CD_CADERN_STATUS = ' + convert(varchar(16),@cd_status_cadern)

if not @nr_cadern = ''
	SET @where = @where + ' AND CADERNETA.nr_cadern = ''' + @nr_cadern + ''' ' 

if not @nr_protc = 0
	SET @where = @where + ' AND HIST_PROTC.nr_protc = ' + convert(varchar(16),@nr_protc)

if not @cd_usuar = 0
	SET @where = @where + ' AND USUARIO.cd_usuar = ' + convert(varchar(16),@cd_usuar)
	
if not @dt_altera_de is null
	SET @where = @where + ' AND convert(varchar(8),HIST_CADERN.dt_altera,112) >= ' + convert(varchar(8), @dt_altera_de,112)
	
if not @dt_altera_ate is null
	SET @where = @where + ' AND convert(varchar(8),HIST_CADERN.dt_altera,112) <= ' + convert(varchar(8), @dt_altera_ate,112)
	
if not @nr_ar = '' 
	SET @where = @where + ' AND EMBALAGEM.NR_AR = ''' + @nr_ar + ''' '

if not @tx_op = ''
	SET @where = @where + ' AND CADERNETA.TX_OP = ''' + @tx_op + ''' '

EXEC (@select + @from + @where + @order)
GO
/****** Object:  StoredProcedure [scpd].[SP_CPD_LISTA_PAUTA_DISTR_DOC]    Script Date: 06/29/2010 16:19:22 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [scpd].[SP_CPD_LISTA_PAUTA_DISTR_DOC]
	@NR_PROTC [numeric](16, 0) = 0,
	@NM_PESSOA_AUTOR [varchar](100) = ''
WITH EXECUTE AS CALLER
AS
DECLARE @WHERE AS VARCHAR(300) 

SET @WHERE = 'WHERE 1=1 '

IF (@NR_PROTC <> 0) and (@NM_PESSOA_AUTOR = '')
	SET @WHERE = @WHERE + ' AND (SOL.NR_PROTC = ' + CAST( @NR_PROTC AS varchar(16)) + ')'

IF (@NR_PROTC = 0) and (@NM_PESSOA_AUTOR <> '')
	SET @WHERE = @WHERE + ' AND (DOC.NM_PESSOA_AUTOR LIKE ''%'  + @NM_PESSOA_AUTOR + '%'')'

IF (@NR_PROTC <> 0) and (@NM_PESSOA_AUTOR <> '')
	SET @WHERE = @WHERE + ' AND (SOL.NR_PROTC = ' + CAST( @NR_PROTC AS varchar(16)) + ') AND (DOC.NM_PESSOA_AUTOR LIKE ''%'  + @NM_PESSOA_AUTOR + '%'')'

DECLARE @SELECT AS VARCHAR(300)

SET @SELECT = ' SELECT DISTINCT	DOC.CD_PAUTA 
						, DOC.NM_PESSOA_AUTOR
						, DOC.NR_DOC
				 FROM	CPD_PAUTA_DISTR_DOC DOC INNER JOIN CPD_SOLIC SOL
						ON DOC.CD_PAUTA = SOL.CD_PAUTA '

EXEC (@SELECT + @WHERE)
GO
/****** Object:  StoredProcedure [scpd].[SP_CPD_ALTER_SOLIC_PDF417]    Script Date: 06/29/2010 16:19:19 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [scpd].[SP_CPD_ALTER_SOLIC_PDF417]
	@NR_PROTC [decimal](16, 0),
	@IM_PDF417 [image]
WITH EXECUTE AS CALLER
AS
UPDATE CPD_SOLIC
SET IM_PDF417 = @IM_PDF417
WHERE NR_PROTC = @NR_PROTC
GO
/****** Object:  StoredProcedure [scpd].[SP_CPD_REL_CADERN_LIBER]    Script Date: 06/29/2010 16:19:22 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [scpd].[SP_CPD_REL_CADERN_LIBER]
	@CADERNETAS [text]
WITH EXECUTE AS CALLER
AS
EXEC('

SELECT
	CPD_LOTE_SOLIC_USUAR.TP_NATURZ_ENTRG,
	CPD_USUAR.NM_USUAR,
	CPD_SOLIC.NR_PROTC,
	CPD_SOLIC.NR_CADERN,
	(SELECT COUNT(1) FROM CPD_CADERN WHERE CPD_CADERN.NR_CADERN IN (' + @CADERNETAS + ')) AS QTD,
	CPD_STATUS_SOLIC.DS_STATUS_SOLIC,
	GETDATE() DT_DOC
FROM
	CPD_LOTE_SOLIC_USUAR	    
		INNER JOIN CPD_SOLIC ON CPD_LOTE_SOLIC_USUAR.CD_LOTE = CPD_SOLIC.CD_LOTE
		INNER JOIN CPD_CADERN ON CPD_SOLIC.NR_CADERN = CPD_CADERN.NR_CADERN
		INNER JOIN CPD_STATUS_SOLIC ON CPD_SOLIC.CD_STATUS_SOLIC = CPD_STATUS_SOLIC.CD_STATUS_SOLIC
		INNER JOIN CPD_USUAR ON CPD_CADERN.CD_USUAR_RETIR_CADERN = CPD_USUAR.CD_USUAR
WHERE
	 CPD_CADERN.NR_CADERN IN (' + @CADERNETAS + ')
ORDER BY CPD_CADERN.SQ_CADERN
')
GO
/****** Object:  StoredProcedure [scpd].[SP_CPD_RETORN_SOLIC_STATUS]    Script Date: 06/29/2010 16:19:23 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [scpd].[SP_CPD_RETORN_SOLIC_STATUS]
	@NR_CADERN [char](8)
WITH EXECUTE AS CALLER
AS
UPDATE
	CPD_SOLIC
SET
	CD_STATUS_SOLIC = 20 -- PRONTO PARA IMPRIMIR
WHERE
	NR_CADERN = @NR_CADERN
	AND CD_STATUS_SOLIC IN (25,26,30,40) -- Imprimindo, Impresso, Aguardando Autorização para Reimpressão e Pronto para embalar
GO
/****** Object:  StoredProcedure [scpd].[SP_CPD_LISTA_CADERN_LOTE]    Script Date: 06/29/2010 16:19:21 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [scpd].[SP_CPD_LISTA_CADERN_LOTE]
	@CD_LOTES [varchar](2000)
WITH EXECUTE AS CALLER
AS
EXEC('SELECT CPD_SOLIC.NR_CADERN, CPD_SOLIC.CD_LOTE, CPD_LOTE_SOLIC_USUAR.DT_ABERT_LOTE
	  FROM CPD_LOTE_SOLIC_USUAR
			INNER JOIN CPD_SOLIC ON CPD_LOTE_SOLIC_USUAR.CD_LOTE = CPD_SOLIC.CD_LOTE
			INNER JOIN CPD_CADERN ON CPD_SOLIC.NR_CADERN = CPD_CADERN.NR_CADERN
	  WHERE CPD_LOTE_SOLIC_USUAR.CD_LOTE IN (' + @CD_LOTES + ')
	  ORDER BY CPD_CADERN.SQ_CADERN')
GO
/****** Object:  StoredProcedure [scpd].[SP_CPD_VALID_NR_REMES_IMPORT]    Script Date: 06/29/2010 16:19:23 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [scpd].[SP_CPD_VALID_NR_REMES_IMPORT]
	@NR_REMES [varchar](40)
WITH EXECUTE AS CALLER
AS
SELECT ISNULL(COUNT(NR_REMES), 0) AS NR_REMES_IMPORT
FROM CPD_SOLIC
WHERE NR_REMES = @NR_REMES
GO
/****** Object:  StoredProcedure [scpd].[SP_CPD_LISTA_DADO_PASPRT]    Script Date: 06/29/2010 16:19:21 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [scpd].[SP_CPD_LISTA_DADO_PASPRT]
	@NR_PROTC [numeric](16, 0) = 0,
	@NM_PESSOA_AUTOR [varchar](100) = '',
	@NR_DOC [varchar](20) = '',
	@CD_STATUS_SOLIC [smallint]
WITH EXECUTE AS CALLER
AS
DECLARE @WHERE AS VARCHAR(350) 

SET @WHERE = ' WHERE Solicitacao.TP_NATURZ_ENTRG = ''E'' AND Solicitacao.CD_STATUS_SOLIC = ' + CAST(@CD_STATUS_SOLIC AS varchar(4)) 

if (@NR_PROTC <> 0)
BEGIN
	DECLARE @CD_PAUTA INT
	SET @CD_PAUTA = (SELECT CD_PAUTA FROM CPD_SOLIC WHERE NR_PROTC = @NR_PROTC)
	SET @WHERE = @WHERE + ' AND (Solicitacao.CD_PAUTA = ' + CAST( @CD_PAUTA AS varchar(16)) + ')'
END
if (@NM_PESSOA_AUTOR <> '')
	SET @WHERE = @WHERE + ' AND (PautaDoc.NM_PESSOA_AUTOR LIKE ''%'  + @NM_PESSOA_AUTOR + '%'')'
										
if (@NR_DOC <> '')
    SET @WHERE = @WHERE + ' AND (PautaDoc.NR_DOC LIKE '''  + @NR_DOC + ''')'


DECLARE @SELECT varchar(1000)
SET @SELECT = ' 

SELECT Solicitacao.NR_PROTC,
       Solicitacao.TX_SOBREN,
       Solicitacao.TX_NOME,
       Solicitacao.NR_CADERN,
       Solicitacao.CD_PAUTA,
       PautaDoc.NM_PESSOA_AUTOR,
       PautaDoc.NR_DOC, 
       Solicitacao.NR_PROTC as SEQSOLIC,
       Solicitacao.NR_CADERN as NUMPASSAPORTE,
       convert(varchar(8), getdate(), 112) + replace(convert(varchar(8), getdate(), 108), '':'', '''') as DATAHORARECEBIMENTO,
       PautaDoc.NR_DOC as NUMMATRICULA
From  
       CPD_SOLIC Solicitacao 
	   inner join CPD_PAUTA_DISTR Pauta on Pauta.CD_PAUTA = Solicitacao.CD_PAUTA
       inner join CPD_PAUTA_DISTR_DOC PautaDoc on Pauta.CD_PAUTA = PautaDoc.CD_PAUTA ' 
       

EXEC (@SELECT + @WHERE)
GO
/****** Object:  StoredProcedure [scpd].[SP_CPD_ALTER_STATUS_SOLIC_EMBALA]    Script Date: 06/29/2010 16:19:20 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [scpd].[SP_CPD_ALTER_STATUS_SOLIC_EMBALA]
	@CD_STATUS_SOLIC [smallint],
	@CD_EMBALA [decimal](12, 0),
	@CD_USUAR_LOGADO [int],
	@CD_ESTAC [int]
WITH EXECUTE AS CALLER
AS
-- ALTERA STATUS SOLICITACAO AO SER VINCULADA UMA EMBALAGEM A UM VEICULO (Expedicao)
-- E AO SER DESVINCULADA UMA EMBALAGEM A UM VEICULO	
   UPDATE CPD_SOLIC 
	  SET CD_STATUS_SOLIC = @CD_STATUS_SOLIC,
		  CD_ESTAC = @CD_ESTAC ,  
		  CD_USUAR = @CD_USUAR_LOGADO
	  FROM CPD_SOLIC Solicitacao 
			  inner join CPD_CADERN Caderneta 
				 on Caderneta.NR_CADERN = Solicitacao.NR_CADERN
	  WHERE Caderneta.CD_Embala = @CD_EMBALA
GO
/****** Object:  StoredProcedure [scpd].[SP_CPD_VALID_PROTC_CADERN_EXPEDC]    Script Date: 06/29/2010 16:19:23 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [scpd].[SP_CPD_VALID_PROTC_CADERN_EXPEDC]
	@NR_CADERN [char](8)
WITH EXECUTE AS CALLER
AS
SELECT CPD_CADERN.NR_CADERN
FROM CPD_CADERN
	INNER JOIN CPD_SOLIC ON CPD_CADERN.NR_CADERN = CPD_SOLIC.NR_CADERN
WHERE CPD_CADERN.NR_CADERN = @NR_CADERN AND
	  CPD_SOLIC.CD_STATUS_SOLIC >= 70
GO
/****** Object:  StoredProcedure [scpd].[SP_CPD_LIBER_CADERN]    Script Date: 06/29/2010 16:19:21 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [scpd].[SP_CPD_LIBER_CADERN]
	@CADERNETAS [text],
	@CD_USUAR_RETIR_CADERN [int]
WITH EXECUTE AS CALLER
AS
exec('UPDATE CPD_CADERN
	    SET CD_USUAR_RETIR_CADERN = ' + @CD_USUAR_RETIR_CADERN + ' ,
		    DT_LIBER = GETDATE()
      WHERE NR_CADERN IN (' + @CADERNETAS + ')')
GO
/****** Object:  StoredProcedure [scpd].[SP_CPD_VALID_JA_LIBER_USUAR]    Script Date: 06/29/2010 16:19:23 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [scpd].[SP_CPD_VALID_JA_LIBER_USUAR]
	@CADERNETAS [text],
	@CD_USUAR_RETIR_CADERN [int]
WITH EXECUTE AS CALLER
AS
exec('SELECT C.NR_CADERN
	  FROM CPD_CADERN C
	  WHERE C.NR_CADERN IN(' + @CADERNETAS + ') AND
			C.CD_USUAR_RETIR_CADERN = ' + @CD_USUAR_RETIR_CADERN)
GO
/****** Object:  StoredProcedure [scpd].[SP_CPD_VALID_CADERN_VINCUL_USUAR]    Script Date: 06/29/2010 16:19:23 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [scpd].[SP_CPD_VALID_CADERN_VINCUL_USUAR]
	@CADERNETAS [text],
	@CD_USUAR [int]
WITH EXECUTE AS CALLER
AS
exec('SELECT L.CD_USUAR, S.NR_CADERN
	  FROM CPD_LOTE_SOLIC_USUAR L 
				INNER JOIN CPD_SOLIC S ON L.CD_LOTE = S.CD_LOTE
	  WHERE S.NR_CADERN IN(' + @CADERNETAS + ') AND
			NOT L.CD_USUAR = ' + @CD_USUAR)
GO
/****** Object:  StoredProcedure [scpd].[SP_CPD_VALID_STATUS_CADERN]    Script Date: 06/29/2010 16:19:23 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [scpd].[SP_CPD_VALID_STATUS_CADERN]
	@CADERNETAS [text],
	@CD_CADERN_STATUS [int],
	@CD_STATUS_SOLIC [int]
WITH EXECUTE AS CALLER
AS
exec('SELECT C.NR_CADERN
	  FROM CPD_SOLIC S 
				LEFT JOIN CPD_CADERN C ON S.NR_CADERN = C.NR_CADERN				
	  WHERE (NOT C.CD_CADERN_STATUS = ' + @CD_CADERN_STATUS + '
			 OR S.CD_STATUS_SOLIC > ' + @CD_STATUS_SOLIC + ') AND
			 C.NR_CADERN IN(' + @CADERNETAS + ')')
GO
/****** Object:  StoredProcedure [scpd].[SP_CPD_LISTA_NF]    Script Date: 06/29/2010 16:19:22 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [scpd].[SP_CPD_LISTA_NF]
	@NR_NF [varchar](18),
	@NR_SERIE_NF [varchar](2)
WITH EXECUTE AS CALLER
AS
DECLARE @vlr_caderneta     decimal(18,2)

SET @vlr_caderneta = ( SELECT	CAST( VL_PARAM AS DECIMAL(18,2 ) )
                       FROM		CPD_PARAM
                       WHERE	CD_PARAM = 4 )

SELECT	DISTINCT EMB.NR_AR
		,TP_EMB.DS_TP_EMBALA
		,(SELECT COUNT(*)
			   FROM CPD_CADERN CAD
			   WHERE CAD.CD_EMBALA = EMB.CD_EMBALA) + TP_EMB.NR_PESO
			   AS 'PESO_EMBALAGEM'
		,(SELECT COUNT(1)
					   FROM CPD_CADERN CAD
					   WHERE CAD.CD_EMBALA = EMB.CD_EMBALA) * @vlr_caderneta + TP_EMB.VL_EMBALA  AS 'VLR_EMBALAGEM'
		,TP_EMB.QT_MAX_CADERN
		,ENTRG.EN_UNID_ENTRG
		,@NR_NF as NR_NF
		,@NR_SERIE_NF AS NR_SERIE_NF
FROM	CPD_NF NF
		INNER JOIN CPD_EMBALA EMB		ON NF.CD_NF = EMB.CD_NF
		INNER JOIN CPD_TP_EMBALA TP_EMB ON EMB.CD_TP_EMBALA = TP_EMB.CD_TP_EMBALA
		INNER JOIN CPD_CADERN CAD		ON EMB.CD_EMBALA = CAD.CD_EMBALA
		INNER JOIN CPD_SOLIC SOL		ON CAD.NR_CADERN = SOL.NR_CADERN
		INNER JOIN CPD_UNID_ENTRG ENTRG ON SOL.CD_UNID = ENTRG.CD_UNID
WHERE	NF.NR_NF = @NR_NF AND NR_SERIE_NF = @NR_SERIE_NF
GO
/****** Object:  StoredProcedure [scpd].[SP_CPD_LIMPA_BD]    Script Date: 06/29/2010 16:19:21 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [scpd].[SP_CPD_LIMPA_BD]
WITH EXECUTE AS CALLER
AS
BEGIN TRANSACTION

delete cpd_cadern_hist_status
---
delete CPD_RASTR_ATIV_AR
DBCC CHECKIDENT (CPD_RASTR_ATIV_AR, RESEED, 0)
delete CPD_RETORN_POSTAG_AR
DBCC CHECKIDENT (CPD_RETORN_POSTAG_AR, RESEED, 0)
---
delete cpd_embala_hist_status
delete cpd_solic_hist_status
DBCC CHECKIDENT (cpd_solic_hist_status, RESEED, 0)
delete cpd_solic_rejeit
delete cpd_solic
delete cpd_lote_solic_usuar_hist
delete cpd_lote_solic_usuar
DBCC CHECKIDENT (cpd_lote_solic_usuar, RESEED, 0)
delete cpd_pauta_distr_doc
delete cpd_pauta_distr
DBCC CHECKIDENT (cpd_pauta_distr, RESEED, 0)
delete cpd_cadern
DBCC CHECKIDENT (cpd_cadern, RESEED, 0)
delete cpd_embala
DBCC CHECKIDENT (cpd_embala, RESEED, 0)
delete cpd_veicul
DBCC CHECKIDENT (cpd_veicul, RESEED, 0)
delete cpd_aviso
DBCC CHECKIDENT (cpd_aviso, RESEED, 0)
delete cpd_nf
DBCC CHECKIDENT (cpd_nf, RESEED, 0)
delete cpd_log_arq
DBCC CHECKIDENT (cpd_log_arq, RESEED, 0)
delete cpd_arq
DBCC CHECKIDENT (cpd_arq, RESEED, 0)
delete cpd_estoq_geral_hist
DBCC CHECKIDENT (cpd_estoq_geral_hist, RESEED, 0)
delete cpd_estoqu_geral
delete cpd_op
delete cpd_mater
delete cpd_prodt
DBCC CHECKIDENT (cpd_prodt, RESEED, 0)
delete cpd_Testemunho
DBCC CHECKIDENT (cpd_Testemunho, RESEED, 0)
delete cpd_param_hist
DBCC CHECKIDENT (cpd_param_hist, RESEED, 0)
delete cpd_inform_erro
delete cpd_cader_perd
DBCC CHECKIDENT (cpd_cader_perd, RESEED, 0)
delete cpd_ar
delete cpd_param_hist
DBCC CHECKIDENT (cpd_param_hist, RESEED, 0)
delete cpd_envio_sedex10_sedex_hoje_hist
DBCC CHECKIDENT (cpd_envio_sedex10_sedex_hoje_hist, RESEED, 0)

COMMIT
GO
/****** Object:  StoredProcedure [scpd].[SP_CPD_LISTA_AR]    Script Date: 06/29/2010 16:19:21 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [scpd].[SP_CPD_LISTA_AR]
	@CD_EMBALA [int]
WITH EXECUTE AS CALLER
AS
SELECT	E.NR_AR
		, E.CD_TP_AR
		, NF.NR_NF
		, NF.NR_SERIE_NF
FROM	CPD_EMBALA E
		LEFT JOIN CPD_NF NF 
			ON NF.CD_NF = E.CD_NF
WHERE   E.CD_EMBALA = @CD_EMBALA


SELECT DISTINCT	UE.CD_UNID
		,UE.DS_UNID
		,UE.EN_UNID_ENTRG
        ,UE.NM_BAIRRO
		,UE.NR_CEP
		,UE.CD_UNID_SUPTD
		,M.NM_MUN
		,M.SG_UF
		,UA.CD_UNID AS CD_UNID_ATEND
		,UA.DS_UNID AS DS_UNID_ATEND		
		,US.DS_UNID AS DS_UNID_SUPTD
		,US.EN_UNID_ENTRG AS EN_UNID_ENTRG_SUPTD 
        ,US.NM_BAIRRO AS NM_BAIRRO_SUPTD
		,US.NR_CEP AS NR_CEP_SUPTD
		,MS.NM_MUN AS NM_MUN_SUPTD
		,MS.SG_UF AS SG_UF_SUPTD
FROM	CPD_EMBALA E INNER JOIN CPD_CADERN C
			ON E.CD_EMBALA = C.CD_EMBALA
		INNER JOIN CPD_SOLIC S
			ON C.NR_CADERN = S.NR_CADERN
		INNER JOIN CPD_UNID_ENTRG UE
			ON S.CD_UNID = UE.CD_UNID
		INNER JOIN CPD_UNID_ENTRG UA
			ON S.CD_UNID_ATEND = UA.CD_UNID
		INNER JOIN CPD_MUN M
			ON UE.CD_MUN = M.CD_MUN
		LEFT JOIN CPD_UNID_ENTRG US
			ON UE.CD_UNID_SUPTD = US.CD_UNID_ENTRG
		LEFT JOIN CPD_MUN MS
			ON US.CD_MUN = MS.CD_MUN
WHERE   E.CD_EMBALA = @CD_EMBALA
GO
/****** Object:  StoredProcedure [scpd].[SP_CPD_LISTA_CADERN_NF]    Script Date: 06/29/2010 16:19:21 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [scpd].[SP_CPD_LISTA_CADERN_NF]
	@DT_INICIO [datetime],
	@DT_FIM [datetime],
	@CD_STATUS_SOLIC [smallint] = NULL
WITH EXECUTE AS CALLER
AS
SELECT 
	CPD_EMBALA.CD_EMBALA,
	CPD_EMBALA.NR_AR,
	EXPEDICAO.DT_HIST,
	CPD_EMBALA.CD_NF,
	CPD_CADERN.NR_CADERN, 
	CPD_NF.NR_NF, 
	CPD_NF.VL_NF,
	CPD_NF.NR_SERIE_NF
FROM 
	CPD_EMBALA
		INNER JOIN CPD_CADERN 
			ON CPD_EMBALA.CD_EMBALA = CPD_CADERN.CD_EMBALA
		INNER JOIN CPD_NF 
			ON CPD_EMBALA.CD_NF = CPD_NF.CD_NF
		INNER JOIN  CPD_SOLIC 
			ON CPD_SOLIC.NR_CADERN = CPD_CADERN.NR_CADERN
		INNER JOIN  CPD_STATUS_SOLIC 
			ON CPD_STATUS_SOLIC.CD_STATUS_SOLIC = CPD_SOLIC.CD_STATUS_SOLIC
		INNER JOIN CPD_SOLIC_HIST_STATUS EXPEDICAO ON CPD_SOLIC.NR_PROTC=EXPEDICAO.NR_PROTC 
		AND EXPEDICAO.DT_HIST = (SELECT MIN(DT_HIST) 
												  FROM CPD_SOLIC_HIST_STATUS 
												  WHERE CPD_SOLIC.NR_PROTC=CPD_SOLIC_HIST_STATUS.NR_PROTC 
												  AND CPD_SOLIC_HIST_STATUS.CD_STATUS_SOLIC=70
												  AND CPD_SOLIC.CD_STATUS_SOLIC >= 70)											
WHERE 
	CONVERT(VARCHAR(8), EXPEDICAO.DT_HIST, 112) >= CONVERT(VARCHAR(8), @DT_INICIO, 112) AND
	CONVERT(VARCHAR(8), EXPEDICAO.DT_HIST, 112) <= CONVERT(VARCHAR(8), @DT_FIM, 112) AND
	(CPD_SOLIC.CD_STATUS_SOLIC >= @CD_STATUS_SOLIC OR @CD_STATUS_SOLIC IS NULL)
ORDER BY 
	CPD_NF.CD_NF, CPD_CADERN.SQ_CADERN
GO
/****** Object:  StoredProcedure [scpd].[SP_CPD_LISTA_CADERN]    Script Date: 06/29/2010 16:19:21 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [scpd].[SP_CPD_LISTA_CADERN]
	@NR_CADERN [varchar](8)
WITH EXECUTE AS CALLER
AS
select	HISTORICO.dt_altera, 
		STATUS.ds_cadern_status,
		USUARIO.nm_usuar,
		HISTORICO.nr_cadern ,
		(select TOP 1 SolHistStatus.nr_protc from cpd_solic_hist_status SolHistStatus
		where SolHistStatus.nr_cadern = HISTORICO.nr_cadern)as NR_PROTC,
		ESTACAO.ds_estac,
		PERDA.ds_motivo_perda,
		DEVOLUCAO.ds_motivo_devol,
		EMBALA.nr_ar
from cpd_cadern CADERN
	inner join 	cpd_cadern_hist_status HISTORICO
		on CADERN.nr_cadern = HISTORICO.nr_cadern
	inner join cpd_cadern_status STATUS
		on STATUS.cd_cadern_status = HISTORICO.cd_cadern_status
	inner join cpd_usuar USUARIO
		on USUARIO.cd_usuar = HISTORICO.cd_usuar
	inner join cpd_estac ESTACAO 
		on ESTACAO.cd_estac = HISTORICO.cd_estac
	left join cpd_motivo_perda PERDA
		on PERDA.cd_motivo_perda = HISTORICO.cd_motivo_perda
	left join cpd_motivo_devol DEVOLUCAO
		on DEVOLUCAO.cd_motivo_devol = HISTORICO.cd_motivo_devol
	left join cpd_embala EMBALA
		on CADERN.cd_embala = EMBALA.cd_embala
where HISTORICO.NR_CADERN = @NR_CADERN
order by HISTORICO.dt_altera desc
GO
/****** Object:  StoredProcedure [scpd].[SP_CPD_LISTA_CADERN_ENTRG]    Script Date: 06/29/2010 16:19:21 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [scpd].[SP_CPD_LISTA_CADERN_ENTRG]
	@DT_INICIO [datetime] = NULL,
	@DT_FIM [datetime] = NULL,
	@NR_AR [varchar](30) = NULL,
	@NR_CADERN [char](8) = NULL,
	@CD_UNID [varchar](13) = NULL
WITH EXECUTE AS CALLER
AS
IF EXISTS (SELECT 1 FROM TEMPDB..SYSOBJECTS WHERE NAME = '##STATUS_ENTREGA' AND TYPE = 'U')
	DROP TABLE ##STATUS_ENTREGA


CREATE TABLE ##STATUS_ENTREGA
(CD_STATUS_ENTREGA INT NOT NULL, STATUS_ENTREGA VARCHAR(30) NOT NULL)
INSERT INTO ##STATUS_ENTREGA (CD_STATUS_ENTREGA, STATUS_ENTREGA) VALUES (1,'NÃO ENTREGUE')
INSERT INTO ##STATUS_ENTREGA (CD_STATUS_ENTREGA, STATUS_ENTREGA) VALUES (2,'ENTREGUE COM ATRASO')
INSERT INTO ##STATUS_ENTREGA (CD_STATUS_ENTREGA, STATUS_ENTREGA) VALUES (3,'ENTREGUE NO PRAZO')
	   

SELECT DISTINCT
	CPD_CADERN.SQ_CADERN,
	CPD_CADERN.NR_CADERN, 
	CPD_UNID_ENTRG.CD_UNID, 
	CPD_UNID_ENTRG.DS_UNID,
	EXPEDICAO.DT_HIST AS DT_EXP, --Data Expedição
	CPD_EMBALA.NR_AR, 
	ENTREGA.DT_HIST AS DT_ENTRG, --Data da Entrega
	CPD_SOLIC.DT_SOLIC,	
	DATEDIFF(day, CONVERT(varchar(10), CPD_SOLIC.DT_SOLIC, 111), CONVERT(varchar(10), ENTREGA.DT_HIST, 111)) AS QTE_DIAS_ENTREGA_REAL,
	CASE CPD_SOLIC.TP_NATURZ_ENTRG
		WHEN 'R' THEN
			ISNULL(DATEDIFF(day, CONVERT(varchar(10), ENTREGA.DT_HIST, 111), DATEADD(day, (SELECT CAST(VL_PARAM AS INT) FROM CPD_PARAM WHERE CD_PARAM=1),CONVERT(varchar(10), CPD_SOLIC.DT_SOLIC, 111))), 0)
		WHEN 'U' THEN
			ISNULL(DATEDIFF(day, CONVERT(varchar(10), ENTREGA.DT_HIST, 111), DATEADD(day, (SELECT CAST(VL_PARAM AS INT) FROM CPD_PARAM WHERE CD_PARAM=2),CONVERT(varchar(10), CPD_SOLIC.DT_SOLIC, 111))), 0)
	END AS QT_DIAS_ENTREGA_PREVISTA				
	FROM CPD_CADERN
		INNER JOIN CPD_SOLIC ON CPD_CADERN.NR_CADERN = CPD_SOLIC.NR_CADERN
		INNER JOIN CPD_UNID_ENTRG ON CPD_SOLIC.CD_UNID = CPD_UNID_ENTRG.CD_UNID
		INNER JOIN CPD_EMBALA ON CPD_CADERN.CD_EMBALA = CPD_EMBALA.CD_EMBALA
		LEFT JOIN CPD_SOLIC_HIST_STATUS ENTREGA ON CPD_SOLIC.NR_PROTC=ENTREGA.NR_PROTC 
		AND ENTREGA.DT_HIST = (SELECT MIN(DT_HIST) 
												  FROM CPD_SOLIC_HIST_STATUS 
												  WHERE CPD_SOLIC_HIST_STATUS.NR_PROTC=ENTREGA.NR_PROTC 
												  AND CPD_SOLIC_HIST_STATUS.CD_STATUS_SOLIC=80
												  AND CPD_SOLIC.CD_STATUS_SOLIC  >= 80)
		LEFT JOIN CPD_SOLIC_HIST_STATUS EXPEDICAO ON CPD_SOLIC.NR_PROTC=EXPEDICAO.NR_PROTC
		AND EXPEDICAO.DT_HIST = (SELECT MIN(DT_HIST) 
												  FROM CPD_SOLIC_HIST_STATUS 
												  WHERE CPD_SOLIC_HIST_STATUS.NR_PROTC=EXPEDICAO.NR_PROTC 
												  AND CPD_SOLIC_HIST_STATUS.CD_STATUS_SOLIC=70)		
	WHERE
		(CONVERT(VARCHAR(8), EXPEDICAO.DT_HIST , 112) >= CONVERT(VARCHAR(8), @DT_INICIO, 112) OR @DT_INICIO IS NULL) AND
		(CONVERT(VARCHAR(8), EXPEDICAO.DT_HIST , 112) <= CONVERT(VARCHAR(8), @DT_FIM, 112) OR @DT_FIM IS NULL)
		AND (CPD_EMBALA.NR_AR = @NR_AR OR @NR_AR IS NULL)
		AND (CPD_CADERN.NR_CADERN = @NR_CADERN OR @NR_CADERN IS NULL)
		AND (CPD_UNID_ENTRG.CD_UNID = @CD_UNID  OR @CD_UNID  IS NULL)
		AND CPD_SOLIC.CD_STATUS_SOLIC >= 70


/*-----------------------------------------------------------------------------------------------
Retorna os campos para preenchimento do Gráfico.
Indpendentemente da quantidade de status de entrega retornada pela query acima (máximo 3 status),
retornará sempre os três status para que as cores do gráfico sejam sempre as mesmas:
- Azul    : Cadernetas não entregues
- Verde   : Cadernetas entregues no prazo
- Vermelho: Cadernetas entregue com atraso
-----------------------------------------------------------------------------------------------*/
SELECT COUNT(E.CD_STATUS_ENTREGA) AS TOTAL, ##STATUS_ENTREGA.STATUS_ENTREGA 
FROM ##STATUS_ENTREGA
	LEFT JOIN 
(
SELECT DISTINCT CPD_CADERN.NR_CADERN,
	CASE 
		WHEN (CASE CPD_SOLIC.TP_NATURZ_ENTRG
				WHEN 'R' THEN
					ISNULL(DATEDIFF(day, CONVERT(varchar(10), ENTREGA.DT_HIST, 111), DATEADD(day, (SELECT CAST(VL_PARAM AS INT) FROM CPD_PARAM WHERE CD_PARAM=1),CONVERT(varchar(10), CPD_SOLIC.DT_SOLIC, 111))), 0)
				WHEN 'U' THEN
					ISNULL(DATEDIFF(day, CONVERT(varchar(10), ENTREGA.DT_HIST, 111), DATEADD(day, (SELECT CAST(VL_PARAM AS INT) FROM CPD_PARAM WHERE CD_PARAM=2),CONVERT(varchar(10), CPD_SOLIC.DT_SOLIC, 111))), 0)
			END) = 0 THEN 
			1 -- Não Entregue
		WHEN (CASE CPD_SOLIC.TP_NATURZ_ENTRG
				WHEN 'R' THEN
					ISNULL(DATEDIFF(day, CONVERT(varchar(10), ENTREGA.DT_HIST, 111), DATEADD(day, (SELECT CAST(VL_PARAM AS INT) FROM CPD_PARAM WHERE CD_PARAM=1),CONVERT(varchar(10), CPD_SOLIC.DT_SOLIC, 111))), 0)
				WHEN 'U' THEN
					ISNULL(DATEDIFF(day, CONVERT(varchar(10), ENTREGA.DT_HIST, 111), DATEADD(day, (SELECT CAST(VL_PARAM AS INT) FROM CPD_PARAM WHERE CD_PARAM=2),CONVERT(varchar(10), CPD_SOLIC.DT_SOLIC, 111))), 0)
			END)  > 0 THEN
			3 -- Entregue no prazo
		ELSE 
			2 -- Entregue com atraso
		END AS CD_STATUS_ENTREGA					
	FROM CPD_CADERN
		INNER JOIN CPD_SOLIC ON CPD_CADERN.NR_CADERN = CPD_SOLIC.NR_CADERN
		INNER JOIN CPD_UNID_ENTRG ON CPD_SOLIC.CD_UNID = CPD_UNID_ENTRG.CD_UNID
		INNER JOIN CPD_EMBALA ON CPD_CADERN.CD_EMBALA = CPD_EMBALA.CD_EMBALA
		LEFT JOIN CPD_SOLIC_HIST_STATUS ENTREGA ON CPD_SOLIC.NR_PROTC=ENTREGA.NR_PROTC 
		AND ENTREGA.DT_HIST = (SELECT MIN(DT_HIST) 
												  FROM CPD_SOLIC_HIST_STATUS 
												  WHERE CPD_SOLIC_HIST_STATUS.NR_PROTC=ENTREGA.NR_PROTC 
												  AND CPD_SOLIC_HIST_STATUS.CD_STATUS_SOLIC=80
												  AND CPD_SOLIC.CD_STATUS_SOLIC  >= 80)
		LEFT JOIN CPD_SOLIC_HIST_STATUS EXPEDICAO ON CPD_SOLIC.NR_PROTC=EXPEDICAO.NR_PROTC
		AND EXPEDICAO.DT_HIST = (SELECT MIN(DT_HIST) 
												  FROM CPD_SOLIC_HIST_STATUS 
												  WHERE CPD_SOLIC_HIST_STATUS.NR_PROTC=EXPEDICAO.NR_PROTC 
												  AND CPD_SOLIC_HIST_STATUS.CD_STATUS_SOLIC=70)		
	WHERE
		(CONVERT(VARCHAR(8), EXPEDICAO.DT_HIST , 112) >= CONVERT(VARCHAR(8), @DT_INICIO, 112) OR @DT_INICIO IS NULL) AND
		(CONVERT(VARCHAR(8), EXPEDICAO.DT_HIST , 112) <= CONVERT(VARCHAR(8), @DT_FIM, 112) OR @DT_FIM IS NULL)
		AND (CPD_EMBALA.NR_AR = @NR_AR OR @NR_AR IS NULL)
		AND (CPD_CADERN.NR_CADERN = @NR_CADERN OR @NR_CADERN IS NULL)
		AND (CPD_UNID_ENTRG.CD_UNID = @CD_UNID  OR @CD_UNID  IS NULL)
		AND CPD_SOLIC.CD_STATUS_SOLIC >= 70
) AS E
ON ##STATUS_ENTREGA.CD_STATUS_ENTREGA = E.CD_STATUS_ENTREGA
GROUP BY ##STATUS_ENTREGA.CD_STATUS_ENTREGA, ##STATUS_ENTREGA.STATUS_ENTREGA
ORDER BY ##STATUS_ENTREGA.CD_STATUS_ENTREGA

IF EXISTS (SELECT 1 FROM TEMPDB..SYSOBJECTS WHERE NAME = '##STATUS_ENTREGA' AND TYPE = 'U')
	DROP TABLE ##STATUS_ENTREGA
GO
/****** Object:  StoredProcedure [scpd].[SP_CPD_VALID_EMBALA_PROTC_EXPEDC]    Script Date: 06/29/2010 16:19:23 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [scpd].[SP_CPD_VALID_EMBALA_PROTC_EXPEDC]
	@CD_EMBALA [decimal](16, 0)
WITH EXECUTE AS CALLER
AS
SELECT CPD_SOLIC.NR_PROTC
  FROM CPD_EMBALA
		INNER JOIN CPD_CADERN ON CPD_EMBALA.CD_EMBALA = CPD_CADERN.CD_EMBALA
        INNER JOIN CPD_SOLIC ON CPD_CADERN.NR_CADERN = CPD_SOLIC.NR_CADERN
 WHERE  CPD_EMBALA.CD_EMBALA = @CD_EMBALA AND
	    (NOT CPD_SOLIC.CD_STATUS_SOLIC = 70 OR --PROTOCOLOS EXPEDIDOS
		 NOT CPD_EMBALA.CD_EMBALA_STATUS = 10) --EMBALAGEM FINALIZADA (NÃO EXTRAVIADA)
GO
/****** Object:  StoredProcedure [scpd].[SP_CPD_RESUMO_OP_CADERN]    Script Date: 06/29/2010 16:19:23 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [scpd].[SP_CPD_RESUMO_OP_CADERN]
	@TX_OP [varchar](40)
WITH EXECUTE AS CALLER
AS
SELECT QT_MATER AS QT_ORIGIN_OP_CADERN, 
       (QT_MATER - isnull(QT_MOV, 0)) AS QT_ARMAZ_OP_CADERN,
	   (isnull(QT_MOV, 0) - (SELECT COUNT(DISTINCT CPD_CADERN.NR_CADERN) 
                  FROM CPD_CADERN						  
					      INNER JOIN CPD_SOLIC ON CPD_CADERN.NR_CADERN = CPD_SOLIC.NR_CADERN
						  LEFT JOIN CPD_EMBALA ON CPD_CADERN.CD_EMBALA = CPD_EMBALA.CD_EMBALA
						  LEFT JOIN CPD_EMBALA_HIST_STATUS ON CPD_EMBALA.CD_EMBALA = CPD_EMBALA_HIST_STATUS.CD_EMBALA
				  WHERE TX_OP = @TX_OP AND
						(CPD_SOLIC.CD_STATUS_SOLIC > 50 OR CPD_EMBALA.DT_ARMAZ_COFRE IS NOT NULL OR CPD_EMBALA_HIST_STATUS.NR_AR_ANTIGO IS NOT NULL)) 
			   - (SELECT COUNT(DISTINCT CPD_CADERN.NR_CADERN)
				  FROM CPD_CADERN							  
		          WHERE TX_OP = @TX_OP AND
					    CD_CADERN_STATUS = 10) -- PERDIDA
	   ) AS QT_CPDOC_OP_CADERN,
	   (SELECT COUNT(DISTINCT CPD_CADERN.NR_CADERN) 
        FROM CPD_CADERN				
			    INNER JOIN CPD_SOLIC ON CPD_CADERN.NR_CADERN = CPD_SOLIC.NR_CADERN
			    LEFT JOIN CPD_EMBALA ON CPD_CADERN.CD_EMBALA = CPD_EMBALA.CD_EMBALA
				LEFT JOIN CPD_EMBALA_HIST_STATUS ON CPD_EMBALA.CD_EMBALA = CPD_EMBALA_HIST_STATUS.CD_EMBALA
		WHERE TX_OP = @TX_OP AND
			  (CPD_SOLIC.CD_STATUS_SOLIC > 50 OR CPD_EMBALA.DT_ARMAZ_COFRE IS NOT NULL OR CPD_EMBALA_HIST_STATUS.NR_AR_ANTIGO IS NOT NULL)) AS QT_PRODUZ_OP_CADERN,
	   (SELECT COUNT(DISTINCT CPD_CADERN.NR_CADERN)
		FROM CPD_CADERN				
		WHERE TX_OP = @TX_OP AND
			  CD_CADERN_STATUS = 10) AS QT_PERDA_OP_CADERN,
	   (SELECT COUNT(DISTINCT CPD_CADERN.NR_CADERN)
		FROM CPD_CADERN				
		WHERE TX_OP = @TX_OP AND
			  CD_CADERN_STATUS = 20) AS QT_DEVOL_OP_CADERN,
	   (SELECT COUNT(DISTINCT CPD_CADERN.NR_CADERN)
		FROM CPD_CADERN				
		WHERE TX_OP = @TX_OP AND
			  CD_CADERN_STATUS = 50) AS QT_EXTRAV_OP_CADERN			
FROM CPD_ESTOQU_GERAL	   
WHERE CPD_ESTOQU_GERAL.TX_OP = @TX_OP AND
      CPD_ESTOQU_GERAL.CD_MATER = (SELECT VL_PARAM FROM CPD_PARAM WHERE CD_PARAM = 23) -- CADERNETAS (SEMI-ACABADO)
GO
/****** Object:  StoredProcedure [scpd].[SP_CPD_LISTA_PROTC_LOCAL]    Script Date: 06/29/2010 16:19:22 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [scpd].[SP_CPD_LISTA_PROTC_LOCAL]
	@DT_HIST_DE [datetime],
	@DT_HIST_ATE [datetime],
	@CD_UNID [varchar](13) = '',
	@CD_UNID_ATEND [varchar](13) = ''
WITH EXECUTE AS CALLER
AS
select distinct	S.NR_PROTC, 
	(TX_NOME + ' ' + TX_SOBREN) TXT_NOME,
	S.TP_NATURZ_ENTRG, 
	T.DS_STATUS_SOLIC, 
	S.DT_MAX_SAIDA,
	E.NR_AR
from 
	cpd_solic S
inner join cpd_status_solic T 
  on S.CD_STATUS_SOLIC = T.CD_STATUS_SOLIC
inner join cpd_solic_hist_status H
  on S.NR_PROTC = H.NR_PROTC
inner join cpd_cadern C
  on S.NR_CADERN = C.NR_CADERN
left join cpd_embala E 
  on C.CD_EMBALA = E.CD_EMBALA
inner join cpd_unid_entrg U
  on S.CD_UNID = U.CD_UNID
inner join cpd_unid_entrg UA
  on S.CD_UNID_ATEND = UA.CD_UNID
where 
	(U.CD_UNID = @CD_UNID OR @CD_UNID = '') AND
	(UA.CD_UNID = @CD_UNID_ATEND OR @CD_UNID_ATEND = '')
group by
	S.NR_PROTC, 
	TX_NOME,
	TX_SOBREN,
	S.TP_NATURZ_ENTRG, 
	T.DS_STATUS_SOLIC, 
	S.DT_MAX_SAIDA,
	E.NR_AR
having
	max(H.DT_HIST) >= @DT_HIST_DE
and 
	max(H.DT_HIST) <= @DT_HIST_ATE
order by
	TXT_NOME asc
GO
/****** Object:  StoredProcedure [scpd].[SP_CPD_LISTA_PROTC_VEICUL]    Script Date: 06/29/2010 16:19:22 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [scpd].[SP_CPD_LISTA_PROTC_VEICUL]
	@CD_VEICUL [int]
WITH EXECUTE AS CALLER
AS
Select distinct
      CPD_SOLIC.NR_PROTC AS SEQSOLIC,
      CPD_SOLIC.NR_CADERN AS NUMPASSAPORTE,
	  CPD_SOLIC.NR_M1 AS M1,
	  CPD_EMBALA.NR_AR As NUMREMESSA,
	  convert(varchar(8), getdate(), 112) + replace(convert(varchar(8), getdate(), 108), ':', '') As DATAHORAREMESSA
from 
      CPD_VEICUL
		inner join CPD_EMBALA on CPD_EMBALA.CD_VEICUL = CPD_VEICUL.CD_VEICUL
		inner join CPD_CADERN on CPD_EMBALA.CD_EMBALA = CPD_CADERN.CD_EMBALA
		inner join CPD_SOLIC  on CPD_SOLIC.NR_CADERN = CPD_CADERN.NR_CADERN
WHERE 
        CPD_VEICUL.CD_VEICUL = @CD_VEICUL
ORDER BY CPD_EMBALA.NR_AR
GO
/****** Object:  StoredProcedure [scpd].[SP_CPD_REL_EMBALA_CADERN]    Script Date: 06/29/2010 16:19:22 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [scpd].[SP_CPD_REL_EMBALA_CADERN]
	@CD_EMBALA [numeric](12, 0)
WITH EXECUTE AS CALLER
AS
DECLARE @PesoCaderneta decimal(18,2),
        @ValorCaderneta decimal(18,2)

	/* obtendo o valor do parâmetro que guarda o valor da caderneta */
	set @ValorCaderneta = (Select cast(VL_PARAM as decimal(18,2))
                           From CPD_PARAM
                           Where cd_param = 4)

	set @PesoCaderneta = (Select cast(VL_PARAM as decimal(18,2))
                          From CPD_PARAM
                          Where cd_param = 8)

SELECT
	CPD_EMBALA.NR_AR,
	CPD_TP_EMBALA.DS_TP_EMBALA,
	CPD_UNID_ENTRG.DS_UNID,
	UNID_ATEND.DS_UNID as DS_UNID_ATEND,
	--(COUNT(1) * @ValorCaderneta) + CPD_TP_EMBALA.VL_EMBALA AS VL_EMBALA,
    COUNT(1) * @ValorCaderneta AS VL_CADERN,
	--(COUNT(1) * @PesoCaderneta) + CPD_TP_EMBALA.NR_PESO AS NR_PESO_EMBALA,
	COUNT(1) * @PesoCaderneta AS NR_PESO_CADERN,
	COUNT(1) AS QD_CADERN
FROM
	CPD_EMBALA
		INNER JOIN CPD_TP_EMBALA ON CPD_EMBALA.CD_TP_EMBALA = CPD_TP_EMBALA.CD_TP_EMBALA
		INNER JOIN CPD_CADERN ON CPD_CADERN.CD_EMBALA = CPD_EMBALA.CD_EMBALA
		INNER JOIN CPD_SOLIC ON CPD_SOLIC.NR_CADERN = CPD_CADERN.NR_CADERN
		INNER JOIN CPD_UNID_ENTRG ON CPD_UNID_ENTRG.CD_UNID = CPD_SOLIC.CD_UNID
		INNER JOIN CPD_UNID_ENTRG UNID_ATEND ON UNID_ATEND.CD_UNID = CPD_SOLIC.CD_UNID_ATEND
WHERE
	CPD_EMBALA.CD_EMBALA = @CD_EMBALA
GROUP BY
	CPD_EMBALA.NR_AR,
	CPD_TP_EMBALA.DS_TP_EMBALA,
	CPD_UNID_ENTRG.DS_UNID,
	UNID_ATEND.DS_UNID,
	CPD_TP_EMBALA.VL_EMBALA,
	CPD_TP_EMBALA.NR_PESO


SELECT
	CPD_CADERN.NR_CADERN,
	CPD_SOLIC.NR_PROTC
FROM
	CPD_CADERN
		INNER JOIN CPD_SOLIC ON CPD_CADERN.NR_CADERN = CPD_SOLIC.NR_CADERN
WHERE
	CPD_CADERN.CD_EMBALA = @CD_EMBALA
GO
/****** Object:  StoredProcedure [scpd].[SP_CPD_REL_RECIBO_COFRE]    Script Date: 06/29/2010 16:19:23 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [scpd].[SP_CPD_REL_RECIBO_COFRE]
	@CD_EMBALA [numeric](12, 0)
WITH EXECUTE AS CALLER
AS
SELECT	DISTINCT EMB.NR_AR,
				 CAD.TX_OP,
				 COUNT(CAD.NR_CADERN) AS QT_MAX_CADERN,
				 (SELECT VL_PARAM FROM CPD_PARAM WHERE CD_PARAM = 10) AS CD_PASPRT -- CÓDIGO DO PASSAPORTE DA TABELA DE PARÂMETROS
FROM			 CPD_EMBALA EMB
				 INNER JOIN CPD_TP_EMBALA TP_EMB		ON EMB.CD_TP_EMBALA = TP_EMB.CD_TP_EMBALA
				 INNER JOIN CPD_CADERN CAD				ON EMB.CD_EMBALA = CAD.CD_EMBALA
WHERE EMB.CD_EMBALA = @CD_EMBALA
GROUP BY EMB.NR_AR, CAD.TX_OP
GO
/****** Object:  StoredProcedure [scpd].[SP_CPD_LISTA_LOTE_LOCAL_ENTRG]    Script Date: 06/29/2010 16:19:22 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [scpd].[SP_CPD_LISTA_LOTE_LOCAL_ENTRG]
	@CD_EMBALA [decimal](12, 0)
WITH EXECUTE AS CALLER
AS
SELECT COUNT(CPD_SOLIC.NR_PROTC)             as 'QtdEmbalagem' , 
       CPD_LOTE_SOLIC_USUAR.DT_MAX_SAIDA     as 'DataMaximaSaida' ,
       CPD_LOTE_SOLIC_USUAR.TP_NATURZ_ENTRG  as 'Prioridade' , 
	   CPD_LOTE_SOLIC_USUAR.CD_LOTE          as 'Lote',
       UNID_ENTRG.DS_UNID                    as 'LocalEntrega',
	   UNID_ATEND.DS_UNID                    as 'LocalAtendimento',
	   CPD_LOTE_SOLIC_USUAR.DT_ABERT_LOTE    as 'DataLote',	
	   CPD_EMBALA.NR_AR,
	   CPD_EMBALA.CD_TP_EMBALA,
       CPD_EMBALA.CD_EMBALA_STATUS,
       (SELECT TOP 1 CPD_EMBALA_HIST_STATUS.NR_AR_ANTIGO 
        FROM CPD_EMBALA_HIST_STATUS 
        WHERE CPD_EMBALA_HIST_STATUS.NR_AR_NOVO = CPD_EMBALA.NR_AR AND 
              CPD_EMBALA_HIST_STATUS.NR_AR_ANTIGO IS NOT NULL
       ) AS NR_AR_ANTIGO,
	   CPD_LOTE_SOLIC_USUAR.DT_EMBALA
  FROM CPD_LOTE_SOLIC_USUAR 
		INNER JOIN CPD_SOLIC		          ON CPD_LOTE_SOLIC_USUAR.CD_LOTE = CPD_SOLIC.CD_LOTE
		INNER JOIN CPD_UNID_ENTRG UNID_ENTRG  ON UNID_ENTRG.CD_UNID = CPD_LOTE_SOLIC_USUAR.CD_LOCAL_EXP   
		INNER JOIN CPD_UNID_ENTRG UNID_ATEND  ON UNID_ATEND.CD_UNID = CPD_LOTE_SOLIC_USUAR.CD_LOCAL_ATEND  
		INNER JOIN CPD_CADERN		          ON CPD_SOLIC.NR_CADERN = CPD_CADERN.NR_CADERN
		INNER JOIN CPD_EMBALA		          ON CPD_CADERN.CD_EMBALA = CPD_EMBALA.CD_EMBALA
 WHERE  CPD_CADERN.CD_EMBALA = @CD_EMBALA
 GROUP BY CPD_LOTE_SOLIC_USUAR.DT_MAX_SAIDA, 
          CPD_LOTE_SOLIC_USUAR.TP_NATURZ_ENTRG,
          CPD_LOTE_SOLIC_USUAR.CD_LOTE,
          UNID_ENTRG.DS_UNID,
		  UNID_ATEND.DS_UNID,
		  CPD_LOTE_SOLIC_USUAR.DT_ABERT_LOTE,
	      CPD_EMBALA.NR_AR,
		  CPD_EMBALA.CD_TP_EMBALA,
		  CPD_EMBALA.CD_EMBALA_STATUS,
		  CPD_LOTE_SOLIC_USUAR.DT_EMBALA 
 ORDER BY CPD_LOTE_SOLIC_USUAR.DT_MAX_SAIDA ASC
GO
/****** Object:  StoredProcedure [scpd].[SP_CPD_VALID_EXTRAV_AR]    Script Date: 06/29/2010 16:19:23 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [scpd].[SP_CPD_VALID_EXTRAV_AR]
	@NR_AR [varchar](30),
	@CD_EMBALA_STATUS [int],
	@CD_STATUS_SOLIC [int]
WITH EXECUTE AS CALLER
AS
--Verifica se Embalagem existe
SELECT EMBALA.CD_EMBALA
FROM CPD_EMBALA EMBALA
WHERE EMBALA.NR_AR = @NR_AR

--Verifica se Embalagem está no status informado
SELECT EMBALA.CD_EMBALA
FROM CPD_EMBALA EMBALA
WHERE EMBALA.NR_AR = @NR_AR AND
	  EMBALA.CD_EMBALA_STATUS = @CD_EMBALA_STATUS 

--Verifica se as solicitações da Embalagem estão no status informado
SELECT EMBALA.CD_EMBALA
FROM CPD_EMBALA EMBALA
		INNER JOIN CPD_CADERN CADERN ON EMBALA.CD_EMBALA = CADERN.CD_EMBALA
		INNER JOIN CPD_SOLIC SOLIC ON CADERN.NR_CADERN = SOLIC.NR_CADERN
WHERE EMBALA.NR_AR = @NR_AR AND
	  EMBALA.CD_EMBALA_STATUS = 10 AND
	  SOLIC.CD_STATUS_SOLIC = @CD_STATUS_SOLIC
GO
/****** Object:  StoredProcedure [scpd].[SP_CPD_LISTA_EMBALA]    Script Date: 06/29/2010 16:19:21 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [scpd].[SP_CPD_LISTA_EMBALA]
	@CD_EMBALA [int]
WITH EXECUTE AS CALLER
AS
DECLARE @vlr_caderneta     decimal(18,2),
		@PesoCaderneta	   decimal(18,2),
		@QtdCaderneta	   decimal(18,0)
	
   --Obtêm a quantidade de cadernetas na caixa
   set @QtdCaderneta = (select count(1) from CPD_CADERN where CD_EMBALA = @CD_EMBALA)

   --Obtêm o valor do parâmetro que guarda o valor da caderneta
   set @vlr_caderneta = (Select cast(VL_PARAM as decimal(18,2))
                          From CPD_PARAM
                         Where cd_param = 4)

   --Obtêm o valor do parâmetro que guarda o peso da caderneta
   set @PesoCaderneta = (Select cast(VL_PARAM as decimal(18,2))
                          From CPD_PARAM
                         Where cd_param = 8)
 
   --obtendo informações sobre a embalagem
   Select emb.cd_embala,
          emb.NR_AR,
          @QtdCaderneta * @vlr_caderneta + tp_emb.vl_embala as valor_embalagem,
          @PesoCaderneta * @QtdCaderneta + tp_emb.nr_peso as peso_embalagem,
          unid_entrg.EN_UNID_ENTRG as 'Endereco',
		  unid_entrg.NM_BAIRRO as 'Bairro',
          cast(unid_entrg.NR_CEP as varchar(15)) as 'CEP',
		  unid_entrg.CD_UNID,
		  unid_entrg.DS_UNID,
		  unid_entrg.CD_UNID_SUPTD,
		  unid_atend.CD_UNID as CD_UNID_ATEND,
		  unid_atend.DS_UNID as DS_UNID_ATEND,
		  mun.CD_MUN,
		  mun.NM_MUN as 'Municipio',
		  mun.SG_UF as 'UF',
		  @QtdCaderneta as 'QT_CADERN',		  
		  unid_suptd.DS_UNID AS DS_UNID_SUPTD,
		  unid_suptd.EN_UNID_ENTRG AS EN_UNID_ENTRG_SUPTD, 
          unid_suptd.NM_BAIRRO AS NM_BAIRRO_SUPTD,
		  unid_suptd.NR_CEP AS NR_CEP_SUPTD,
          mun_suptd.CD_MUN AS CD_MUN_SUPTD,
		  mun_suptd.NM_MUN AS NM_MUN_SUPTD,		
		  mun_suptd.SG_UF AS SG_UF_SUPTD,
		  (SELECT VL_PARAM FROM CPD_PARAM WHERE CD_PARAM = 10) AS CD_PASPRT, -- CÓDIGO DO PASSAPORTE DA TABELA DE PARÂMETROS
		  emb.CD_TP_AR
   From CPD_SOLIC solic
			Inner Join CPD_UNID_ENTRG unid_entrg
			   on solic.cd_unid = unid_entrg.cd_unid
			Inner Join CPD_MUN mun 
			   on unid_entrg.cd_mun = mun.cd_mun
			Left Join CPD_UNID_ENTRG unid_suptd
			   on unid_entrg.CD_UNID_SUPTD = unid_suptd.CD_UNID_ENTRG
		    Left Join CPD_MUN mun_suptd
			   on unid_suptd.CD_MUN = mun_suptd.CD_MUN
			Inner Join CPD_UNID_ENTRG unid_atend
			   on solic.cd_unid_atend = unid_atend.cd_unid
			Inner Join CPD_CADERN cadern
			   on solic.nr_cadern = cadern.nr_cadern
			Inner Join  CPD_EMBALA emb
			   on cadern.cd_embala = emb.cd_embala
			   and cadern.cd_embala = @CD_EMBALA
			Inner Join CPD_TP_EMBALA tp_emb
			   on emb.cd_tp_embala = tp_emb.cd_tp_embala
   group by emb.cd_embala,
            emb.NR_AR,
			tp_emb.vl_embala,
			tp_emb.nr_peso,
            unid_entrg.EN_UNID_ENTRG,
		    unid_entrg.NM_BAIRRO,
            unid_entrg.NR_CEP,
            unid_entrg.CD_UNID,
		    unid_entrg.DS_UNID,
			unid_entrg.CD_UNID_SUPTD,
		    unid_atend.CD_UNID,
		    unid_atend.DS_UNID,
		    mun.CD_MUN,
		    mun.NM_MUN,
		    mun.SG_UF,
			unid_suptd.DS_UNID,
		    unid_suptd.EN_UNID_ENTRG, 
            unid_suptd.NM_BAIRRO,
		    unid_suptd.NR_CEP,
			mun_suptd.CD_MUN,
		    mun_suptd.NM_MUN,
		    mun_suptd.SG_UF,
			emb.CD_TP_AR
GO
/****** Object:  StoredProcedure [scpd].[SP_CPD_LISTA_VEICUL_EMBALA]    Script Date: 06/29/2010 16:19:22 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [scpd].[SP_CPD_LISTA_VEICUL_EMBALA]
	@CD_VEICULO [int]
WITH EXECUTE AS CALLER
AS
SELECT Veiculo.CD_VEICUL,
	   Embalagem.CD_EMBALA,
       DS_VEICUL,
       TX_PLACA,
       NR_AR

From CPD_VEICUL Veiculo
inner join CPD_EMBALA Embalagem on Veiculo.CD_VEICUL = Embalagem.CD_VEICUL

where 
     Veiculo.CD_VEICUL = @CD_VEICULO
GO
/****** Object:  StoredProcedure [scpd].[SP_CPD_ALTER_STATUS_SOLIC_EMBALA_VEICUL]    Script Date: 06/29/2010 16:19:20 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [scpd].[SP_CPD_ALTER_STATUS_SOLIC_EMBALA_VEICUL]
	@CD_STATUS_SOLIC [smallint],
	@CD_VEICULO [int],
	@CD_USUAR_LOGADO [int],
	@CD_ESTAC [int]
WITH EXECUTE AS CALLER
AS
-- ALTERA STATUS SOLICITACAO AO SER VINCULADA UMA EMBALAGEM A UM VEICULO (Expedicao)
-- E AO SER DESVINCULADA UMA EMBALAGEM A UM VEICULO
	
   UPDATE CPD_SOLIC 
	  SET CD_STATUS_SOLIC = @CD_STATUS_SOLIC,
		  CD_ESTAC =  @CD_ESTAC ,  
		  CD_USUAR = @CD_USUAR_LOGADO
	   from CPD_EMBALA Embalagem
		    inner join CPD_CADERN Caderneta on Embalagem.CD_EMBALA = Caderneta.CD_EMBALA
		    inner join CPD_SOLIC Solicitacao on Caderneta.NR_CADERN = Solicitacao.NR_CADERN
	   Where Embalagem.CD_Veicul = 	@CD_VEICULO
GO
/****** Object:  StoredProcedure [scpd].[SP_CPD_ALTER_EMBALA_VEICUL_NULL]    Script Date: 06/29/2010 16:19:19 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [scpd].[SP_CPD_ALTER_EMBALA_VEICUL_NULL]
	@CD_VEICULO [int]
WITH EXECUTE AS CALLER
AS
UPDATE CPD_EMBALA 
	  SET  CD_VEICUL = NULL 
	  WHERE CD_VEICUL = @CD_VEICULO
GO
/****** Object:  StoredProcedure [scpd].[SP_CPD_ALTERA_SOLIC_RECEB]    Script Date: 06/29/2010 16:19:20 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [scpd].[SP_CPD_ALTERA_SOLIC_RECEB]
	@NR_AR [varchar](30)
WITH EXECUTE AS CALLER
AS
UPDATE
	CPD_SOLIC
SET
	CPD_SOLIC.CD_STATUS_SOLIC = 80 -- Recebido pela DPF
FROM
	CPD_EMBALA
		INNER JOIN CPD_CADERN ON CPD_EMBALA.CD_EMBALA = CPD_CADERN.CD_EMBALA
		INNER JOIN CPD_SOLIC ON CPD_CADERN.NR_CADERN = CPD_SOLIC.NR_CADERN
WHERE
	CPD_EMBALA.NR_AR = @NR_AR
GO
/****** Object:  StoredProcedure [scpd].[SP_CPD_REL_QD_CADERN_COFRE]    Script Date: 06/29/2010 16:19:23 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [scpd].[SP_CPD_REL_QD_CADERN_COFRE]
WITH EXECUTE AS CALLER
AS
DECLARE @DATA AS DATETIME
SET @DATA = GETDATE()

UPDATE
	CPD_EMBALA
SET
	DT_IMPRES_COFRE = @DATA
WHERE
	DT_ARMAZ_COFRE IS NOT NULL
AND	DT_IMPRES_COFRE IS NULL

SELECT
	CPD_CADERN.TX_OP,
	CAST(CAST(COUNT(1) AS NUMERIC(18,3)) / 1000 AS NUMERIC(18,3)) AS QD_CADERN,
	@DATA as DT_ATUAL,
	(SELECT VL_PARAM FROM CPD_PARAM WHERE CD_PARAM = 10) AS CD_PASPRT -- CÓDIGO DO PASSAPORTE DA TABELA DE PARÂMETROS
FROM
	CPD_EMBALA
	INNER JOIN CPD_CADERN ON CPD_EMBALA.CD_EMBALA = CPD_CADERN.CD_EMBALA
WHERE
	CAST(convert(datetime, CPD_EMBALA.DT_IMPRES_COFRE,  103) AS VARCHAR(11)) = CAST(convert(datetime, @DATA,  103) AS VARCHAR(11)) AND
	CPD_EMBALA.DT_ARMAZ_COFRE IS NOT NULL
GROUP BY 
	CPD_CADERN.TX_OP
GO
/****** Object:  StoredProcedure [scpd].[SP_CPD_LISTA_INFORM_EMBALA_S_NF]    Script Date: 06/29/2010 16:19:21 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [scpd].[SP_CPD_LISTA_INFORM_EMBALA_S_NF]
WITH EXECUTE AS CALLER
AS
DECLARE @PesoCaderneta decimal(18,2),
        @ValorCaderneta     decimal(18,2)

	/* obtendo o valor do parâmetro que guarda o valor da caderneta */
	set @ValorCaderneta = ( Select cast( VL_PARAM as decimal(18,2 ) )
                           From CPD_PARAM
                          Where cd_param = 4 )

	set @PesoCaderneta = ( Select cast( VL_PARAM as decimal(18,2 ) )
                           From CPD_PARAM
                          Where cd_param = 8 )

SELECT
	CPD_EMBALA.CD_EMBALA,
	CPD_EMBALA.NR_AR,
	CPD_TP_EMBALA.DS_TP_EMBALA,
	CPD_UNID_ENTRG.DS_UNID,
	CPD_UNID_ENTRG.CD_UNID,
	'R$ ' + cast((COUNT(1) * @ValorCaderneta) + CPD_TP_EMBALA.VL_EMBALA as nvarchar) AS valor_embalagem,
	cast((COUNT(1) * @PesoCaderneta) + CPD_TP_EMBALA.NR_PESO as nvarchar) + ' Kg' AS peso_embalagem,
	COUNT(1) AS QD_CADERN_EMBALA

FROM

	CPD_EMBALA
	INNER JOIN CPD_TP_EMBALA ON CPD_EMBALA.CD_TP_EMBALA = CPD_TP_EMBALA.CD_TP_EMBALA
	INNER JOIN CPD_CADERN ON CPD_CADERN.CD_EMBALA = CPD_EMBALA.CD_EMBALA
	INNER JOIN CPD_SOLIC ON CPD_SOLIC.NR_CADERN = CPD_CADERN.NR_CADERN
	INNER JOIN CPD_UNID_ENTRG ON CPD_UNID_ENTRG.CD_UNID = CPD_SOLIC.CD_UNID

WHERE CPD_EMBALA.CD_NF is null 
        and CPD_EMBALA.DT_ARMAZ_COFRE is not null

GROUP BY
	CPD_EMBALA.CD_EMBALA,
	CPD_EMBALA.NR_AR,
	CPD_TP_EMBALA.DS_TP_EMBALA,
	CPD_UNID_ENTRG.DS_UNID,
	CPD_TP_EMBALA.VL_EMBALA,
	CPD_TP_EMBALA.NR_PESO,
	CPD_UNID_ENTRG.CD_UNID


ORDER BY CPD_UNID_ENTRG.DS_UNID
GO
/****** Object:  StoredProcedure [scpd].[SP_CPD_LISTA_EMBALA_VEICUL]    Script Date: 06/29/2010 16:19:21 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [scpd].[SP_CPD_LISTA_EMBALA_VEICUL]
	@TX_PLACA [varchar](7) = '',
	@NR_AR [varchar](30) = ''
WITH EXECUTE AS CALLER
AS
select	
       EMBALAGEM.cd_embala,
	   EMBALAGEM.nr_ar,
       VEICULO.ds_veicul, 
	   VEICULO.tx_placa,
	   VEICULO.CD_VEICUL,
	   VEICULO.DT_IMPRES

from   cpd_embala EMBALAGEM
       inner join cpd_veicul VEICULO on VEICULO.cd_veicul = EMBALAGEM.cd_veicul
where 
		(VEICULO.tx_placa = @TX_PLACA AND EMBALAGEM.nr_ar = @NR_AR) OR
		(VEICULO.tx_placa = @TX_PLACA AND @NR_AR = '') OR
		(EMBALAGEM.nr_ar = @NR_AR AND @TX_PLACA = '')
order by  VEICULO.DT_IMPRES,  VEICULO.ds_veicul
GO
/****** Object:  StoredProcedure [scpd].[SP_CPD_REL_ENTR_SAIDA_MATER]    Script Date: 06/29/2010 16:19:22 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [scpd].[SP_CPD_REL_ENTR_SAIDA_MATER]
	@DS_VEICUL [varchar](100),
	@TX_PLACA [char](7)
WITH EXECUTE AS CALLER
AS
Select count(distinct embala.nr_ar) as 'QtdAr',
		count(distinct caderneta.nr_cadern) as 'QtdCadern',
        veicul.Ds_Veicul,
	    veicul.Tx_placa,	   
        convert(varchar(10), getdate(), 103) as 'Dt_Autorizacao'
 From CPD_EMBALA embala       
			Inner Join CPD_VEICUL veicul
					On embala.Cd_Veicul = veicul.Cd_Veicul  
			Inner Join cpd_cadern caderneta 
					On embala.cd_embala = caderneta.cd_embala   
 where veicul.Ds_Veicul LIKE @DS_VEICUL and
       veicul.Tx_Placa LIKE @TX_PLACA
 group by veicul.Ds_Veicul, veicul.Tx_placa
GO
/****** Object:  StoredProcedure [scpd].[SP_CPD_LISTA_EMBALA_PRONTO_COFRE]    Script Date: 06/29/2010 16:19:21 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [scpd].[SP_CPD_LISTA_EMBALA_PRONTO_COFRE]
WITH EXECUTE AS CALLER
AS
SELECT
	ROW_NUMBER() OVER (ORDER BY [NR_AR]) AS SEQUENCIAL,
	CD_EMBALA, NR_AR
FROM
	CPD_EMBALA
WHERE
	DT_ARMAZ_COFRE IS NULL
ORDER BY NR_AR
GO
/****** Object:  StoredProcedure [scpd].[SP_CPD_LISTA_DADOS_NOVO_AR]    Script Date: 06/29/2010 16:19:21 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [scpd].[SP_CPD_LISTA_DADOS_NOVO_AR]
	@CD_EMBALA [decimal](16, 0)
WITH EXECUTE AS CALLER
AS
SELECT CPD_SOLIC.NR_PROTC AS 'SEQSOLIC',
	   CPD_CADERN.NR_CADERN AS 'NUMPASSAPORTE',
	   CONVERT(VARCHAR(8), CPD_EMBALA_HIST_STATUS.DT_ALTERA, 112) AS 'DATAHORANOVAREMESSA',
	   CPD_EMBALA_HIST_STATUS.NR_AR_NOVO AS 'NUMREMESSANOVA',
	   CPD_EMBALA_HIST_STATUS.NR_AR_ANTIGO AS 'NUMREMESSAANTIGA'
  FROM CPD_EMBALA
		INNER JOIN CPD_CADERN ON CPD_EMBALA.CD_EMBALA = CPD_CADERN.CD_EMBALA
		INNER JOIN CPD_EMBALA_HIST_STATUS ON CPD_EMBALA.NR_AR = CPD_EMBALA_HIST_STATUS.NR_AR_NOVO
        INNER JOIN CPD_SOLIC ON CPD_CADERN.NR_CADERN = CPD_SOLIC.NR_CADERN
 WHERE  CPD_EMBALA.CD_EMBALA = @CD_EMBALA
GO
/****** Object:  StoredProcedure [scpd].[SP_CPD_EXTRAV_AR]    Script Date: 06/29/2010 16:19:20 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [scpd].[SP_CPD_EXTRAV_AR]
	@CD_CADERN_STATUS [int],
	@CD_EMBALA_STATUS [int],
	@NR_AR [varchar](30),
	@CD_USUAR [int],
	@CD_ESTAC [int]
WITH EXECUTE AS CALLER
AS
UPDATE CPD_CADERN
	SET CD_CADERN_STATUS = @CD_CADERN_STATUS
FROM CPD_EMBALA EMBALA
	INNER JOIN CPD_CADERN CADERN
		ON EMBALA.CD_EMBALA = CADERN.CD_EMBALA AND
		   EMBALA.NR_AR = @NR_AR

UPDATE CPD_EMBALA
	SET CD_EMBALA_STATUS = @CD_EMBALA_STATUS,
		CD_USUAR = @CD_USUAR,
        CD_ESTAC = @CD_ESTAC
FROM CPD_CADERN CADERN
WHERE NR_AR = @NR_AR
GO
/****** Object:  StoredProcedure [scpd].[SP_CPD_LISTA_SOLIC_EXTRAV]    Script Date: 06/29/2010 16:19:22 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [scpd].[SP_CPD_LISTA_SOLIC_EXTRAV]
	@nr_ar [varchar](30)
WITH EXECUTE AS CALLER
AS
SELECT SOLIC.nr_protc  as 'SEQSOLIC',
       SOLIC.nr_cadern as 'NUMPASSAPORTE', 
       EMBALA.NR_AR  as 'NUMREMESSA',
	   convert(varchar(8), getdate(), 112) + replace(convert(varchar(8), getdate(), 112), ':', '')  as 'DATAHORAEXTRAVIO'
FROM CPD_SOLIC SOLIC
		INNER JOIN CPD_CADERN CADERN
			 ON SOLIC.NR_CADERN = CADERN.NR_CADERN
		INNER JOIN CPD_EMBALA EMBALA
			 ON CADERN.CD_EMBALA = EMBALA.CD_EMBALA
WHERE
  EMBALA.NR_AR = @nr_ar
GO
/****** Object:  StoredProcedure [scpd].[SP_CPD_LISTA_EMBALA_STATUS]    Script Date: 06/29/2010 16:19:21 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [scpd].[SP_CPD_LISTA_EMBALA_STATUS]
	@CD_VEICULO [int] = 0,
	@CD_EMBALA_STATUS [int]
WITH EXECUTE AS CALLER
AS
SELECT Embalagem.CD_EMBALA,
       Embalagem.NR_AR

From  
       CPD_EMBALA Embalagem 

where 
      Embalagem.CD_EMBALA_STATUS = @CD_EMBALA_STATUS and
	  Embalagem.CD_NF is not null and
      (Embalagem.CD_VEICUL is null or Embalagem.CD_VEICUL = @CD_VEICULO)
GO
/****** Object:  StoredProcedure [scpd].[SP_CPD_DADOS_CADERN_DEVOL]    Script Date: 06/29/2010 16:19:20 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [scpd].[SP_CPD_DADOS_CADERN_DEVOL]
	@NR_CADERN [char](8)
WITH EXECUTE AS CALLER
AS
SELECT SOLIC.nr_protc  as 'SEQSOLIC',
       SOLIC.nr_cadern as 'NUMPASSAPORTE', 
       EMBALA.NR_AR as 'NUMREMESSA',
	   convert(varchar(8), getdate(), 112) + replace(convert(varchar(8), getdate(), 108), ':', '') as 'DATAHORADEVOLUCAO'
FROM CPD_CADERN CADERN
		INNER JOIN CPD_SOLIC SOLIC
			 ON CADERN.NR_CADERN = SOLIC.NR_CADERN
		INNER JOIN CPD_EMBALA EMBALA
			 ON CADERN.CD_EMBALA = EMBALA.CD_EMBALA
WHERE
  CADERN.NR_CADERN = @NR_CADERN
GO
/****** Object:  StoredProcedure [scpd].[SP_CPD_LISTA_CADERN_EMBALA]    Script Date: 06/29/2010 16:19:21 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [scpd].[SP_CPD_LISTA_CADERN_EMBALA]
	@NR_AR [varchar](30)
WITH EXECUTE AS CALLER
AS
SELECT CPD_LOTE_SOLIC_USUAR.TP_NATURZ_ENTRG, 
       CPD_UNID_ENTRG.DS_UNID,
	   CPD_SOLIC.NR_PROTC,
	   CPD_CADERN.NR_CADERN,
	   CPD_EMBALA.CD_EMBALA 
  FROM CPD_EMBALA
		INNER JOIN CPD_CADERN ON CPD_EMBALA.CD_EMBALA = CPD_CADERN.CD_EMBALA
        INNER JOIN CPD_SOLIC ON CPD_CADERN.NR_CADERN = CPD_SOLIC.NR_CADERN
		INNER JOIN CPD_LOTE_SOLIC_USUAR ON CPD_SOLIC.CD_LOTE = CPD_LOTE_SOLIC_USUAR.CD_LOTE
		INNER JOIN CPD_UNID_ENTRG ON CPD_LOTE_SOLIC_USUAR.CD_LOCAL_EXP = CPD_UNID_ENTRG.CD_UNID
 WHERE  CPD_EMBALA.NR_AR = @NR_AR
 ORDER BY CPD_CADERN.SQ_CADERN
GO
/****** Object:  StoredProcedure [scpd].[SP_CPD_REL_SEG_VIA_QD_CADERN_COFRE]    Script Date: 06/29/2010 16:19:23 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [scpd].[SP_CPD_REL_SEG_VIA_QD_CADERN_COFRE]
	@DataArmazenagemCofre [datetime]
WITH EXECUTE AS CALLER
AS
DECLARE @DATA AS DATETIME
SET @DATA = GETDATE()

UPDATE
	CPD_EMBALA
SET
	DT_IMPRES_COFRE = @DATA
WHERE
	convert(varchar(8), CPD_EMBALA.DT_ARMAZ_COFRE, 112) = convert(varchar(8), @DataArmazenagemCofre, 112)
	AND	DT_IMPRES_COFRE IS NULL

SELECT
	CPD_CADERN.TX_OP,
	CAST(CAST(COUNT(1) AS NUMERIC(18,3)) / 1000 AS NUMERIC(18,3)) AS QD_CADERN,
	@DATA as DT_ATUAL,
	(SELECT VL_PARAM FROM CPD_PARAM WHERE CD_PARAM = 10) AS CD_PASPRT -- CÓDIGO DO PASSAPORTE DA TABELA DE PARÂMETROS
FROM
	CPD_EMBALA
	INNER JOIN CPD_CADERN ON CPD_EMBALA.CD_EMBALA = CPD_CADERN.CD_EMBALA
WHERE
	convert(varchar(8), CPD_EMBALA.DT_ARMAZ_COFRE, 112) = convert(varchar(8), @DataArmazenagemCofre, 112)
GROUP BY 
	CPD_CADERN.TX_OP
GO
/****** Object:  StoredProcedure [scpd].[SP_CPD_LISTA_HIST_EMBALA]    Script Date: 06/29/2010 16:19:21 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [scpd].[SP_CPD_LISTA_HIST_EMBALA]
	@NR_AR [varchar](30)
WITH EXECUTE AS CALLER
AS
DECLARE @CD_EMBALA DECIMAL(12,0)

SET @CD_EMBALA = (SELECT TOP 1 EMB.CD_EMBALA
			      FROM CPD_EMBALA EMB
			      	   LEFT JOIN CPD_EMBALA_HIST_STATUS HIST ON HIST.CD_EMBALA = EMB.CD_EMBALA
			      WHERE EMB.NR_AR = @NR_AR OR HIST.NR_AR_ANTIGO = @NR_AR
                 )

SELECT EMB.NR_AR, EMB.CD_EMBALA, HIST.NR_AR_NOVO, 
       HIST.NR_AR_ANTIGO, STATUS.DS_EMBALA_STATUS, HIST.DT_ALTERA,
       USUAR.NM_USUAR, ESTAC.DS_ESTAC		                   
FROM CPD_EMBALA EMB
      INNER JOIN CPD_EMBALA_HIST_STATUS HIST ON EMB.CD_EMBALA = HIST.CD_EMBALA
	  INNER JOIN CPD_EMBALA_STATUS STATUS ON EMB.CD_EMBALA_STATUS = STATUS.CD_EMBALA_STATUS
      INNER JOIN CPD_USUAR USUAR ON HIST.CD_USUAR = USUAR.CD_USUAR
	  INNER JOIN CPD_ESTAC ESTAC ON HIST.CD_ESTAC = ESTAC.CD_ESTAC
WHERE EMB.CD_EMBALA = @CD_EMBALA
ORDER BY HIST.DT_ALTERA DESC
GO
/****** Object:  StoredProcedure [scpd].[SP_CPD_LISTA_POSTG]    Script Date: 06/29/2010 16:19:22 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [scpd].[SP_CPD_LISTA_POSTG]
	@NR_AR [varchar](30) = NULL
WITH EXECUTE AS CALLER
AS
SELECT RPAR.CD_RETORN_POSTAG_AR, 
	   RPAR.CD_EMBALA, 
	   RPAR.CD_STATUS_POSTAG, 
       RPAR.DT_POSTAG, 
       RPAR.TX_HORA_POSTG, 
       RPAR.DS_ERRO,
	   E.NR_AR,
       SP.DS_STATUS_POSTAG
FROM CPD_RETORN_POSTAG_AR AS RPAR
INNER JOIN CPD_EMBALA AS E 
	       ON RPAR.CD_EMBALA = E.CD_EMBALA
INNER JOIN CPD_STATUS_POSTAG AS SP
		   ON RPAR.CD_STATUS_POSTAG = SP.CD_STATUS_POSTAG
INNER JOIN (SELECT CD_EMBALA, MAX(substring(DT_POSTAG, 7, 4) + substring(DT_POSTAG, 4, 2) + substring(DT_POSTAG, 1, 2) + substring(TX_HORA_POSTG, 1, 2) + substring(TX_HORA_POSTG, 4, 2)  + substring(TX_HORA_POSTG, 7, 2)) AS DT_HORA_POSTAG 
			FROM CPD_RETORN_POSTAG_AR
			GROUP BY CD_EMBALA) AS ULT_POSTAG
	  ON RPAR.CD_EMBALA = ULT_POSTAG.CD_EMBALA AND 
		 substring(RPAR.DT_POSTAG, 7, 4) + substring(RPAR.DT_POSTAG, 4, 2) + substring(RPAR.DT_POSTAG, 1, 2) + substring(RPAR.TX_HORA_POSTG, 1, 2) + substring(RPAR.TX_HORA_POSTG, 4, 2)  + substring(RPAR.TX_HORA_POSTG, 7, 2) = ULT_POSTAG.DT_HORA_POSTAG
WHERE E.NR_AR = @NR_AR OR (@NR_AR IS NULL AND
	  RPAR.CD_STATUS_POSTAG = 0)
ORDER BY E.NR_AR
GO
/****** Object:  StoredProcedure [scpd].[SP_CPD_LISTA_RASTR_ATIV_AR]    Script Date: 06/29/2010 16:19:22 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [scpd].[SP_CPD_LISTA_RASTR_ATIV_AR]
	@NR_AR [varchar](30) = NULL
WITH EXECUTE AS CALLER
AS
SELECT RAA.CD_RASTR_ATIV_AR, 
	   RAA.CD_EMBALA, 
	   RAA.CD_STATUS_RASTR_ATIV_AR, 
       RAA.DT_ATUAL_SRO, 
       RAA.TX_HORA_ATUAL_SRO,
	   RAA.DS_STATUS_OBJ_RASTR, 
       RAA.TX_OBS,
	   E.NR_AR,
       SRAA.DS_STATUS_RASTR_ATIV_AR,
       substring(RAA.DT_ATUAL_SRO, 7, 4) + substring(RAA.DT_ATUAL_SRO, 4, 2) + substring(RAA.DT_ATUAL_SRO, 1, 2) + substring(RAA.TX_HORA_ATUAL_SRO, 1, 2) + substring(RAA.TX_HORA_ATUAL_SRO, 4, 2)  + substring(RAA.TX_HORA_ATUAL_SRO, 7, 2) AS DT_RASTR
FROM CPD_RASTR_ATIV_AR AS RAA
INNER JOIN CPD_EMBALA AS E 
       ON RAA.CD_EMBALA = E.CD_EMBALA
INNER JOIN CPD_STATUS_RASTR_ATIV_AR AS SRAA
	   ON RAA.CD_STATUS_RASTR_ATIV_AR = SRAA.CD_STATUS_RASTR_ATIV_AR
WHERE E.NR_AR = @NR_AR
ORDER BY DT_RASTR DESC
GO
/****** Object:  StoredProcedure [scpd].[SP_CPD_LIMPEZA_DADOS_SOLIC]    Script Date: 06/29/2010 16:19:21 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [scpd].[SP_CPD_LIMPEZA_DADOS_SOLIC]
WITH EXECUTE AS CALLER
AS
DECLARE
     
  @msg_error        varchar(8000),  -- armazena a mensagem de erro
  @v_diff_dias      int,            -- diferença entre a data de cadastro dos dados na tabela TESTEMUNHO e o "dia de hoje"
  @v_dias_limpeza   int,            -- parametro que define a quantidade de dias para limpar a base (cpd_param)
  @dt_cad           datetime,       -- 
  @nr_protc         numeric(16,0),  -- 
  @nr_cadern        char(8),        -- 
  @tp_naturz_entrg  char(1),        -- 
  @cd_pauta         int,            -- 
  @cd_embala        numeric(12,0),  -- 
  @cd_lote          numeric(12,0),  -- 
  @nr_solic_pauta   int,            -- 
  @nr_solic_embala  int,            --
  @nr_solic_lote    int,            --
  @nr_embala_veicul int,            -- 
  @dt_limpeza       datetime,       -- 
  @cd_veicul        int             --   

  /* Selecionando o parametro que define a quantidade 
     de dias para limpar a base */
  SELECT @v_dias_limpeza = VL_PARAM FROM CPD_PARAM WHERE CD_PARAM = 13

  DECLARE C_LIMP_SOLIC CURSOR FOR 
  SELECT t.dt_limpeza, t.dt_cad, t.nr_protc, t.nr_cadern, t.tp_naturz_entrg, s.cd_pauta, c.cd_embala, s.cd_lote
  FROM cpd_testemunho t, CPD_SOLIC s, CPD_CADERN c
  WHERE	t.nr_protc = s.nr_protc and
        s.nr_cadern = c.nr_cadern
        
  OPEN C_LIMP_SOLIC

  FETCH NEXT FROM C_LIMP_SOLIC 
  INTO @dt_limpeza, @dt_cad, @nr_protc, @nr_cadern, @tp_naturz_entrg, @cd_pauta, @cd_embala, @cd_lote
  
  WHILE @@FETCH_STATUS = 0
    BEGIN
      set @msg_error = null
      
      SET @v_diff_dias = (select DATEDIFF (day, getdate(), @DT_CAD))
      
      IF ((@dt_limpeza is null) and (@v_diff_dias >= @v_dias_limpeza))
        BEGIN TRY
		  BEGIN TRAN 
         
          delete cpd_cadern_hist_status where nr_cadern = @nr_cadern
		  delete cpd_solic_hist_status where nr_protc = @nr_protc
          delete cpd_solic where nr_protc = @nr_protc
          delete cpd_cadern where nr_cadern = @nr_cadern
          
          if @tp_naturz_entrg = 'E'
            begin
              set @nr_solic_pauta = (select count(*) from CPD_SOLIC where cd_pauta = @cd_pauta)
              if @nr_solic_pauta = 0
                begin
				  delete cpd_pauta_distr_doc where cd_pauta = @cd_pauta
                  delete cpd_pauta_distr where cd_pauta = @cd_pauta                  
                end
            end
          
		  if (@tp_naturz_entrg='R') OR (@tp_naturz_entrg='U')
            begin
              set @nr_solic_embala = (select count(*) from CPD_CADERN where cd_embala = @cd_embala)
              if @nr_solic_embala = 0
                begin
				  delete cpd_embala_hist_status where cd_embala = @cd_embala
                  delete cpd_embala where cd_embala = @cd_embala                                    
                end

			  set @cd_veicul = (select cd_veicul from CPD_EMBALA where cd_embala = @cd_embala)
			  set @nr_embala_veicul = (select count(*) from CPD_EMBALA where cd_veicul = @cd_veicul)
			  if @nr_embala_veicul = 0
				begin
				  delete CPD_VEICUL where cd_veicul = @cd_veicul            
			    end
              end
          
			  set @nr_solic_lote = (select count(*) from CPD_SOLIC where cd_lote = @cd_lote)
			  if @nr_solic_lote = 0
				begin
				  delete cpd_lote_solic_usuar_hist where cd_lote = @cd_lote
				  delete cpd_lote_solic_usuar where cd_lote = @cd_lote             
			    end
                    
          update dbo.CPD_TESTEMUNHO
          set DT_LIMPEZA = getdate()
          where NR_PROTC = @nr_protc
          
		  COMMIT
        END TRY
        BEGIN CATCH
          ROLLBACK
          set @msg_error = 'Erro na limpeza dos dados da solicitação - protocolo número: ' + convert(varchar(16),@nr_protc)
          insert into cpd_aviso (cd_perfil, ds_aviso, dt_aviso)
          values (100, @msg_error, getdate())        
        END CATCH
        FETCH NEXT FROM C_LIMP_SOLIC 
        INTO @dt_limpeza, @dt_cad, @nr_protc, @nr_cadern, @tp_naturz_entrg, @cd_pauta, @cd_embala, @cd_lote
    END    
    CLOSE C_LIMP_SOLIC
    DEALLOCATE C_LIMP_SOLIC
GO
/****** Object:  StoredProcedure [scpd].[SP_CPD_LISTA_MUN]    Script Date: 06/29/2010 16:19:22 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [scpd].[SP_CPD_LISTA_MUN]
	@NM_MUN [varchar](40) = '',
	@SG_UF [char](3) = '',
	@CD_PAIS [int] = 0
WITH EXECUTE AS CALLER
AS
SELECT
    MUN.CD_MUN,
	MUN.NM_MUN,
    MUN.SG_UF,
	MUN.IN_TEMPO_SAIDA,
	GRP.CD_GRP,
	GRP.DS_GRP,
	PAIS.CD_PAIS,
	PAIS.DS_PAIS
FROM
	CPD_MUN MUN
		INNER JOIN CPD_PAIS PAIS ON MUN.CD_PAIS = PAIS.CD_PAIS
		INNER JOIN CPD_GRP_SEDEX GRP ON MUN.CD_GRP = GRP.CD_GRP
WHERE
	(MUN.NM_MUN LIKE '%' + @NM_MUN + '%' OR @NM_MUN = '') AND
	(MUN.SG_UF LIKE '%' + @SG_UF + '%' OR @SG_UF = '') AND
	(PAIS.CD_PAIS = @CD_PAIS OR @CD_PAIS = 0)
ORDER BY MUN.NM_MUN
GO
/****** Object:  StoredProcedure [scpd].[SP_CPD_INS_SOLIC]    Script Date: 06/29/2010 16:19:20 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [scpd].[SP_CPD_INS_SOLIC]
	@NR_PROTC [numeric](16, 0),
	@CD_UNID [varchar](13),
	@CD_UNID_ATEND [varchar](13),
	@IN_EXCED [bit],
	@CD_TP_DOC [int],
	@NM_IDENT_PRIMAR [varchar](30),
	@NM_IDENT_SECND [varchar](30) = null,
	@TX_SOBREN [varchar](30),
	@TX_NOME [varchar](30) = null,
	@DS_NACION [varchar](30),
	@SX_NOME [char](1),
	@DS_NATURL [varchar](55),
	@DT_EXP [datetime],
	@DT_VALID [datetime],
	@TX_LOCAL_EXP [varchar](20),
	@IM_FOTO1 [image],
	@IM_FOTO2 [image],
	@TP_NATURZ_ENTREG [char](1),
	@DT_NASC [varchar](10),
	@NR_REMES [varchar](40),
	@CD_PAIS [tinyint],
	@NR_IDENT_CDADAO [decimal](16, 0) = null,
	@CD_ESTAC [int],
	@CD_ARQ [int],
	@EMOL_REAIS_OURO [decimal](11, 2),
	@EMOL_VALOR_LOCAL [decimal](11, 2),
	@MOEDA_LOCAL [char](3),
	@TEC [varchar](20),
	@DT_IMP [datetime],
	@NM_USUAR [varchar](200),
	@CARGO_USUAR [varchar](100),
	@OBS [varchar](500)
WITH EXECUTE AS CALLER
AS
DECLARE @Data_max_saida datetime       ,
        @param_extra    int            , --se regime de entrega for extraordinário
        @param_urgente  int            , --se regime de entrega for urgente
        @param_regul    int            , --se regime de entrega for regular
		@Tempo_Entrega_Local int

   /**********************/
   /* obtendo parâmetros */
   /**********************/
   SET @param_extra   = ( Select cast(vl_param as int) from CPD_PARAM where cd_param = 3 )
   SET @param_urgente = ( Select cast(vl_param as int) from CPD_PARAM where cd_param = 2 )
   SET @param_regul   = ( Select cast(vl_param as int) from CPD_PARAM where cd_param = 1 )
   SET @Tempo_Entrega_Local = (SELECT
									ISNULL(IN_TEMPO_SAIDA,2)
							   FROM
									CPD_MUN
									INNER JOIN CPD_UNID_ENTRG ON CPD_MUN.CD_MUN = CPD_UNID_ENTRG.CD_MUN
							   WHERE
									CPD_UNID_ENTRG.CD_UNID = @CD_UNID)

   /* setando DataMáxima de saida de acordo com data do arquivo */
   IF( @TP_NATURZ_ENTREG = 'E' )
   BEGIN

      SET @Data_max_saida = ( Select DateAdd( Hour, @param_extra, getdate() ) )

   END
   ELSE IF( @TP_NATURZ_ENTREG = 'R' )
   BEGIN

      SET @Data_max_saida = ( Select DateAdd( DAY, @param_regul - @Tempo_Entrega_Local, getdate() ) ) 

   END
   ELSE IF( @TP_NATURZ_ENTREG = 'U' )
   BEGIN 
   
      SET @Data_max_saida = ( Select DateAdd( DAY, @param_urgente - @Tempo_Entrega_Local, getdate() ) )

   END   

       INSERT INTO CPD_SOLIC( NR_PROTC, 
                             CD_UNID,
							 CD_UNID_ATEND, 
                             CD_USUAR, 
                             IN_EXCED, 
                             CD_TP_DOC,
							 NM_IDENT_PRIMAR,
							 NM_IDENT_SECND,
                             TX_SOBREN, 
                             TX_NOME, 
                             DS_NACION, 
                             SX_NOME, 
                             DS_NATURL, 
                             DT_EXP, 
                             DT_VALID,
						     TX_LOCAL_EXP,
                             IM_FOTO1,
                             IM_FOTO2, 
                             TP_NATURZ_ENTRG, 
                             CD_STATUS_SOLIC, 
                             CD_ARQ, 
                             CD_LOTE, 
                             CD_PAUTA, 
                             DT_MAX_SAIDA, 
                             DT_NASC, 
                             NR_REMES,
                             CD_PAIS,
							 NR_CADERN,
                             CD_ESTAC,
							 EMOL_REAIS_OURO,
							 EMOL_VALOR_LOCAL,
							 MOEDA_LOCAL,
							 TEC,
							 DT_IMP,
						     NM_USUAR,
							 CARGO_USUAR,
					         OBS     )
      VALUES( @NR_PROTC         ,
   	          @CD_UNID          ,
			  @CD_UNID_ATEND    ,
   	          null              , 
   	          @IN_EXCED         ,
   	          @CD_TP_DOC        ,
			  @NM_IDENT_PRIMAR  ,
			  @NM_IDENT_SECND   ,
   	          @TX_SOBREN        ,
   	          @TX_NOME          ,
   	          @DS_NACION        ,
   	          @SX_NOME          ,
   	          @DS_NATURL        ,
   	          @DT_EXP           ,
   	          @DT_VALID         ,
			  @TX_LOCAL_EXP     ,
   	          @IM_FOTO1         , 
   	          @IM_FOTO2         , 
   	          @TP_NATURZ_ENTREG ,
   	          10                , --@CD_STATUS_SOLIC inicialmente o status da solicitação é 10
              @CD_ARQ           ,
   	          null              , -- quando é inserida uma solicitação ainda não é conhecida a fila a qual a mesma pertecnce por isso @CD_FILA  é null
   	          null              , -- quando é inserida uma solicitação ainda não é conhecida a pauta a qual a mesma pertecnce por isso @CD_PAUTA é null
   	          @Data_max_saida   , --DATA MÁXIMNA DE SAIDA
   	          @DT_NASC          ,
   	          @NR_REMES         ,
              @CD_PAIS          ,
              null              ,
              @CD_ESTAC			,
			  @EMOL_REAIS_OURO	,
			  @EMOL_VALOR_LOCAL	,
			  @MOEDA_LOCAL		,
			  @TEC				,
			  @DT_IMP			,
			  @NM_USUAR			,
			  @CARGO_USUAR		,
			  @OBS	)
GO
/****** Object:  StoredProcedure [scpd].[SP_CPD_LISTA_LOCAL]    Script Date: 06/29/2010 16:19:21 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [scpd].[SP_CPD_LISTA_LOCAL]
	@CD_UNID [varchar](13) = NULL,
	@DS_UNID [varchar](45) = NULL,
	@SG_UF [char](2) = ''
WITH EXECUTE AS CALLER
AS
select 
	CD_UNID,
	DS_UNID,
	SG_UF
from 
	cpd_unid_entrg
       inner join cpd_mun on
			cpd_unid_entrg.cd_mun = cpd_mun.cd_mun
where 
	(CD_UNID like '%' + @CD_UNID + '%' or @CD_UNID is NULL)
and 
	(DS_UNID like '%' + @DS_UNID + '%' or @DS_UNID is NULL)
and 
	(SG_UF like @SG_UF or @SG_UF = '')
order by DS_UNID
GO
/****** Object:  StoredProcedure [scpd].[SP_CPD_LISTA_SUPTD]    Script Date: 06/29/2010 16:19:22 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [scpd].[SP_CPD_LISTA_SUPTD]
	@CD_UNID_ENTRG [varchar](13) = NULL,
	@SG_UF [char](2)
WITH EXECUTE AS CALLER
AS
select 
	CD_UNID_ENTRG,
	DS_UNID
from 
	cpd_unid_entrg
       inner join cpd_mun on
			cpd_unid_entrg.cd_mun = cpd_mun.cd_mun
where
	SG_UF like @SG_UF AND
	(NOT CD_UNID_ENTRG = @CD_UNID_ENTRG or @CD_UNID_ENTRG is null) AND
	IN_STATUS = 1
order by DS_UNID
GO
/****** Object:  StoredProcedure [scpd].[SP_CPD_ATUAL_OP]    Script Date: 06/29/2010 16:19:20 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [scpd].[SP_CPD_ATUAL_OP]
WITH EXECUTE AS CALLER
AS
-- Insere OP - CPD_OP
INSERT INTO CPD_OP 
	(TX_OP, IN_STATUS, DT_CAD_OP)
SELECT DISTINCT NUM_OP, 1, getdate() 
FROM SD4020 
WHERE NUM_OP NOT IN (SELECT TX_OP FROM CPD_OP)

-- Altera nome de material - CPD_MATER
UPDATE CPD_MATER
SET DS_MATER = DESC_ITEM
FROM SD4020
WHERE CONVERT(VARCHAR(16), CD_MATER) = COD_ITEM

-- Insere nome de material - CPD_MATER
INSERT INTO CPD_MATER 
	(CD_MATER, DS_MATER)
SELECT DISTINCT COD_ITEM, DESC_ITEM 
FROM SD4020 
WHERE COD_ITEM NOT IN (SELECT CONVERT(VARCHAR(16), CD_MATER) FROM CPD_MATER)

-- Insere Estoque - CPD_ESTOQU_GERAL
INSERT INTO CPD_ESTOQU_GERAL
	(CD_MATER, TX_OP, QT_MATER)
SELECT DISTINCT COD_ITEM, NUM_OP, (QTDORI_ITEM * 1000)
FROM SD4020
WHERE NOT EXISTS (SELECT CD_MATER, TX_OP
				  FROM CPD_ESTOQU_GERAL
				  WHERE	CPD_ESTOQU_GERAL.TX_OP = SD4020.NUM_OP AND
						CONVERT(VARCHAR(16), CPD_ESTOQU_GERAL.CD_MATER) = SD4020.COD_ITEM
				  )
GO
/****** Object:  StoredProcedure [scpd].[SP_CPD_VALID_PROTC_CADERN_IMPRES]    Script Date: 06/29/2010 16:19:23 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [scpd].[SP_CPD_VALID_PROTC_CADERN_IMPRES]
	@CD_PAUTA [int]
WITH EXECUTE AS CALLER
AS
SELECT COUNT(CPD_SOLIC.NR_PROTC)
FROM CPD_SOLIC
		INNER JOIN CPD_PAUTA_DISTR ON 
			CPD_SOLIC.CD_PAUTA = CPD_PAUTA_DISTR.CD_PAUTA
WHERE CPD_PAUTA_DISTR.CD_PAUTA = @CD_PAUTA AND
	  CPD_SOLIC.CD_STATUS_SOLIC = 40
GO
/****** Object:  StoredProcedure [scpd].[SP_CPD_LISTA_PAUTA]    Script Date: 06/29/2010 16:19:22 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [scpd].[SP_CPD_LISTA_PAUTA]
	@CD_PAUTA [int]
WITH EXECUTE AS CALLER
AS
SELECT	P.CD_PAUTA,
		U.NM_USUAR,
		P.DT_SOLIC
FROM	CPD_PAUTA_DISTR P
		INNER JOIN CPD_USUAR U ON P.CD_USUAR=U.CD_USUAR
WHERE	P.CD_PAUTA = @CD_PAUTA



SELECT	PDOC.NM_PESSOA_AUTOR,
		TDOCA.DS_TP_DOC_AUTOR + ' ' + PDOC.NR_DOC as NR_DOC
FROM	CPD_PAUTA_DISTR_DOC PDOC
			INNER JOIN CPD_TP_DOC_AUTOR  TDOCA
				ON PDOC.CD_TP_DOC_AUTOR = TDOCA.CD_TP_DOC_AUTOR
WHERE	PDOC.CD_PAUTA = @CD_PAUTA



EXEC SP_CPD_LISTA_PROTC @CD_PAUTA
GO
/****** Object:  StoredProcedure [scpd].[SP_CPD_REL_RECIBO_PASPRT_EXTRAO]    Script Date: 06/29/2010 16:19:23 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [scpd].[SP_CPD_REL_RECIBO_PASPRT_EXTRAO]
	@CD_PAUTA [int],
	@CD_STATUS_SOLIC [smallint]
WITH EXECUTE AS CALLER
AS
SELECT Solicitacao.NR_PROTC,
				   Solicitacao.TX_SOBREN,
				   Solicitacao.TX_NOME,
				   Solicitacao.NR_CADERN,
				   PautaDoc.NM_PESSOA_AUTOR,
				   PautaDoc.NR_DOC,
				   Solicitacao.CD_USUAR,
				   PautaDoc.NM_PESSOA_RETIR,
				   PautaDoc.NR_MATRIC_PESSOA_RETIR
			From  
				   CPD_SOLIC Solicitacao 
				   inner join CPD_PAUTA_DISTR Pauta on Pauta.CD_PAUTA = Solicitacao.CD_PAUTA
				   inner join CPD_PAUTA_DISTR_DOC PautaDoc on Pauta.CD_PAUTA = PautaDoc.CD_PAUTA 
			Where 
				  Solicitacao.CD_PAUTA = @CD_PAUTA 
				  and Solicitacao.CD_STATUS_SOLIC = @CD_STATUS_SOLIC
				  and Solicitacao.TP_NATURZ_ENTRG = 'E'


			SELECT 
				   CPD_CADERN.TX_OP,
				   COUNT(1) as TOTAL
			From  
				   CPD_SOLIC 
				   inner join CPD_CADERN ON CPD_SOLIC.NR_CADERN = CPD_CADERN.NR_CADERN
			Where 
				  CPD_SOLIC.CD_PAUTA = @CD_PAUTA 
				  and CPD_SOLIC.CD_STATUS_SOLIC = @CD_STATUS_SOLIC
				  and CPD_SOLIC.TP_NATURZ_ENTRG = 'E'
			GROUP BY CPD_CADERN.TX_OP
			ORDER BY CPD_CADERN.TX_OP
GO
/****** Object:  StoredProcedure [scpd].[SP_CPD_REL_QTD_PASSAP_PRODUZ]    Script Date: 06/29/2010 16:19:23 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [scpd].[SP_CPD_REL_QTD_PASSAP_PRODUZ]
	@DE [datetime],
	@ATE [datetime]
WITH EXECUTE AS CALLER
AS
SELECT Periodo, ISNULL(QtdPassSolicitados,0) AS QtdPassSolicitados, ISNULL(QtdPassProduzidos,0) AS QtdPassProduzidos,
	      ISNULL(QtdPassPerdidos,0) AS QtdPassPerdidos, PeriodoOrdena
   FROM(SELECT scpd.FN_CPD_FORMATAR_MES_EXTENSO(MONTH(DT_HIST), YEAR(DT_HIST)) as Periodo,
			   COUNT(distinct NR_PROTC) as QtdPassSolicitados,			   
			   NULL AS QtdPassProduzidos, 
			   NULL AS QtdPassPerdidos,
			   CAST(YEAR(DT_HIST) as varchar) + REPLICATE('0', 2 - LEN(MONTH(DT_HIST))) + CAST(MONTH(DT_HIST) as varchar) as PeriodoOrdena
		FROM
			(SELECT NR_PROTC, 
					MIN(DT_HIST) as DT_HIST
			 FROM CPD_SOLIC_HIST_STATUS
			 WHERE CD_STATUS_SOLIC = 10
			   AND CD_USUAR IS NULL
			 GROUP BY NR_PROTC
			) TabelaSolicitados
		WHERE CONVERT(varchar(8), DT_HIST, 112) >= CONVERT(varchar(8), @DE, 112)
			  AND CONVERT(varchar(8), DT_HIST, 112) <= CONVERT(varchar(8), @ATE, 112)    
		GROUP BY YEAR(DT_HIST), MONTH(DT_HIST) 

	   /**********************************************************************************/
	   UNION
	   /**********************************************************************************/

		SELECT scpd.FN_CPD_FORMATAR_MES_EXTENSO(MONTH(DT_HIST), YEAR(DT_HIST)) as Periodo,
			   NULL as QtdPassSolicitados,			   
			   COUNT(distinct NR_PROTC) AS QtdPassProduzidos, 
			   NULL AS QtdPassPerdidos,
			   CAST(YEAR(DT_HIST) as varchar) + REPLICATE('0', 2 - LEN(MONTH(DT_HIST))) + CAST(MONTH(DT_HIST) as varchar) as PeriodoOrdena
		FROM
			(SELECT NR_PROTC, 
					MAX(DT_HIST) as DT_HIST
			 FROM CPD_SOLIC_HIST_STATUS
					INNER JOIN CPD_CADERN ON CPD_SOLIC_HIST_STATUS.NR_CADERN = CPD_CADERN.NR_CADERN
			 WHERE CD_STATUS_SOLIC = 50 --Pronto-Remessa
				   AND NOT CD_CADERN_STATUS = 10 -- Caderneta Perdida
			 GROUP BY NR_PROTC
			) TabelaProduzidos
		WHERE CONVERT(varchar(8), DT_HIST, 112) >= CONVERT(varchar(8), @DE, 112)
			  AND CONVERT(varchar(8), DT_HIST, 112) <= CONVERT(varchar(8), @ATE, 112)   
		GROUP BY YEAR(DT_HIST), MONTH(DT_HIST)
                      
	   /**********************************************************************************/
	   UNION
	   /**********************************************************************************/

		SELECT scpd.FN_CPD_FORMATAR_MES_EXTENSO(MONTH(DT_HIST), YEAR(DT_HIST)) as Periodo, 
			   NULL as QtdPassSolicitados,			   
			   NULL AS QtdPassProduzidos, 
			   COUNT(distinct NR_CADERN)  AS QtdPassPerdidos,
			   CAST(YEAR(DT_HIST) as varchar) + REPLICATE('0', 2 - LEN(MONTH(DT_HIST))) + CAST(MONTH(DT_HIST) as varchar) as PeriodoOrdena
		FROM
			(SELECT NR_CADERN, 
					MIN(DT_ALTERA) as DT_HIST
			 FROM CPD_CADERN_HIST_STATUS
			 WHERE CD_CADERN_STATUS = 10 --Perdida
			 GROUP BY NR_CADERN
			) TabelaPerdidos
		WHERE CONVERT(varchar(8), DT_HIST, 112) >= CONVERT(varchar(8), @DE, 112)
			  AND CONVERT(varchar(8), DT_HIST, 112) <= CONVERT(varchar(8), @ATE, 112)   
		GROUP BY YEAR(DT_HIST), MONTH(DT_HIST)
        ) TABELA
    ORDER BY PeriodoOrdena
GO
/****** Object:  StoredProcedure [scpd].[SP_CPD_INS_RASTR_ATIV_AR]    Script Date: 06/29/2010 16:19:20 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [scpd].[SP_CPD_INS_RASTR_ATIV_AR]
	@CD_EMBALA [numeric](12, 0),
	@CD_STATUS_RASTR_ATIV_AR [numeric](2, 0),
	@DT_ATUAL_SRO [varchar](10),
	@TX_HORA_ATUAL_SRO [varchar](10),
	@DS_STATUS_OBJ_RASTR [varchar](50),
	@TX_OBS [varchar](255) = NULL
WITH EXECUTE AS CALLER
AS
INSERT INTO CPD_RASTR_ATIV_AR(CD_EMBALA, CD_STATUS_RASTR_ATIV_AR, DT_ATUAL_SRO, TX_HORA_ATUAL_SRO, DS_STATUS_OBJ_RASTR, TX_OBS)
  VALUES (@CD_EMBALA, @CD_STATUS_RASTR_ATIV_AR, @DT_ATUAL_SRO, @TX_HORA_ATUAL_SRO, @DS_STATUS_OBJ_RASTR, @TX_OBS)
GO
/****** Object:  StoredProcedure [scpd].[SP_CPD_INS_ARQ_SOLIC]    Script Date: 06/29/2010 16:19:20 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [scpd].[SP_CPD_INS_ARQ_SOLIC]
	@NM_ARQ [varchar](100),
	@CD_STATUS_ARQ [int]
WITH EXECUTE AS CALLER
AS
INSERT INTO CPD_ARQ( CD_STATUS_ARQ   ,
                       NM_ARQ          ,
                       DT_ENVIO_ARQ  ,
                       DT_INI_PROC   ,	                  
	                   DT_CONFIR_RECEB )
  VALUES (@CD_STATUS_ARQ   ,
          @NM_ARQ          ,
          GETDATE()        ,
          GETDATE()        ,	      
	      GETDATE() )

 
	SELECT @@IDENTITY AS 'IDENTITY'
GO
/****** Object:  StoredProcedure [scpd].[SP_CPD_VALID_ARQ_IMPORT]    Script Date: 06/29/2010 16:19:23 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [scpd].[SP_CPD_VALID_ARQ_IMPORT]
	@NM_ARQ [varchar](100)
WITH EXECUTE AS CALLER
AS
SELECT ISNULL(COUNT(CD_ARQ), 0) AS ARQ_IMPORT
FROM CPD_ARQ
WHERE NM_ARQ = @NM_ARQ AND
	  CD_STATUS_ARQ = 1
GO
/****** Object:  StoredProcedure [scpd].[SP_CPD_LISTA_ARQ]    Script Date: 06/29/2010 16:19:21 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [scpd].[SP_CPD_LISTA_ARQ]
	@DT_CONFIR_RECEB_INI [datetime],
	@DT_CONFIR_RECEB_FIM [datetime],
	@CD_STATUS_ARQ [tinyint] = 0
WITH EXECUTE AS CALLER
AS
SELECT CPD_ARQ.CD_ARQ, CPD_ARQ.NM_ARQ, CPD_ARQ.DT_CONFIR_RECEB, 
	   CPD_STATUS_ARQ.DS_STATUS_ARQ,
	   COUNT(CPD_SOLIC.CD_ARQ) QT_SOLIC, --CONSISTENTE
	   COUNT(CPD_SOLIC_REJEIT.CD_ARQ) QT_SOLIC_REJEIT --INCONSISTENTE
FROM CPD_ARQ
		INNER JOIN CPD_STATUS_ARQ ON CPD_ARQ.CD_STATUS_ARQ = CPD_STATUS_ARQ.CD_STATUS_ARQ
		LEFT JOIN CPD_SOLIC ON CPD_ARQ.CD_ARQ = CPD_SOLIC.CD_ARQ
		LEFT JOIN CPD_SOLIC_REJEIT ON CPD_ARQ.CD_ARQ = CPD_SOLIC_REJEIT.CD_ARQ
WHERE    
	convert(varchar(8), DT_CONFIR_RECEB, 112) >= convert(varchar(8), @DT_CONFIR_RECEB_INI, 112) and 
	convert(varchar(8), DT_CONFIR_RECEB, 112) <= convert(varchar(8), @DT_CONFIR_RECEB_FIM, 112) and
	(@CD_STATUS_ARQ = 0 OR CPD_ARQ.CD_STATUS_ARQ = @CD_STATUS_ARQ)
GROUP BY CPD_ARQ.CD_ARQ, CPD_ARQ.NM_ARQ, CPD_ARQ.CD_STATUS_ARQ,
	     CPD_STATUS_ARQ.DS_STATUS_ARQ, CPD_ARQ.DT_CONFIR_RECEB
GO
/****** Object:  StoredProcedure [scpd].[SP_CPD_INS_RETORN_POSTAG_AR]    Script Date: 06/29/2010 16:19:20 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [scpd].[SP_CPD_INS_RETORN_POSTAG_AR]
	@CD_EMBALA [numeric](12, 0),
	@CD_STATUS_POSTAG [numeric](2, 0),
	@DT_POSTAG [varchar](10),
	@TX_HORA_POSTG [varchar](10),
	@DS_ERRO [varchar](255) = NULL
WITH EXECUTE AS CALLER
AS
INSERT INTO CPD_RETORN_POSTAG_AR(CD_EMBALA, CD_STATUS_POSTAG, DT_POSTAG, TX_HORA_POSTG, DS_ERRO)
  VALUES (@CD_EMBALA, @CD_STATUS_POSTAG, @DT_POSTAG, @TX_HORA_POSTG, @DS_ERRO)
GO
/****** Object:  StoredProcedure [scpd].[SP_CPD_INS_AVISO]    Script Date: 06/29/2010 16:19:20 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [scpd].[SP_CPD_INS_AVISO]
	@DS_AVISO [varchar](8000),
	@DS_ESTAC [varchar](100) = null
WITH EXECUTE AS CALLER
AS
DECLARE @CD_ESTAC int

SET @CD_ESTAC = (SELECT top 1 CD_ESTAC FROM CPD_ESTAC WHERE DS_ESTAC = @DS_ESTAC )

  INSERT INTO CPD_AVISO( CD_PERFIL, DS_AVISO, DT_AVISO, CD_ESTAC )
  VALUES( 100, @DS_AVISO, getdate(), @CD_ESTAC)
GO
/****** Object:  StoredProcedure [scpd].[SP_CPD_ALTER_AVISO]    Script Date: 06/29/2010 16:19:19 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [scpd].[SP_CPD_ALTER_AVISO]
	@CD_AVISO [int],
	@CD_USUAR [int],
	@CD_ESTAC [int]
WITH EXECUTE AS CALLER
AS
update cpd_aviso
set dt_aceite_aviso = getdate(),
	CD_USUAR = @CD_USUAR,
	CD_ESTAC = @CD_ESTAC
where cd_aviso = @CD_AVISO
GO
/****** Object:  StoredProcedure [scpd].[SP_CPD_LISTA_AVISO]    Script Date: 06/29/2010 16:19:21 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [scpd].[SP_CPD_LISTA_AVISO]
	@CD_USUAR [int]
WITH EXECUTE AS CALLER
AS
select top 1
	AVISO.cd_aviso, 
	AVISO.ds_aviso 
from 
	cpd_aviso AVISO
where 
	AVISO.dt_aceite_aviso is null 
	and AVISO.cd_perfil =(	select 
								USUARIO.cd_perfil 
							from 
								cpd_usuar USUARIO 
							where 
								USUARIO.cd_usuar = @CD_USUAR)
GO
/****** Object:  StoredProcedure [scpd].[SP_CPD_LISTA_AVISO_DT]    Script Date: 06/29/2010 16:19:21 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [scpd].[SP_CPD_LISTA_AVISO_DT]
	@dt_inicio [datetime],
	@dt_fim [datetime],
	@CD_USUAR [int] = 0,
	@flg_confirmadas [int] = -1
WITH EXECUTE AS CALLER
AS
if( @CD_USUAR > 0 )
   begin
      if( @flg_confirmadas = 1 )
      begin
         Select Aviso.cd_aviso        as  'CodAviso', 
	            Aviso.ds_aviso        as  'Aviso',  
                Aviso.dt_aviso        as  'DataAviso', 
                Aviso.dt_aceite_aviso as  'DataAceite',
                perfil.ds_perfil      as  'Perfil',
                usuar.nm_usuar        as  'Usuario'
           From cpd_aviso       Aviso 
          Inner Join cpd_usuar  usuar 
             on Aviso.cd_usuar  = usuar.cd_usuar 
          Inner Join cpd_perfil perfil
             on Aviso.cd_perfil = perfil.cd_perfil
          Where Aviso.dt_aviso between @dt_inicio and @dt_fim
            And Aviso.cd_usuar = @CD_USUAR        
            And Aviso.dt_aceite_aviso is not null
      end
      else if( @flg_confirmadas = 0 )
      begin
         Select Aviso.cd_aviso        as  'CodAviso', 
	            Aviso.ds_aviso        as  'Aviso',  
                Aviso.dt_aviso        as  'DataAviso', 
                Aviso.dt_aceite_aviso as  'DataAceite',
                perfil.ds_perfil      as  'Perfil',
                usuar.nm_usuar        as  'Usuario'
           From cpd_aviso       Aviso 
          Inner Join cpd_usuar  usuar 
             on Aviso.cd_usuar  = usuar.cd_usuar 
          Inner Join cpd_perfil perfil
             on Aviso.cd_perfil = perfil.cd_perfil
          Where Aviso.dt_aviso between @dt_inicio and @dt_fim
            And Aviso.cd_usuar = @CD_USUAR        
            And Aviso.dt_aceite_aviso is null
      end
	  else
      begin 
         Select Aviso.cd_aviso        as  'CodAviso', 
	            Aviso.ds_aviso        as  'Aviso',  
                Aviso.dt_aviso        as  'DataAviso', 
                Aviso.dt_aceite_aviso as  'DataAceite',
                perfil.ds_perfil      as  'Perfil',
                usuar.nm_usuar        as  'Usuario'
           From cpd_aviso       Aviso 
          Inner Join cpd_usuar  usuar 
             on Aviso.cd_usuar  = usuar.cd_usuar 
          Inner Join cpd_perfil perfil
             on Aviso.cd_perfil = perfil.cd_perfil
          Where Aviso.dt_aviso between @dt_inicio and @dt_fim
            And Aviso.cd_usuar = @CD_USUAR       
      end 

   end   
   else
   begin 
      if( @flg_confirmadas = 1 )
      begin
         Select Aviso.cd_aviso        as  'CodAviso', 
	            Aviso.ds_aviso        as  'Aviso',  
                Aviso.dt_aviso        as  'DataAviso', 
                Aviso.dt_aceite_aviso as  'DataAceite',
                perfil.ds_perfil      as  'Perfil',
                usuar.nm_usuar        as  'Usuario'
           From cpd_aviso       Aviso 
          left Join cpd_usuar  usuar 
             on Aviso.cd_usuar  = usuar.cd_usuar 
          left Join cpd_perfil perfil
			 on Aviso.cd_perfil = perfil.cd_perfil
          Where Aviso.dt_aviso between @dt_inicio and @dt_fim
            And Aviso.dt_aceite_aviso is not null
      end
      else if( @flg_confirmadas = 0 )
      begin
         Select Aviso.cd_aviso        as  'CodAviso', 
	            Aviso.ds_aviso        as  'Aviso',  
                Aviso.dt_aviso        as  'DataAviso', 
                Aviso.dt_aceite_aviso as  'DataAceite',
                perfil.ds_perfil      as  'Perfil',
                usuar.nm_usuar        as  'Usuario'
           From cpd_aviso       Aviso 
          left Join cpd_usuar  usuar 
             on Aviso.cd_usuar  = usuar.cd_usuar 
          left Join cpd_perfil perfil
			 on Aviso.cd_perfil = perfil.cd_perfil
          Where Aviso.dt_aviso between @dt_inicio and @dt_fim
            And Aviso.dt_aceite_aviso is null
      end
      else
      begin
         Select Aviso.cd_aviso        as  'CodAviso', 
	            Aviso.ds_aviso        as  'Aviso',  
                Aviso.dt_aviso        as  'DataAviso', 
                Aviso.dt_aceite_aviso as  'DataAceite',
                perfil.ds_perfil      as  'Perfil',
                usuar.nm_usuar        as  'Usuario'
           From cpd_aviso       Aviso 
          left Join cpd_usuar  usuar 
             on Aviso.cd_usuar  = usuar.cd_usuar 
          left Join cpd_perfil perfil
			 on Aviso.cd_perfil = perfil.cd_perfil
          Where Aviso.dt_aviso between @dt_inicio and @dt_fim
      end
      
   end
GO
/****** Object:  StoredProcedure [scpd].[SP_CPD_LISTA_ESTOQU_GERAL]    Script Date: 06/29/2010 16:19:21 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [scpd].[SP_CPD_LISTA_ESTOQU_GERAL]
	@TX_OP [varchar](40)
WITH EXECUTE AS CALLER
AS
SELECT CPD_MATER.CD_MATER, CPD_MATER.DS_MATER,
	   CPD_MATER.QT_MINIMO_MATER, CPD_MATER.QT_MAXIMO_MATER,
	   ISNULL(CPD_ESTOQU_GERAL.QT_CPDOC, 0) AS QT_CPDOC, (ISNULL(CPD_ESTOQU_GERAL.QT_MATER, 0) - ISNULL(CPD_ESTOQU_GERAL.QT_MOV, 0)) AS QT_ESTOQU_ARMAZ
FROM CPD_ESTOQU_GERAL
		INNER JOIN CPD_MATER
					 ON CPD_MATER.CD_MATER = CPD_ESTOQU_GERAL.CD_MATER
WHERE NOT CPD_MATER.CD_MATER = (SELECT VL_PARAM FROM CPD_PARAM WHERE CD_PARAM = 23) AND -- Não Traz as CADERNETAS (SEMI-ACABADO)
	  CPD_ESTOQU_GERAL.TX_OP = @TX_OP
GO
/****** Object:  StoredProcedure [scpd].[SP_CPD_INS_SOLIC_REJEIT]    Script Date: 06/29/2010 16:19:21 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [scpd].[SP_CPD_INS_SOLIC_REJEIT]
	@NR_REMES [varchar](40),
	@NR_SEQ [numeric](12, 0),
	@CD_ARQ [int],
	@IN_EXCED [bit],
	@NR_PROTC [varchar](80),
	@DS_UNID [varchar](100),
	@DS_UNID_ATEND [varchar](100),
	@DS_TP_DOC [varchar](100),
	@NM_IDENT_PRIMAR [varchar](30),
	@NM_IDENT_SECND [varchar](30),
	@TX_SOBREN [varchar](150),
	@TX_NOME [varchar](80),
	@DS_NACION [varchar](100),
	@SX_NOME [varchar](60),
	@DS_NATURL [varchar](120),
	@DT_EXP [varchar](60),
	@DT_VALID [varchar](60),
	@TX_LOCAL_EXP [varchar](60),
	@IM_FOTO1 [image] = null,
	@IM_FOTO2 [image] = null,
	@TP_NATURZ_ENTREG [varchar](60),
	@DT_NASC [varchar](60),
	@DS_PAIS [varchar](60),
	@NR_IDENT_CDADAO [varchar](60),
	@DS_ERRO [varchar](4000)
WITH EXECUTE AS CALLER
AS
INSERT INTO CPD_SOLIC_REJEIT (  CD_ARQ, 
                                      NR_REMES, 
                                      NR_SEQ, 
                                      NR_PROTC, 
                                      DS_UNID,
									  DS_UNID_ATEND, 
                                      IN_EXCED, 
                                      DS_TP_DOC,
								      NM_IDENT_PRIMAR,
									  NM_IDENT_SECND,
                                      TX_SOBREN, 
                                      TX_NOME, 
                                      DS_NACION, 
                                      SX_NOME, 
                                      DS_NATURL, 
                                      DT_EXP, 
                                      DT_VALID,
									  TX_LOCAL_EXP, 
                                      IM_FOTO1, 
                                      IM_FOTO2, 
                                      TP_NATURZ_ENTREG,
									  DT_NASC,
									  DS_PAIS,
									  NR_IDENT_CDADAO,
                                      DS_ERRO  )
      VALUES( @CD_ARQ           ,
              @NR_REMES         ,
              @NR_SEQ           ,
              @NR_PROTC         ,
              @DS_UNID          ,
			  @DS_UNID_ATEND    ,
              @IN_EXCED         ,
              @DS_TP_DOC        ,
			  @NM_IDENT_PRIMAR  ,
			  @NM_IDENT_SECND   ,
              @TX_SOBREN        ,
              @TX_NOME          ,
              @DS_NACION        ,
              @SX_NOME          ,
              @DS_NATURL        ,
              @DT_EXP           ,
              @DT_VALID         ,
			  @TX_LOCAL_EXP     ,
              @IM_FOTO1         ,
              @IM_FOTO2         ,
              @TP_NATURZ_ENTREG ,
			  @DT_NASC          ,
			  @DS_PAIS          ,
			  @NR_IDENT_CDADAO  ,		
              @DS_ERRO           )
GO
/****** Object:  StoredProcedure [scpd].[SP_CPD_LISTA_LOTE_FINALZ]    Script Date: 06/29/2010 16:19:22 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [scpd].[SP_CPD_LISTA_LOTE_FINALZ]
WITH EXECUTE AS CALLER
AS
Select distinct 
	   unid_entrg.cd_unid as 'CodigoLocalEntrega',
	   unid_entrg.ds_unid  as 'LocalEntrega',
	   unid_atend.cd_unid as 'CodigoLocalAtendimento',
	   unid_atend.ds_unid  as 'LocalAtendimento',
       lote.tp_naturz_entrg as 'Prioridade',
       convert(varchar(10), min(lote.dt_max_saida), 103) as 'Data',       
	   convert(varchar(8), min(lote.dt_max_saida), 112) as 'DataOrdem',
       count(solic.nr_protc) as 'Quantidade',
	   case lote.tp_naturz_entrg
			when 'UH' then 1
			when 'UX' then 2
			when 'U' then 3
			when 'R' then 4	
	   end 'OrdemPrioridade'
  From CPD_SOLIC solic
		    Inner Join CPD_LOTE_SOLIC_USUAR lote
		           on solic.cd_lote = lote.cd_lote
			Inner Join CPD_UNID_ENTRG unid_entrg
				   on lote.cd_local_exp = unid_entrg.cd_unid
			Inner Join CPD_UNID_ENTRG unid_atend
				   on lote.cd_local_atend = unid_atend.cd_unid
 Where lote.dt_fim_lote is not null
   And lote.dt_embala is null                         
   And Not RTrim(LTrim(upper(solic.tp_naturz_entrg))) = 'E' -- Menos Extraordinária
   And solic.cd_status_solic = 40   
 group by unid_entrg.cd_unid,
		  unid_atend.cd_unid,
		  unid_entrg.ds_unid,
		  unid_atend.ds_unid,
		  lote.tp_naturz_entrg
 order by OrdemPrioridade, DataOrdem
GO
/****** Object:  StoredProcedure [scpd].[SP_CPD_LISTA_INFORM_LOTE]    Script Date: 06/29/2010 16:19:21 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [scpd].[SP_CPD_LISTA_INFORM_LOTE]
	@CD_LOTE [decimal](12, 0)
WITH EXECUTE AS CALLER
AS
SELECT CPD_SOLIC.NR_PROTC, CPD_CADERN.NR_CADERN, 
	   CPD_STATUS_SOLIC.DS_STATUS_SOLIC, 
	   CPD_USUAR.NM_USUAR
FROM CPD_LOTE_SOLIC_USUAR
		INNER JOIN CPD_SOLIC 
			ON CPD_LOTE_SOLIC_USUAR.CD_LOTE = CPD_SOLIC.CD_LOTE
		INNER JOIN CPD_STATUS_SOLIC
			ON CPD_SOLIC.CD_STATUS_SOLIC = CPD_STATUS_SOLIC.CD_STATUS_SOLIC
		LEFT JOIN CPD_CADERN 
			ON CPD_SOLIC.NR_CADERN = CPD_CADERN.NR_CADERN
		LEFT JOIN CPD_USUAR
			ON CPD_SOLIC.CD_USUAR = CPD_USUAR.CD_USUAR
WHERE CPD_LOTE_SOLIC_USUAR.CD_LOTE = @CD_LOTE
GO
/****** Object:  StoredProcedure [scpd].[SP_CPD_LISTA_SOLIC_EMBALA]    Script Date: 06/29/2010 16:19:22 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [scpd].[SP_CPD_LISTA_SOLIC_EMBALA]
	@cd_embala [numeric](12, 0)
WITH EXECUTE AS CALLER
AS
Select Solic.nr_protc  as 'SEQSOLIC',
       Solic.nr_cadern as 'NUMPASSAPORTE' , 
       convert(varchar(8), lote.dt_embala, 112) +  replace(convert(varchar(8), lote.dt_embala, 108), ':', '') as 'DATAHORACONFECCAO'
  From CPD_SOLIC                 Solic
 Inner Join CPD_LOTE_SOLIC_USUAR Lote
    on Solic.cd_lote = Lote.cd_lote
 Inner Join CPD_CADERN           Cadern
    on Solic.nr_cadern = Cadern.nr_cadern
   And Cadern.cd_embala is not null
   and Cadern.cd_embala = @cd_embala
GO
/****** Object:  StoredProcedure [scpd].[SP_CPD_REL_LOTE_CADERN]    Script Date: 06/29/2010 16:19:22 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [scpd].[SP_CPD_REL_LOTE_CADERN]
	@CD_LOTE [numeric](12, 0)
WITH EXECUTE AS CALLER
AS
select distinct	
				LOTE.cd_lote, 
				LOTE.tp_naturz_entrg,
				HIST_STATUS.nr_protc,
				HIST_STATUS.nr_cadern
--				USUARIO.nm_usuar
from cpd_usuar USUARIO
				inner join cpd_lote_solic_usuar LOTE
				on USUARIO.cd_usuar = LOTE.cd_usuar
				inner join cpd_solic_hist_status HIST_STATUS
				on HIST_STATUS.cd_usuar = LOTE.cd_usuar
where
				not LOTE.dt_fim_lote is null and
				LOTE.cd_lote = @CD_LOTE
GO
/****** Object:  StoredProcedure [scpd].[SP_CPD_SELEC_CADERN_LOTE_USUAR]    Script Date: 06/29/2010 16:19:23 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [scpd].[SP_CPD_SELEC_CADERN_LOTE_USUAR]
	@NR_CADERN [char](8),
	@CD_USUAR_LOGADO [int],
	@CD_STATUS_SOLIC [smallint]
WITH EXECUTE AS CALLER
AS
SELECT SOL.NR_CADERN, SOL.NR_PROTC, LOT.CD_LOTE, LOT.CD_USUAR, LOT.DT_MAX_SAIDA, LOT.CD_LOCAL_EXP,
	   LOT.TP_NATURZ_ENTRG
FROM CPD_SOLIC SOL 
		inner join CPD_LOTE_SOLIC_USUAR LOT on SOL.CD_LOTE = LOT.CD_LOTE
WHERE SOL.NR_CADERN = @NR_CADERN AND
	  LOT.CD_USUAR = @CD_USUAR_LOGADO AND
	  SOL.CD_STATUS_SOLIC = @CD_STATUS_SOLIC
GO
/****** Object:  StoredProcedure [scpd].[SP_CPD_REINIC_LOTE]    Script Date: 06/29/2010 16:19:22 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [scpd].[SP_CPD_REINIC_LOTE]
	@NR_CADER [char](8)
WITH EXECUTE AS CALLER
AS
UPDATE
	CPD_LOTE_SOLIC_USUAR
SET
	DT_FIM_LOTE = NULL
FROM
	CPD_LOTE_SOLIC_USUAR
	INNER JOIN CPD_SOLIC ON CPD_SOLIC.CD_LOTE = CPD_LOTE_SOLIC_USUAR.CD_LOTE
WHERE
	CPD_SOLIC.NR_CADERN = @NR_CADER
	AND CPD_LOTE_SOLIC_USUAR.DT_FIM_LOTE IS NOT NULL
GO
/****** Object:  StoredProcedure [scpd].[SP_CPD_LISTA_CADERN_VINCUL_USUAR]    Script Date: 06/29/2010 16:19:21 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [scpd].[SP_CPD_LISTA_CADERN_VINCUL_USUAR]
	@CD_USUAR [int]
WITH EXECUTE AS CALLER
AS
SELECT CPD_SOLIC.NR_CADERN 
FROM CPD_LOTE_SOLIC_USUAR 
		INNER JOIN CPD_SOLIC ON CPD_LOTE_SOLIC_USUAR.CD_LOTE = CPD_SOLIC.CD_LOTE 
		INNER JOIN CPD_CADERN ON CPD_SOLIC.NR_CADERN = CPD_CADERN.NR_CADERN
WHERE CPD_LOTE_SOLIC_USUAR.CD_USUAR = @CD_USUAR AND
	  (NOT CPD_CADERN.CD_USUAR_RETIR_CADERN = @CD_USUAR OR CPD_CADERN.CD_USUAR_RETIR_CADERN IS NULL) AND
	  CPD_SOLIC.CD_STATUS_SOLIC <= 40 AND -- Solicitação até o status 'Pronto para Embalar'
	  CPD_CADERN.CD_CADERN_STATUS = 30 -- Caderneta em 'Uso'
ORDER BY CPD_CADERN.SQ_CADERN
GO
/****** Object:  StoredProcedure [scpd].[SP_CPD_QT_LOTE]    Script Date: 06/29/2010 16:19:22 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [scpd].[SP_CPD_QT_LOTE]
WITH EXECUTE AS CALLER
AS
SELECT
	COUNT(CPD_SOLIC.NR_PROTC) as QD_LOTE,
    CPD_LOTE_SOLIC_USUAR.DT_ABERT_LOTE,
	CPD_LOTE_SOLIC_USUAR.DT_MAX_SAIDA,
	CPD_LOTE_SOLIC_USUAR.TP_NATURZ_ENTRG,
	CPD_LOTE_SOLIC_USUAR.CD_LOTE,
	CPD_UNID_ENTRG.DS_UNID
FROM
	CPD_LOTE_SOLIC_USUAR
		INNER JOIN CPD_SOLIC ON CPD_LOTE_SOLIC_USUAR.CD_LOTE = CPD_SOLIC.CD_LOTE
		INNER JOIN CPD_UNID_ENTRG ON CPD_UNID_ENTRG.CD_UNID = CPD_LOTE_SOLIC_USUAR.CD_LOCAL_EXP
WHERE
	CPD_LOTE_SOLIC_USUAR.CD_USUAR IS NULL AND
	CPD_SOLIC.CD_STATUS_SOLIC = 10
GROUP BY
    CPD_LOTE_SOLIC_USUAR.DT_ABERT_LOTE,
	CPD_LOTE_SOLIC_USUAR.DT_MAX_SAIDA,
	CPD_LOTE_SOLIC_USUAR.TP_NATURZ_ENTRG,
	CPD_LOTE_SOLIC_USUAR.CD_LOTE,
	CPD_UNID_ENTRG.DS_UNID
ORDER BY
	CPD_LOTE_SOLIC_USUAR.DT_MAX_SAIDA ASC
GO
/****** Object:  StoredProcedure [scpd].[SP_CPD_LISTA_QT_SOLIC_USUAR]    Script Date: 06/29/2010 16:19:22 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [scpd].[SP_CPD_LISTA_QT_SOLIC_USUAR]
WITH EXECUTE AS CALLER
AS
SELECT
	CPD_USUAR.CD_USUAR,
	CPD_USUAR.NM_USUAR,
	'QD_SOLIC_USUAR' = (SELECT COUNT(CPD_SOLIC.NR_PROTC) FROM CPD_LOTE_SOLIC_USUAR INNER JOIN
						CPD_SOLIC WITH (NOLOCK) ON CPD_LOTE_SOLIC_USUAR.CD_LOTE = CPD_SOLIC.CD_LOTE
						WHERE CPD_LOTE_SOLIC_USUAR.DT_FIM_LOTE IS NULL AND
							  CPD_LOTE_SOLIC_USUAR.CD_USUAR = CPD_USUAR.CD_USUAR AND
							  CPD_SOLIC.CD_STATUS_SOLIC = 20),
	'QD_TEMPO_OCIOSO' = (SELECT ISNULL(CONVERT(DECIMAL(12,0), DATEDIFF(second, MAX(DT_HIST), GETDATE())), 999999999999) 
						 FROM CPD_SOLIC_HIST_STATUS WITH (NOLOCK)
						 WHERE CPD_SOLIC_HIST_STATUS.CD_USUAR = CPD_USUAR.CD_USUAR AND
							   CPD_SOLIC_HIST_STATUS.CD_STATUS_SOLIC = 30)
FROM
	CPD_USUAR
WHERE ((IN_STATUS = 1 AND CD_PERFIL = 30) OR 
	   ((SELECT COUNT(CPD_SOLIC.NR_PROTC) FROM CPD_LOTE_SOLIC_USUAR INNER JOIN
				CPD_SOLIC WITH (NOLOCK) ON CPD_LOTE_SOLIC_USUAR.CD_LOTE = CPD_SOLIC.CD_LOTE
	     WHERE CPD_LOTE_SOLIC_USUAR.DT_FIM_LOTE IS NULL AND
   			CPD_LOTE_SOLIC_USUAR.CD_USUAR = CPD_USUAR.CD_USUAR AND
			CPD_SOLIC.CD_STATUS_SOLIC = 20) > 0))
ORDER BY 
QD_SOLIC_USUAR, QD_TEMPO_OCIOSO DESC, NM_USUAR
GO
/****** Object:  StoredProcedure [scpd].[SP_CPD_LISTA_LOTE_FINALZ_LOCAL_ENTRG]    Script Date: 06/29/2010 16:19:22 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [scpd].[SP_CPD_LISTA_LOTE_FINALZ_LOCAL_ENTRG]
	@CD_UNID [varchar](13),
	@CD_UNID_ATEND [varchar](13),
	@TP_NATURZ_ENTRG [varchar](2)
WITH EXECUTE AS CALLER
AS
SELECT COUNT(CPD_SOLIC.NR_PROTC)             as 'QtdEmbalagem' , 
       CPD_LOTE_SOLIC_USUAR.DT_MAX_SAIDA     as 'DataMaximaSaida' ,
       CPD_LOTE_SOLIC_USUAR.TP_NATURZ_ENTRG  as 'Prioridade' , 
	   CPD_LOTE_SOLIC_USUAR.CD_LOTE          as 'Lote',
       UNID_ENTRG.DS_UNID                    as 'LocalEntrega',
       UNID_ATEND.DS_UNID                    as 'LocalAtendimento'	   
FROM CPD_LOTE_SOLIC_USUAR 
	   INNER JOIN CPD_SOLIC 
		  ON CPD_LOTE_SOLIC_USUAR.CD_LOTE = CPD_SOLIC.CD_LOTE
	   INNER JOIN CPD_UNID_ENTRG UNID_ENTRG
		  ON UNID_ENTRG.CD_UNID = CPD_LOTE_SOLIC_USUAR.CD_LOCAL_EXP
	   INNER JOIN CPD_UNID_ENTRG UNID_ATEND
		  ON UNID_ATEND.CD_UNID = CPD_LOTE_SOLIC_USUAR.CD_LOCAL_ATEND 
WHERE CPD_LOTE_SOLIC_USUAR.DT_FIM_LOTE IS NOT NULL
  AND CPD_LOTE_SOLIC_USUAR.DT_EMBALA IS NULL
  AND CPD_LOTE_SOLIC_USUAR.CD_LOCAL_EXP = @CD_UNID
  AND CPD_LOTE_SOLIC_USUAR.CD_LOCAL_ATEND = @CD_UNID_ATEND
  AND CPD_LOTE_SOLIC_USUAR.TP_NATURZ_ENTRG = @TP_NATURZ_ENTRG
  AND CPD_SOLIC.CD_STATUS_SOLIC = 40
  AND NOT Rtrim(Ltrim(upper(CPD_SOLIC.TP_NATURZ_ENTRG))) = 'E' -- Menos Extraordinária
GROUP BY CPD_LOTE_SOLIC_USUAR.DT_MAX_SAIDA, 
         CPD_LOTE_SOLIC_USUAR.TP_NATURZ_ENTRG,
         CPD_LOTE_SOLIC_USUAR.CD_LOTE,
         UNID_ENTRG.DS_UNID,
		 UNID_ATEND.DS_UNID,
		 CPD_LOTE_SOLIC_USUAR.DT_ABERT_LOTE
ORDER BY CPD_LOTE_SOLIC_USUAR.DT_MAX_SAIDA ASC
GO
/****** Object:  StoredProcedure [scpd].[SP_CPD_SELEC_CADERN_PENDEN]    Script Date: 06/29/2010 16:19:23 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [scpd].[SP_CPD_SELEC_CADERN_PENDEN]
	@CD_USUAR_LOGADO [int]
WITH EXECUTE AS CALLER
AS
SELECT SOL.NR_PROTC	  
FROM CPD_SOLIC SOL 
		inner join CPD_LOTE_SOLIC_USUAR LOT on SOL.CD_LOTE = LOT.CD_LOTE
WHERE LOT.CD_USUAR = @CD_USUAR_LOGADO AND
	  SOL.CD_STATUS_SOLIC IN (25,30)
GO
/****** Object:  StoredProcedure [scpd].[SP_CPD_SELEC_SOLIC]    Script Date: 06/29/2010 16:19:23 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [scpd].[SP_CPD_SELEC_SOLIC]
	@NR_PROTC [decimal](16, 0)
WITH EXECUTE AS CALLER
AS
SELECT SOL.NR_PROTC, SOL.NM_IDENT_SECND, SOL.NM_IDENT_PRIMAR, SOL.DS_NACION, 
	   SOL.SX_NOME, SOL.DS_NATURL, SOL.DT_EXP, SOL.DT_VALID,        
       SOL.IM_FOTO2, SOL.DT_NASC, SOL.NR_CADERN, TPDOC.DS_DOC,
	   PAIS.SG_PAIS
FROM CPD_SOLIC SOL
		INNER JOIN CPD_TP_DOC TPDOC
			ON SOL.CD_TP_DOC = TPDOC.CD_TP_DOC
		INNER JOIN CPD_PAIS PAIS
			ON SOL.CD_PAIS = PAIS.CD_PAIS
WHERE NR_PROTC = @NR_PROTC
GO
/****** Object:  StoredProcedure [scpd].[SP_CPD_LISTA_INFORM_CRITIC]    Script Date: 06/29/2010 16:19:21 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [scpd].[SP_CPD_LISTA_INFORM_CRITIC]
WITH EXECUTE AS CALLER
AS
SELECT CD_PAIS, DS_PAIS, SG_PAIS 
FROM CPD_PAIS

SELECT CD_UNID, DS_UNID, EN_UNID_ENTRG, NR_CEP, 
       NR_CNPJ, NR_CIC, NR_INSCR_EST, 
       NM_BAIRRO, NR_DDD, NR_TEL, NR_FAX, NR_TELEX, 
       DS_EMAIL, CD_MUN, IN_STATUS 
FROM CPD_UNID_ENTRG 
WHERE IN_STATUS = 1

SELECT CD_TP_DOC, DS_DOC
FROM CPD_TP_DOC
GO
/****** Object:  StoredProcedure [scpd].[SP_CPD_REL_PASSAP]    Script Date: 06/29/2010 16:19:22 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [scpd].[SP_CPD_REL_PASSAP]
	@NR_PROTC [numeric](16, 0)
WITH EXECUTE AS CALLER
AS
SELECT
	CPD_TP_DOC.DS_DOC,
	CPD_PAIS.SG_PAIS,
	NR_CADERN,
	TX_SOBREN,
	TX_NOME,
	DS_NACION,
	DT_NASC,
	NR_PROTC,
	SX_NOME,
	DS_NATURL,
	NR_IDENT_CDADAO,
	CAST(CONVERT(CHAR(10),DT_EXP,103)AS VARCHAR(10)) AS DT_EXP,
	CAST(CONVERT(CHAR(10),DT_VALID,103)AS VARCHAR(10)) AS DT_VALID,
	--REPLACE(CONVERT(CHAR(11),DT_EXP,106),' ','/') AS DT_EXP,
	--REPLACE(CONVERT(CHAR(11),DT_VALID,106),' ','/') AS DT_VALID,
	TX_LOCAL_EXP,
	IM_FOTO1,
	IM_PDF417
FROM
	CPD_SOLIC
	INNER JOIN CPD_TP_DOC ON CPD_TP_DOC.CD_TP_DOC = CPD_SOLIC.CD_TP_DOC
	INNER JOIN CPD_PAIS ON CPD_PAIS.CD_PAIS = CPD_SOLIC.CD_PAIS
WHERE
	NR_PROTC = @NR_PROTC
GO
/****** Object:  StoredProcedure [scpd].[SP_CPD_LISTA_HIST_PROTC]    Script Date: 06/29/2010 16:19:21 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [scpd].[SP_CPD_LISTA_HIST_PROTC]
	@NR_PROTC [numeric](15, 0)
WITH EXECUTE AS CALLER
AS
select	HISTORICO.NR_PROTC,
		HISTORICO.DT_HIST, 
		HISTORICO.NR_CADERN,
		STATUS.DS_STATUS_SOLIC,	
		USUARIO.NM_USUAR,
		ESTACAO.DS_ESTAC,
		SOLIC.CD_LOTE,
		UNID.DS_UNID,
		UNID_ATEND.DS_UNID DS_UNID_ATEND,
	    SOLIC.NR_CADERN as NR_CADERN_ATUAL
from cpd_solic_hist_status HISTORICO
inner join cpd_solic SOLIC 
on SOLIC.nr_protc = HISTORICO.nr_protc
inner join cpd_status_solic STATUS 
on STATUS.cd_status_solic = HISTORICO.cd_status_solic
inner join cpd_unid_entrg UNID
on SOLIC.cd_unid = UNID.cd_unid
inner join cpd_unid_entrg UNID_ATEND
on SOLIC.cd_unid_atend = UNID_ATEND.cd_unid
left join cpd_usuar USUARIO
on HISTORICO.cd_usuar = USUARIO.cd_usuar
inner join cpd_estac ESTACAO
on ESTACAO.cd_estac = HISTORICO.cd_estac
where HISTORICO.NR_PROTC = @NR_PROTC
order by HISTORICO.DT_HIST desc
GO
/****** Object:  StoredProcedure [scpd].[SP_CPD_EXCL_PAUTA_DISTR_DOC]    Script Date: 06/29/2010 16:19:20 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [scpd].[SP_CPD_EXCL_PAUTA_DISTR_DOC]
	@CD_PAUTA [int]
WITH EXECUTE AS CALLER
AS
DELETE FROM CPD_PAUTA_DISTR_DOC
WHERE CD_PAUTA = @CD_PAUTA
GO
/****** Object:  StoredProcedure [scpd].[SP_CPD_LISTA_PROTC_EXTRAO]    Script Date: 06/29/2010 16:19:22 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [scpd].[SP_CPD_LISTA_PROTC_EXTRAO]
	@NR_CADERN [char](8),
	@CD_STATUS_SOLIC [smallint],
	@TP_NATURZ_ENTRG [char](1)
WITH EXECUTE AS CALLER
AS
SELECT SOLIC.NR_PROTC,
       SOLIC.TX_SOBREN,
       SOLIC.TX_NOME,
       SOLIC.NR_CADERN,
	   SOLIC.CD_PAUTA,
       ( SELECT NR_DOC
           FROM CPD_PAUTA_DISTR_DOC
          WHERE CD_PAUTA = SOLIC.CD_PAUTA ) AS 'NR_DOC',
	   SOLIC.NR_PROTC as 'SEQSOLIC',
	   SOLIC.NR_CADERN as 'NUMPASSAPORTE',
	   convert(varchar(8), getdate(), 112) + replace(convert(varchar(8), getdate(), 108), ':', '') as 'DATAHORACONFECCAO'
FROM  
       CPD_SOLIC SOLIC
WHERE
	SOLIC.CD_PAUTA = (SELECT CD_PAUTA 
					  FROM CPD_SOLIC 
                      WHERE NR_CADERN = @NR_CADERN AND
					        CD_STATUS_SOLIC = @CD_STATUS_SOLIC AND
                            TP_NATURZ_ENTRG = @TP_NATURZ_ENTRG) AND
    SOLIC.CD_PAUTA IS NOT NULL
GO
/****** Object:  StoredProcedure [scpd].[SP_CPD_LISTA_USUAR]    Script Date: 06/29/2010 16:19:22 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [scpd].[SP_CPD_LISTA_USUAR]
	@CD_PERFIL [int] = 0,
	@NM_USUAR [varchar](100) = '',
	@DS_LOGIN [varchar](30) = ''
WITH EXECUTE AS CALLER
AS
SELECT
	U.CD_USUAR,
	P.DS_PERFIL,
	U.NM_USUAR,
	U.DS_LOGIN,
	U.NM_GUERRA,
	U.NR_MATRIC,
	U.DS_DOMIN


FROM

CPD_USUAR U
LEFT JOIN CPD_PERFIL P ON U.CD_PERFIL = P.CD_PERFIL

WHERE

	(P.CD_PERFIL = @CD_PERFIL OR @CD_PERFIL = 0)
AND	(U.NM_USUAR LIKE '%' + @NM_USUAR + '%')
AND	(U.DS_LOGIN LIKE '%' + @DS_LOGIN + '%')
ORDER BY U.NM_USUAR, U.DS_LOGIN
GO
/****** Object:  StoredProcedure [scpd].[SP_CPD_VALID_PERMIS_USUAR]    Script Date: 06/29/2010 16:19:23 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [scpd].[SP_CPD_VALID_PERMIS_USUAR]
	@CD_USUAR [int],
	@NM_FISICO [varchar](40)
WITH EXECUTE AS CALLER
AS
SELECT
	COUNT(CPD_FUNCL.CD_FUNCL)
FROM
	CPD_USUAR
		INNER JOIN CPD_PERFIL_FUNC ON CPD_PERFIL_FUNC.CD_PERFIL = CPD_USUAR.CD_PERFIL
		INNER JOIN CPD_FUNCL ON CPD_FUNCL.CD_FUNCL = CPD_PERFIL_FUNC.CD_FUNCL
WHERE
	CPD_USUAR.CD_USUAR = @CD_USUAR AND
	CPD_USUAR.IN_STATUS = 1 AND
    CPD_FUNCL.NM_FISICO = @NM_FISICO
GO
/****** Object:  StoredProcedure [scpd].[SP_CPD_LISTA_FUNCL_USUAR]    Script Date: 06/29/2010 16:19:21 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [scpd].[SP_CPD_LISTA_FUNCL_USUAR]
	@DS_LOGIN [varchar](30),
	@DS_DOMIN [varchar](20)
WITH EXECUTE AS CALLER
AS
SELECT
	CPD_FUNCL.CD_FUNCL, CPD_FUNCL.CD_FUNCL_PAI, CPD_FUNCL.DS_FUNCL, CPD_FUNCL.NM_FISICO, CPD_FUNCL.NR_HIER,
	CPD_USUAR.CD_USUAR, CPD_USUAR.NM_USUAR, CPD_USUAR.DS_LOGIN, CPD_PERFIL_FUNC.CD_PERFIL, CPD_USUAR.DS_DOMIN
FROM
	CPD_USUAR
	INNER JOIN CPD_PERFIL_FUNC ON CPD_PERFIL_FUNC.CD_PERFIL = CPD_USUAR.CD_PERFIL
	INNER JOIN CPD_FUNCL ON CPD_FUNCL.CD_FUNCL = CPD_PERFIL_FUNC.CD_FUNCL
WHERE
	CPD_USUAR.DS_LOGIN = @DS_LOGIN AND
	CPD_USUAR.DS_DOMIN = @DS_DOMIN AND
	CPD_USUAR.IN_STATUS = 1
ORDER BY CPD_FUNCL.NR_HIER
GO
/****** Object:  StoredProcedure [scpd].[SP_CPD_LISTA_ESTAC]    Script Date: 06/29/2010 16:19:21 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [scpd].[SP_CPD_LISTA_ESTAC]
	@NM_ESTACAO [varchar](30) = ''
WITH EXECUTE AS CALLER
AS
SELECT
    CD_ESTAC,
	DS_ESTAC,
	IN_STATUS,
    CASE IN_STATUS
		WHEN 1 THEN	'Ativa'
		ELSE 'Inativa'
	END DS_STATUS
FROM
	CPD_ESTAC
WHERE
	(DS_ESTAC LIKE '%' + @NM_ESTACAO + '%')
ORDER BY DS_ESTAC
GO
/****** Object:  StoredProcedure [scpd].[SP_CPD_REL_PROD_USUAR]    Script Date: 06/29/2010 16:19:23 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [scpd].[SP_CPD_REL_PROD_USUAR]
	@DE [datetime],
	@ATE [datetime],
	@STATUS [int],
	@CD_USUAR [int]
WITH EXECUTE AS CALLER
AS
SELECT 
	COUNT(NR_PROTC) NR_PROTC, COUNT(NR_CADERN) NR_CADERN, DS_STATUS_SOLIC,
	NM_USUAR, DS_ESTAC
FROM
	CPD_SOLIC_HIST_STATUS 
        INNER JOIN CPD_STATUS_SOLIC ON CPD_SOLIC_HIST_STATUS.CD_STATUS_SOLIC = CPD_STATUS_SOLIC.CD_STATUS_SOLIC
		INNER JOIN CPD_USUAR ON CPD_SOLIC_HIST_STATUS.CD_USUAR = CPD_USUAR.CD_USUAR
		INNER JOIN CPD_ESTAC ON CPD_SOLIC_HIST_STATUS.CD_ESTAC = CPD_ESTAC.CD_ESTAC
WHERE
	NOT EXISTS(SELECT ST_HIST.NR_CADERN, 
				      ST_HIST.CD_STATUS_SOLIC
			   FROM CPD_CADERN_HIST_STATUS
					INNER JOIN CPD_SOLIC_HIST_STATUS ST_HIST ON CPD_CADERN_HIST_STATUS.NR_CADERN = CPD_SOLIC_HIST_STATUS.NR_CADERN
			   WHERE CPD_CADERN_HIST_STATUS.CD_CADERN_STATUS = 10  AND
					 ST_HIST.DT_HIST = (SELECT MAX(HIST.DT_HIST)
										FROM CPD_SOLIC_HIST_STATUS HIST
									    WHERE HIST.NR_CADERN = ST_HIST.NR_CADERN) AND
                     ST_HIST.NR_CADERN = CPD_SOLIC_HIST_STATUS.NR_CADERN AND
					 ST_HIST.CD_STATUS_SOLIC = CPD_SOLIC_HIST_STATUS.CD_STATUS_SOLIC
			   ) AND
	CONVERT(varchar(8),DT_HIST, 112) >= CONVERT(varchar(8), @DE, 112) AND
    CONVERT(varchar(8),DT_HIST, 112) <= CONVERT(varchar(8), @ATE, 112) AND
	(CPD_SOLIC_HIST_STATUS.CD_STATUS_SOLIC = @STATUS  OR @STATUS = 0) AND
	(CPD_SOLIC_HIST_STATUS.CD_USUAR = @CD_USUAR OR @CD_USUAR = 0)
GROUP BY 
	DS_STATUS_SOLIC, NM_USUAR, DS_ESTAC, CPD_SOLIC_HIST_STATUS.CD_STATUS_SOLIC
ORDER BY NM_USUAR, CPD_SOLIC_HIST_STATUS.CD_STATUS_SOLIC, DS_ESTAC
GO
/****** Object:  StoredProcedure [scpd].[SP_CPD_REL_PROD_ESTAC]    Script Date: 06/29/2010 16:19:23 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [scpd].[SP_CPD_REL_PROD_ESTAC]
	@DE [datetime],
	@ATE [datetime],
	@STATUS [int],
	@CD_ESTAC [int]
WITH EXECUTE AS CALLER
AS
SELECT 
	COUNT(NR_PROTC) NR_PROTC, COUNT(NR_CADERN) NR_CADERN, DS_STATUS_SOLIC,
	NM_USUAR, DS_ESTAC
FROM
	CPD_SOLIC_HIST_STATUS 
        INNER JOIN CPD_STATUS_SOLIC ON CPD_SOLIC_HIST_STATUS.CD_STATUS_SOLIC = CPD_STATUS_SOLIC.CD_STATUS_SOLIC
		INNER JOIN CPD_USUAR ON CPD_SOLIC_HIST_STATUS.CD_USUAR = CPD_USUAR.CD_USUAR
		INNER JOIN CPD_ESTAC ON CPD_SOLIC_HIST_STATUS.CD_ESTAC = CPD_ESTAC.CD_ESTAC
WHERE
	NOT EXISTS(SELECT ST_HIST.NR_CADERN, 
				      ST_HIST.CD_STATUS_SOLIC
			   FROM CPD_CADERN_HIST_STATUS
					INNER JOIN CPD_SOLIC_HIST_STATUS ST_HIST ON CPD_CADERN_HIST_STATUS.NR_CADERN = CPD_SOLIC_HIST_STATUS.NR_CADERN
			   WHERE CPD_CADERN_HIST_STATUS.CD_CADERN_STATUS = 10  AND
					 ST_HIST.DT_HIST = (SELECT MAX(HIST.DT_HIST)
										FROM CPD_SOLIC_HIST_STATUS HIST
									    WHERE HIST.NR_CADERN = ST_HIST.NR_CADERN) AND
                     ST_HIST.NR_CADERN = CPD_SOLIC_HIST_STATUS.NR_CADERN AND
					 ST_HIST.CD_STATUS_SOLIC = CPD_SOLIC_HIST_STATUS.CD_STATUS_SOLIC
			   ) AND
	CONVERT(varchar(8),DT_HIST, 112) >= CONVERT(varchar(8), @DE, 112) AND
    CONVERT(varchar(8),DT_HIST, 112) <= CONVERT(varchar(8), @ATE, 112) AND
	(CPD_SOLIC_HIST_STATUS.CD_STATUS_SOLIC = @STATUS  OR @STATUS = 0) AND
	(CPD_SOLIC_HIST_STATUS.CD_ESTAC = @CD_ESTAC OR @CD_ESTAC = 0)
GROUP BY 
	DS_STATUS_SOLIC, NM_USUAR, DS_ESTAC, CPD_SOLIC_HIST_STATUS.CD_STATUS_SOLIC
ORDER BY DS_ESTAC, CPD_SOLIC_HIST_STATUS.CD_STATUS_SOLIC, NM_USUAR













SELECT CONVERT(varchar(10),GETDATE(), 112)
GO
/****** Object:  StoredProcedure [scpd].[SP_CPD_SELEC_ESTAC]    Script Date: 06/29/2010 16:19:23 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [scpd].[SP_CPD_SELEC_ESTAC]
	@DS_ESTAC [varchar](30)
WITH EXECUTE AS CALLER
AS
SELECT ISNULL(CD_ESTAC, 0)  as CD_ESTAC
FROM CPD_ESTAC
WHERE DS_ESTAC = @DS_ESTAC
GO
/****** Object:  StoredProcedure [scpd].[SP_CPD_REL_PERDAS]    Script Date: 06/29/2010 16:19:22 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [scpd].[SP_CPD_REL_PERDAS]
	@CODIGO [varchar](40)
WITH EXECUTE AS CALLER
AS
SELECT SUM(QtdPerdas) AS QtdPerdas, CD_MOTIVO_PERDA, DS_MOTIVO_PERDA
FROM(SELECT COUNT(CPD_CADERN_HIST_STATUS.NR_CADERN) AS QtdPerdas, CPD_MOTIVO_PERDA.CD_MOTIVO_PERDA,
			CPD_MOTIVO_PERDA.DS_MOTIVO_PERDA
     FROM CPD_CADERN_HIST_STATUS INNER JOIN
	      CPD_CADERN ON CPD_CADERN_HIST_STATUS.NR_CADERN = CPD_CADERN.NR_CADERN INNER JOIN
		  CPD_MOTIVO_PERDA ON CPD_CADERN_HIST_STATUS.CD_MOTIVO_PERDA = CPD_MOTIVO_PERDA.CD_MOTIVO_PERDA
     WHERE CPD_CADERN_HIST_STATUS.CD_CADERN_STATUS = 10 AND CPD_CADERN.TX_OP = @CODIGO
     GROUP BY CPD_MOTIVO_PERDA.CD_MOTIVO_PERDA, CPD_MOTIVO_PERDA.DS_MOTIVO_PERDA

	 /**********************************************************************************/
	 UNION
	 /**********************************************************************************/

	 SELECT 0 AS QtdPerdas, CPD_MOTIVO_PERDA.CD_MOTIVO_PERDA, CPD_MOTIVO_PERDA.DS_MOTIVO_PERDA
	 FROM CPD_MOTIVO_PERDA
) TABELA
GROUP BY CD_MOTIVO_PERDA, DS_MOTIVO_PERDA
ORDER BY DS_MOTIVO_PERDA

SELECT COUNT(CPD_CADERN_HIST_STATUS.NR_CADERN) AS TotalPerdas
FROM CPD_CADERN_HIST_STATUS INNER JOIN
	 CPD_CADERN ON CPD_CADERN_HIST_STATUS.NR_CADERN = CPD_CADERN.NR_CADERN INNER JOIN
     CPD_MOTIVO_PERDA ON CPD_CADERN_HIST_STATUS.CD_MOTIVO_PERDA = CPD_MOTIVO_PERDA.CD_MOTIVO_PERDA
WHERE CPD_CADERN_HIST_STATUS.CD_CADERN_STATUS = 10 AND CPD_CADERN.TX_OP = @CODIGO

SELECT COUNT(CPD_CADERN.NR_CADERN) AS TotalOP
FROM  CPD_CADERN 
WHERE CPD_CADERN.TX_OP = @CODIGO
GO
/****** Object:  StoredProcedure [scpd].[SP_CPD_REL_ACUMULADOS_MES]    Script Date: 06/29/2010 16:19:22 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [scpd].[SP_CPD_REL_ACUMULADOS_MES]
	@MES [numeric](2, 0),
	@ANO [numeric](4, 0)
WITH EXECUTE AS CALLER
AS
SELECT Periodo, ISNULL(QtdPassSolicitados,0) AS QtdPassSolicitados, ISNULL(QtdPassProduzidos,0) AS QtdPassProduzidos,
	      ISNULL(QtdPassPerdidos,0) AS QtdPassPerdidos, PeriodoOrdena
   FROM (SELECT LEFT(CONVERT(varchar(20), DT_HIST, 103), 5) as Periodo, 
			   COUNT(distinct NR_PROTC) as QtdPassSolicitados,			   
			   NULL AS QtdPassProduzidos, 
			   NULL AS QtdPassPerdidos,
			   CAST(YEAR(DT_HIST) as varchar) + REPLICATE('0', 2 - LEN(MONTH(DT_HIST))) + CAST(MONTH(DT_HIST) as varchar) + REPLICATE('0', 2 - LEN(DAY(DT_HIST))) + CAST(DAY(DT_HIST) as varchar) as PeriodoOrdena
		FROM
			(SELECT NR_PROTC, 
					MIN(DT_HIST) as DT_HIST
			 FROM CPD_SOLIC_HIST_STATUS
			 WHERE CD_STATUS_SOLIC = 10
			   AND CD_USUAR IS NULL
			 GROUP BY NR_PROTC
			) TabelaSolicitados
		WHERE MONTH(DT_HIST) = @MES AND YEAR(DT_HIST) = @ANO    
		GROUP BY CONVERT(varchar(20), DT_HIST, 103), YEAR(DT_HIST), MONTH(DT_HIST), DAY(DT_HIST)

	   /**********************************************************************************/
	   UNION
	   /**********************************************************************************/

		SELECT LEFT(CONVERT(varchar(20), DT_HIST, 103), 5) as Periodo, 
			   NULL as QtdPassSolicitados,			   
			   COUNT(distinct NR_PROTC) AS QtdPassProduzidos, 
			   NULL AS QtdPassPerdidos,
			   CAST(YEAR(DT_HIST) as varchar) + REPLICATE('0', 2 - LEN(MONTH(DT_HIST))) + CAST(MONTH(DT_HIST) as varchar) + REPLICATE('0', 2 - LEN(DAY(DT_HIST))) + CAST(DAY(DT_HIST) as varchar) as PeriodoOrdena
		FROM
			(SELECT NR_PROTC, 
					MAX(DT_HIST) as DT_HIST
			 FROM CPD_SOLIC_HIST_STATUS
					INNER JOIN CPD_CADERN ON CPD_SOLIC_HIST_STATUS.NR_CADERN = CPD_CADERN.NR_CADERN
			 WHERE CD_STATUS_SOLIC = 50 --Pronto-Remessa
				   AND NOT CD_CADERN_STATUS = 10 -- Caderneta Perdida
			 GROUP BY NR_PROTC
			) TabelaProduzidos
		WHERE MONTH(DT_HIST) = @MES AND YEAR(DT_HIST) = @ANO       
		GROUP BY CONVERT(varchar(20), DT_HIST, 103), YEAR(DT_HIST), MONTH(DT_HIST), DAY(DT_HIST)
                      
	   /**********************************************************************************/
	   UNION
	   /**********************************************************************************/

		SELECT LEFT(CONVERT(varchar(20), DT_HIST, 103), 5) as Periodo, 
			   NULL as QtdPassSolicitados,			   
			   NULL AS QtdPassProduzidos, 
			   COUNT(distinct NR_CADERN)  AS QtdPassPerdidos,
			   CAST(YEAR(DT_HIST) as varchar) + REPLICATE('0', 2 - LEN(MONTH(DT_HIST))) + CAST(MONTH(DT_HIST) as varchar) + REPLICATE('0', 2 - LEN(DAY(DT_HIST))) + CAST(DAY(DT_HIST) as varchar) as PeriodoOrdena
		FROM
			(SELECT NR_CADERN, 
					MIN(DT_ALTERA) as DT_HIST
			 FROM CPD_CADERN_HIST_STATUS
			 WHERE CD_CADERN_STATUS = 10 --Perdida
			 GROUP BY NR_CADERN
			) TabelaPerdidos
		WHERE MONTH(DT_HIST) = @MES AND YEAR(DT_HIST) = @ANO       
		GROUP BY CONVERT(varchar(20), DT_HIST, 103), YEAR(DT_HIST), MONTH(DT_HIST), DAY(DT_HIST)
        ) TABELA
    ORDER BY PeriodoOrdena
GO
/****** Object:  StoredProcedure [scpd].[SP_CPD_REL_QTD_PASSAP_PRODUZ_Diario]    Script Date: 06/29/2010 16:19:23 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [scpd].[SP_CPD_REL_QTD_PASSAP_PRODUZ_Diario]
	@DE [datetime],
	@ATE [datetime]
WITH EXECUTE AS CALLER
AS
SELECT Periodo, ISNULL(QtdPassSolicitados,0) AS QtdPassSolicitados, ISNULL(QtdPassProduzidos,0) AS QtdPassProduzidos,
	      ISNULL(QtdPassPerdidos,0) AS QtdPassPerdidos, PeriodoOrdena
   FROM(SELECT REPLICATE('0', 2 - LEN(DAY(DT_HIST))) + CAST(DAY(DT_HIST) as varchar) + '/' + REPLICATE('0', 2 - LEN(MONTH(DT_HIST))) + CAST(MONTH(DT_HIST) as varchar) as Periodo, 
			   COUNT(distinct NR_PROTC) as QtdPassSolicitados,			   
			   NULL AS QtdPassProduzidos, 
			   NULL AS QtdPassPerdidos,
			   CAST(YEAR(DT_HIST) as varchar) + REPLICATE('0', 2 - LEN(MONTH(DT_HIST))) + CAST(MONTH(DT_HIST) as varchar) + REPLICATE('0', 2 - LEN(DAY(DT_HIST))) + CAST(DAY(DT_HIST) as varchar) as PeriodoOrdena
		FROM
			(SELECT NR_PROTC, 
					MIN(DT_HIST) as DT_HIST
			 FROM CPD_SOLIC_HIST_STATUS
			 WHERE CD_STATUS_SOLIC = 10
			   AND CD_USUAR IS NULL
			 GROUP BY NR_PROTC
			) TabelaSolicitados
		WHERE CONVERT(varchar(8), DT_HIST, 112) >= CONVERT(varchar(8), @DE, 112)
			  AND CONVERT(varchar(8), DT_HIST, 112) <= CONVERT(varchar(8), @ATE, 112)    
		GROUP BY YEAR(DT_HIST), MONTH(DT_HIST), DAY(DT_HIST) 

	   /**********************************************************************************/
	   UNION
	   /**********************************************************************************/

		SELECT REPLICATE('0', 2 - LEN(DAY(DT_HIST))) + CAST(DAY(DT_HIST) as varchar) + '/' + REPLICATE('0', 2 - LEN(MONTH(DT_HIST))) + CAST(MONTH(DT_HIST) as varchar) as Periodo, 
			   NULL as QtdPassSolicitados,			   
			   COUNT(distinct NR_PROTC) AS QtdPassProduzidos, 
			   NULL AS QtdPassPerdidos,
			   CAST(YEAR(DT_HIST) as varchar) + REPLICATE('0', 2 - LEN(MONTH(DT_HIST))) + CAST(MONTH(DT_HIST) as varchar) + REPLICATE('0', 2 - LEN(DAY(DT_HIST))) + CAST(DAY(DT_HIST) as varchar) as PeriodoOrdena
		FROM
			(SELECT NR_PROTC, 
					MAX(DT_HIST) as DT_HIST
			 FROM CPD_SOLIC_HIST_STATUS
					INNER JOIN CPD_CADERN ON CPD_SOLIC_HIST_STATUS.NR_CADERN = CPD_CADERN.NR_CADERN
			 WHERE CD_STATUS_SOLIC = 50 --Pronto-Remessa
				   AND NOT CD_CADERN_STATUS = 10 -- Caderneta Perdida
			 GROUP BY NR_PROTC
			) TabelaProduzidos
		WHERE CONVERT(varchar(8), DT_HIST, 112) >= CONVERT(varchar(8), @DE, 112)
			  AND CONVERT(varchar(8), DT_HIST, 112) <= CONVERT(varchar(8), @ATE, 112)   
		GROUP BY YEAR(DT_HIST), MONTH(DT_HIST), DAY(DT_HIST)
                      
	   /**********************************************************************************/
	   UNION
	   /**********************************************************************************/

		SELECT REPLICATE('0', 2 - LEN(DAY(DT_HIST))) + CAST(DAY(DT_HIST) as varchar) + '/' + REPLICATE('0', 2 - LEN(MONTH(DT_HIST))) + CAST(MONTH(DT_HIST) as varchar) as Periodo, 
			   NULL as QtdPassSolicitados,			   
			   NULL AS QtdPassProduzidos, 
			   COUNT(distinct NR_CADERN)  AS QtdPassPerdidos,
			   CAST(YEAR(DT_HIST) as varchar) + REPLICATE('0', 2 - LEN(MONTH(DT_HIST))) + CAST(MONTH(DT_HIST) as varchar) + REPLICATE('0', 2 - LEN(DAY(DT_HIST))) + CAST(DAY(DT_HIST) as varchar) as PeriodoOrdena
		FROM
			(SELECT NR_CADERN, 
					MIN(DT_ALTERA) as DT_HIST
			 FROM CPD_CADERN_HIST_STATUS
			 WHERE CD_CADERN_STATUS = 10 --Perdida
			 GROUP BY NR_CADERN
			) TabelaPerdidos
		WHERE CONVERT(varchar(8), DT_HIST, 112) >= CONVERT(varchar(8), @DE, 112)
			  AND CONVERT(varchar(8), DT_HIST, 112) <= CONVERT(varchar(8), @ATE, 112)   
		GROUP BY YEAR(DT_HIST), MONTH(DT_HIST), DAY(DT_HIST)
        ) TABELA
    ORDER BY PeriodoOrdena
GO
/****** Object:  StoredProcedure [scpd].[SP_CPD_QTD_SOLIC_STATUS]    Script Date: 06/29/2010 16:19:22 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [scpd].[SP_CPD_QTD_SOLIC_STATUS]
	@STATUS [int]
WITH EXECUTE AS CALLER
AS
SELECT COUNT(CPD_SOLIC.NR_PROTC) QTD_PROTC, 
       CPD_STATUS_SOLIC.DS_STATUS_SOLIC, 
       CPD_STATUS_SOLIC.CD_STATUS_SOLIC     
FROM CPD_SOLIC                        
		INNER JOIN CPD_STATUS_SOLIC ON CPD_SOLIC.CD_STATUS_SOLIC = CPD_STATUS_SOLIC.CD_STATUS_SOLIC
WHERE  (CPD_SOLIC.CD_STATUS_SOLIC = @STATUS OR @STATUS = 0)
GROUP BY CPD_STATUS_SOLIC.DS_STATUS_SOLIC,
      CPD_STATUS_SOLIC.CD_STATUS_SOLIC
ORDER BY CPD_STATUS_SOLIC.CD_STATUS_SOLIC
GO
/****** Object:  StoredProcedure [scpd].[SP_CPD_SELEC_PARAM]    Script Date: 06/29/2010 16:19:23 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [scpd].[SP_CPD_SELEC_PARAM]
	@CD_PARAM [int]
WITH EXECUTE AS CALLER
AS
SELECT CD_PARAM, DS_PARAM, VL_PARAM, CD_USUAR, CD_ESTAC, DT_ALTER
FROM CPD_PARAM
WHERE CD_PARAM = @CD_PARAM
GO
/****** Object:  StoredProcedure [scpd].[SP_CPD_LISTA_PARAM]    Script Date: 06/29/2010 16:19:22 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [scpd].[SP_CPD_LISTA_PARAM]
WITH EXECUTE AS CALLER
AS
select	PARAM.CD_PARAM,
		PARAM.DS_PARAM, 
		PARAM.VL_PARAM,
		PARAM.CD_USUAR,
		PARAM.CD_ESTAC,
		PARAM.DT_ALTER,
		USUARIO.NM_USUAR
FROM CPD_PARAM PARAM
		LEFT JOIN CPD_USUAR USUARIO
			ON PARAM.CD_USUAR = USUARIO.CD_USUAR
ORDER BY PARAM.DS_PARAM
GO
/****** Object:  StoredProcedure [scpd].[SP_CPD_REL_SALDO_ANTERIOR]    Script Date: 06/29/2010 16:19:23 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [scpd].[SP_CPD_REL_SALDO_ANTERIOR]
	@MES [numeric](2, 0),
	@ANO [numeric](4, 0)
WITH EXECUTE AS CALLER
AS
SELECT sum(ISNULL(QtdPassSolicitados,0)) - sum(ISNULL(QtdPassProduzidos,0)) AS SaldoAnterior
   FROM (SELECT COUNT(distinct NR_PROTC) as QtdPassSolicitados,			   
			    NULL AS QtdPassProduzidos
 		 FROM
			(SELECT NR_PROTC, 
					MIN(DT_HIST) as DT_HIST
			 FROM CPD_SOLIC_HIST_STATUS
			 WHERE CD_STATUS_SOLIC = 10
			   AND CD_USUAR IS NULL
			 GROUP BY NR_PROTC
			) TabelaSolicitados
		WHERE DT_HIST < ('01/' + cast(@MES as varchar(2)) + '/' + cast(@ANO as varchar(4)))
	   /**********************************************************************************/
	   UNION
	   /**********************************************************************************/

		SELECT NULL as QtdPassSolicitados,			   
			   COUNT(distinct NR_PROTC) AS QtdPassProduzidos
		FROM
			(SELECT NR_PROTC, 
					MAX(DT_HIST) as DT_HIST
			 FROM CPD_SOLIC_HIST_STATUS
					INNER JOIN CPD_CADERN ON CPD_SOLIC_HIST_STATUS.NR_CADERN = CPD_CADERN.NR_CADERN
			 WHERE CD_STATUS_SOLIC = 50 --Pronto-Remessa
				   AND NOT CD_CADERN_STATUS = 10 -- Caderneta Perdida
			 GROUP BY NR_PROTC
			) TabelaProduzidos
		WHERE DT_HIST < ('01/' + cast(@MES as varchar(2)) + '/' + cast(@ANO as varchar(4)))
        ) TABELA
GO
/****** Object:  StoredProcedure [scpd].[SP_CPD_ALTER_DT_VEICUL]    Script Date: 06/29/2010 16:19:19 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [scpd].[SP_CPD_ALTER_DT_VEICUL]
	@CD_VEICUL [int]
WITH EXECUTE AS CALLER
AS
UPDATE CPD_VEICUL
SET DT_IMPRES = GETDATE()
WHERE CD_VEICUL = @CD_VEICUL AND
      DT_IMPRES IS NULL
GO
/****** Object:  StoredProcedure [scpd].[SP_CPD_ALTER_ULT_AR]    Script Date: 06/29/2010 16:19:20 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [scpd].[SP_CPD_ALTER_ULT_AR]
	@NR_INICIO_SEQ_AR [numeric](10, 0),
	@NR_FIM_SEQ_AR [numeric](10, 0),
	@SG_AR [char](2),
	@NR_ULT_AR_UTILIZ [numeric](10, 0),
	@CD_USUAR [int],
	@CD_ESTAC [int]
WITH EXECUTE AS CALLER
AS
UPDATE CPD_AR
SET NR_ULT_AR_UTILIZ = @NR_ULT_AR_UTILIZ,
	CD_USUAR = @CD_USUAR,
	CD_ESTAC = @CD_ESTAC
WHERE NR_INICIO_SEQ_AR = @NR_INICIO_SEQ_AR AND
	  NR_FIM_SEQ_AR = @NR_FIM_SEQ_AR AND
	  SG_AR = @SG_AR
GO
/****** Object:  StoredProcedure [scpd].[SP_CPD_SELEC_PROX_AR]    Script Date: 06/29/2010 16:19:23 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [scpd].[SP_CPD_SELEC_PROX_AR]
	@CD_TP_AR [tinyint]
WITH EXECUTE AS CALLER
AS
SELECT TOP 1 NR_INICIO_SEQ_AR, NR_FIM_SEQ_AR, SG_AR, 
		     ISNULL(NR_ULT_AR_UTILIZ + 1, NR_INICIO_SEQ_AR) NR_PROX_AR
FROM CPD_AR WITH (XLOCK, ROWLOCK)
WHERE QT_AR_SEQ > 0 AND
	  CD_TP_AR = @CD_TP_AR
ORDER BY NR_ULT_AR_UTILIZ DESC, SG_AR, NR_INICIO_SEQ_AR
GO
/****** Object:  StoredProcedure [scpd].[SP_CPD_VALID_RANGE_AR]    Script Date: 06/29/2010 16:19:23 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [scpd].[SP_CPD_VALID_RANGE_AR]
	@NR_INICIO_SEQ_AR [numeric](8, 0),
	@NR_FIM_SEQ_AR [numeric](8, 0),
	@NR_INICIO_SEQ_AR_ANTIGO [numeric](8, 0) = null,
	@NR_FIM_SEQ_AR_ANTIGO [numeric](8, 0) = null,
	@SG_AR [char](2),
	@SG_AR_ANTIGO [char](2) = null
WITH EXECUTE AS CALLER
AS
SELECT COUNT(1) AS QTD FROM CPD_AR
WHERE 
((@NR_INICIO_SEQ_AR >= NR_INICIO_SEQ_AR AND @NR_INICIO_SEQ_AR <= NR_FIM_SEQ_AR)
OR
(@NR_FIM_SEQ_AR >= NR_INICIO_SEQ_AR AND @NR_FIM_SEQ_AR <= NR_FIM_SEQ_AR)
OR
(NR_INICIO_SEQ_AR >= @NR_INICIO_SEQ_AR AND NR_INICIO_SEQ_AR <= @NR_FIM_SEQ_AR)
OR
(NR_FIM_SEQ_AR >= @NR_INICIO_SEQ_AR AND NR_FIM_SEQ_AR <= @NR_FIM_SEQ_AR))
AND
SG_AR = @SG_AR
AND NOT (SG_AR = @SG_AR_ANTIGO AND NR_FIM_SEQ_AR = @NR_FIM_SEQ_AR_ANTIGO AND NR_INICIO_SEQ_AR = @NR_INICIO_SEQ_AR_ANTIGO)
GO
/****** Object:  StoredProcedure [scpd].[SP_CPD_VALID_ULTM_AR_UTILZ]    Script Date: 06/29/2010 16:19:23 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [scpd].[SP_CPD_VALID_ULTM_AR_UTILZ]
	@NR_INICIO_SEQ_AR [numeric](8, 0),
	@NR_FIM_SEQ_AR [numeric](8, 0),
	@SG_AR [char](2)
WITH EXECUTE AS CALLER
AS
SELECT NR_ULT_AR_UTILIZ FROM CPD_AR
WHERE (NR_INICIO_SEQ_AR = @NR_INICIO_SEQ_AR)
AND (NR_FIM_SEQ_AR = @NR_FIM_SEQ_AR)
AND SG_AR = @SG_AR
GO
/****** Object:  StoredProcedure [scpd].[SP_CPD_ALTER_AR]    Script Date: 06/29/2010 16:19:19 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [scpd].[SP_CPD_ALTER_AR]
	@NR_INICIO_SEQ_AR_ANTIGO [numeric](8, 0),
	@NR_FIM_SEQ_AR_ANTIGO [numeric](8, 0),
	@SG_AR_ANTIGO [char](2),
	@NR_INICIO_SEQ_AR [numeric](8, 0),
	@NR_FIM_SEQ_AR [numeric](8, 0),
	@CD_USUAR [int],
	@CD_ESTAC [int],
	@SG_AR [char](2),
	@CD_TP_AR [tinyint]
WITH EXECUTE AS CALLER
AS
UPDATE CPD_AR
SET
	NR_INICIO_SEQ_AR	=	@NR_INICIO_SEQ_AR,	
	NR_FIM_SEQ_AR		=	@NR_FIM_SEQ_AR,
	CD_USUAR			=	@CD_USUAR,		
	CD_ESTAC			=	@CD_ESTAC,
	SG_AR				=	@SG_AR,
	CD_TP_AR            =   @CD_TP_AR
WHERE 	NR_INICIO_SEQ_AR = @NR_INICIO_SEQ_AR_ANTIGO 
AND		NR_FIM_SEQ_AR    = @NR_FIM_SEQ_AR_ANTIGO
AND     SG_AR            = @SG_AR_ANTIGO
GO
/****** Object:  StoredProcedure [scpd].[SP_CPD_LISTA_SEQ_AR]    Script Date: 06/29/2010 16:19:22 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [scpd].[SP_CPD_LISTA_SEQ_AR]
	@CD_TP_AR [tinyint]
WITH EXECUTE AS CALLER
AS
SELECT	SG_AR + right('00000000' + CAST(NR_INICIO_SEQ_AR AS varchar(8)),8) + 'BR' AS NR_INICIO_SEQ_AR,
		SG_AR + right('00000000' + CAST(NR_FIM_SEQ_AR AS varchar(8)),8) + 'BR' AS NR_FIM_SEQ_AR,
		SG_AR + right('00000000' + CAST(NR_ULT_AR_UTILIZ AS varchar(8)),8) + 'BR' AS NR_ULT_AR_UTILIZ,
		QT_AR_SEQ,
		CD_USUAR,
		CD_ESTAC,
		CD_TP_AR
FROM	CPD_AR
WHERE CD_TP_AR = @CD_TP_AR
ORDER BY SG_AR, NR_INICIO_SEQ_AR
GO
/****** Object:  StoredProcedure [scpd].[SP_CPD_REL_PROD_CADERN_USUAR]    Script Date: 06/29/2010 16:19:23 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [scpd].[SP_CPD_REL_PROD_CADERN_USUAR]
	@DE [datetime],
	@ATE [datetime],
	@CD_USUAR [int]
WITH EXECUTE AS CALLER
AS
SELECT 
	CD_PRODT, DT_PRODT, CPD_PRODT.CD_USUAR, QT_CADERN, (CAST(DT_TEMPO AS DECIMAL(16,2)) / 1000) TEMPO_TOTAL,
	NM_USUAR
FROM
	CPD_PRODT 
       	INNER JOIN CPD_USUAR ON CPD_PRODT.CD_USUAR = CPD_USUAR.CD_USUAR
WHERE
	CONVERT(varchar(8),DT_PRODT, 112) >= CONVERT(varchar(8), @DE, 112) AND
    CONVERT(varchar(8),DT_PRODT, 112) <= CONVERT(varchar(8), @ATE, 112)	AND
	(CPD_PRODT.CD_USUAR = @CD_USUAR OR @CD_USUAR = 0)
	
ORDER BY NM_USUAR, DT_PRODT
GO
/****** Object:  StoredProcedure [dbo].[SP_GetErrorInfo]    Script Date: 06/29/2010 16:19:19 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[SP_GetErrorInfo]
WITH EXECUTE AS CALLER
AS
INSERT INTO CPD_INFORM_ERRO (NR_ERRO, NR_SEVERI_ERRO, NR_EST_ERROR, NM_PROCED_ERRO, NR_LINHA_ERRO, DS_MSG_ERRO)
VALUES (ERROR_NUMBER(), ERROR_SEVERITY(), ERROR_STATE(), ERROR_PROCEDURE(), ERROR_LINE(), ERROR_MESSAGE());
GO
/****** Object:  StoredProcedure [scpd].[SP_CPD_CADERN_LIBER_DT_OPERAD]    Script Date: 06/29/2010 16:19:20 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [scpd].[SP_CPD_CADERN_LIBER_DT_OPERAD]
	@DE [datetime],
	@ATE [datetime],
	@CD_USUAR [int]
WITH EXECUTE AS CALLER
AS
SELECT
	NR_CADERN
FROM
	 CPD_CADERN	  
WHERE
	CONVERT(varchar(8),DT_LIBER, 112) >= CONVERT(varchar(8), @DE, 112) AND
    CONVERT(varchar(8),DT_LIBER, 112) <= CONVERT(varchar(8), @ATE, 112)	AND
	(CD_USUAR_RETIR_CADERN = @CD_USUAR)
ORDER BY SQ_CADERN
GO
/****** Object:  StoredProcedure [scpd].[SP_CPD_CARREGA_PROX_CADERN]    Script Date: 06/29/2010 16:19:20 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [scpd].[SP_CPD_CARREGA_PROX_CADERN]
WITH EXECUTE AS CALLER
AS
SELECT NR_CADERN 
FROM CPD_CADERN 
WHERE SQ_CADERN = (SELECT MAX(SQ_CADERN) FROM CPD_CADERN)
GO
/****** Object:  StoredProcedure [scpd].[SP_CPD_INS_LOG_ARQ]    Script Date: 06/29/2010 16:19:20 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [scpd].[SP_CPD_INS_LOG_ARQ]
	@DS_ERRO_ARQ [varchar](500),
	@CD_ARQ [int]
WITH EXECUTE AS CALLER
AS
INSERT INTO CPD_LOG_ARQ(DS_ERRO_ARQ, CD_ARQ)
  VALUES (@DS_ERRO_ARQ, @CD_ARQ)
GO
/****** Object:  StoredProcedure [scpd].[SP_CPD_CADERN_LIBER_OPERAD]    Script Date: 06/29/2010 16:19:20 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [scpd].[SP_CPD_CADERN_LIBER_OPERAD]
	@NR_CADERN [char](8)
WITH EXECUTE AS CALLER
AS
SELECT CPD_CADERN.NR_CADERN, CPD_USUAR.CD_USUAR, CPD_USUAR.NM_USUAR
FROM CPD_CADERN 
		INNER JOIN CPD_USUAR ON CPD_CADERN.CD_USUAR_RETIR_CADERN = CPD_USUAR.CD_USUAR
WHERE CPD_CADERN.NR_CADERN = @NR_CADERN AND
	  CPD_CADERN.DT_LIBER IS NOT NULL
GO
/****** Object:  StoredProcedure [scpd].[SP_CPD_LISTA_EXCEC_SYS]    Script Date: 06/29/2010 16:19:21 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [scpd].[SP_CPD_LISTA_EXCEC_SYS]
	@DT_INICIO [varchar](10),
	@DT_FIM [varchar](10),
	@CD_USUAR [int] = NULL
WITH EXECUTE AS CALLER
AS
SELECT
	E.CD_EXCECAO,	
	E.CD_USUAR,
	U.DS_LOGIN,
	U.NM_USUAR,
	E.DS_EXCECAO,
	E.DT_CAD_OCOR,
	E.DT_OCOR,
	CONVERT(VARCHAR(10), E.DT_OCOR, 103) AS DATA_OCORRENCIA,
	CONVERT(VARCHAR(10), E.DT_CAD_OCOR, 103) AS DATA_CAD_OCORRENCIA
FROM


CPD_EXCEC_SYS E
	INNER JOIN CPD_USUAR U ON E.CD_USUAR = U.CD_USUAR
WHERE E.DT_OCOR BETWEEN CONVERT(Datetime, @DT_INICIO, 103) AND CONVERT(Datetime, @DT_FIM, 103) AND
      (@CD_USUAR IS NULL OR E.CD_USUAR = @CD_USUAR)
ORDER BY E.DT_OCOR
GO
/****** Object:  StoredProcedure [scpd].[SP_CPD_VALID_OP]    Script Date: 06/29/2010 16:19:23 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [scpd].[SP_CPD_VALID_OP]
	@TX_OP [varchar](40)
WITH EXECUTE AS CALLER
AS
SELECT TX_OP, IN_STATUS 
FROM CPD_OP
WHERE TX_OP = @TX_OP
GO
/****** Object:  StoredProcedure [scpd].[SP_CPD_REL_LISTA_POSTG]    Script Date: 06/29/2010 16:19:22 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [scpd].[SP_CPD_REL_LISTA_POSTG]
	@CD_VEICULO [int]
WITH EXECUTE AS CALLER
AS
DECLARE @vlr_caderneta     decimal(18,2),
		@PesoCaderneta	   decimal(18,3)

   set @vlr_caderneta = ( Select cast( VL_PARAM as decimal(18,2) )
                            From CPD_PARAM
                           Where cd_param = 4 )

	-- Peso da caderneta
	set @PesoCaderneta = ( Select cast( VL_PARAM as decimal(18,3) )
                            From CPD_PARAM
                           Where cd_param = 8 )


Select distinct
	  CPD_UNID_ENTRG.CD_UNID,
      CPD_VEICUL.DT_IMPRES AS DiaMes,
      CPD_EMBALA.NR_AR as NumeroObjeto,
      '50604066' as CodigoUnidade,
	  '0055732801' as CartaoPostagem,
	  '7153759' as CodigoAdministrativo,
	  '9912178179' as NumeroContrato,
	  '40436' as CodigoServico,
      CPD_UNID_ENTRG.NR_CEP as CEPDestino,
	  (count(1) * @vlr_caderneta) as ValorDeclarado,
      (COUNT(1) * @PesoCaderneta) + CPD_TP_EMBALA.NR_PESO as Peso,
	  SCPD.FN_CALC_VALOR_SEDEX((COUNT(1) * @PesoCaderneta) + CPD_TP_EMBALA.NR_PESO,
								CPD_UNID_ENTRG.CD_MUN,
								CPD_TP_EMBALA.VL_EMBALA,
								COUNT(1),
								@vlr_caderneta) AS ValorEmbalagem
from 
      CPD_VEICUL
		inner join CPD_EMBALA on CPD_EMBALA.CD_VEICUL = CPD_VEICUL.CD_VEICUL
		inner join CPD_TP_EMBALA on CPD_TP_EMBALA.CD_TP_EMBALA = CPD_EMBALA.CD_TP_EMBALA
		inner join CPD_CADERN on CPD_EMBALA.CD_EMBALA = CPD_CADERN.CD_EMBALA
		inner join CPD_SOLIC  on CPD_SOLIC.NR_CADERN = CPD_CADERN.NR_CADERN
		inner join CPD_UNID_ENTRG on CPD_UNID_ENTRG.CD_UNID = CPD_SOLIC.CD_UNID

WHERE 
        CPD_VEICUL.CD_VEICUL = @CD_VEICULO   
GROUP BY
	  CPD_UNID_ENTRG.CD_UNID,
	  CPD_VEICUL.DT_IMPRES,
      CPD_EMBALA.NR_AR,
      CPD_TP_EMBALA.NR_PESO,
      CPD_TP_EMBALA.VL_EMBALA,
      CPD_UNID_ENTRG.DS_UNID,
      CPD_UNID_ENTRG.NR_CEP,
	  CPD_UNID_ENTRG.CD_MUN   
ORDER BY
	CPD_EMBALA.NR_AR
GO
/****** Object:  StoredProcedure [scpd].[SP_CPD_QT_CADERN_OP]    Script Date: 06/29/2010 16:19:22 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [scpd].[SP_CPD_QT_CADERN_OP]
	@tx_op [varchar](40)
WITH EXECUTE AS CALLER
AS
SELECT SCPD.FN_CPD_QT_CADERN_OP(@tx_op) AS QT_CADERN_ESTOQ_CPDOC_OP
GO
/****** Object:  StoredProcedure [scpd].[SP_CPD_CARREG_OP]    Script Date: 06/29/2010 16:19:20 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [scpd].[SP_CPD_CARREG_OP]
WITH EXECUTE AS CALLER
AS
EXEC SP_CPD_ATUAL_OP

SELECT TOP 1 TX_OP, SCPD.FN_CPD_QT_CADERN_OP(CPD_OP.TX_OP) AS QT_CADERN_ESTOQ_CPDOC_OP
FROM CPD_OP 
WHERE IN_STATUS = 1 AND
	  SCPD.FN_CPD_QT_CADERN_OP(CPD_OP.TX_OP) > 0
ORDER BY DT_CAD_OP
GO
/****** Object:  StoredProcedure [scpd].[SP_CPD_ATUAL_INSUMO]    Script Date: 06/29/2010 16:19:20 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [scpd].[SP_CPD_ATUAL_INSUMO]
	@TX_OP [varchar](40)
WITH EXECUTE AS CALLER
AS
EXEC SP_CPD_ATUAL_OP
EXEC SP_CPD_LISTA_ESTOQU_GERAL @TX_OP
GO
/****** Object:  StoredProcedure [scpd].[SP_CPD_LISTA_USUAR_LOTE]    Script Date: 06/29/2010 16:19:22 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [scpd].[SP_CPD_LISTA_USUAR_LOTE]
WITH EXECUTE AS CALLER
AS
EXEC [SP_CPD_QT_LOTE]
EXEC [SP_CPD_LISTA_QT_SOLIC_USUAR]
Select Count(1) as QD_FALTA_IMPRIMIR from CPD_SOLIC where CD_STATUS_SOLIC = 10
Select Count(1) as QD_FALTA_IMPRIMIR from CPD_SOLIC where CD_STATUS_SOLIC = 20
GO
